function mountain_js_context_available(id,driverInfo){var ctx=away.stagegl.ContextStage3D.contexts[id];if(ctx._iCallback){ctx._iDriverInfo=driverInfo;var timeOutId=window.setTimeout(function(){window.clearTimeout(timeOutId);try{ctx._iCallback(ctx)}catch(e){console.log("Callback failed during flash initialization with '"+e.toString()+"'")}},1)}}var aglsl;!function(aglsl){var Sampler=function(){function Sampler(){this.lodbias=0,this.dim=0,this.readmode=0,this.special=0,this.wrap=0,this.mipmap=0,this.filter=0}return Sampler}();aglsl.Sampler=Sampler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Token=function(){function Token(){this.dest=new aglsl.Destination,this.opcode=0,this.a=new aglsl.Destination,this.b=new aglsl.Destination}return Token}();aglsl.Token=Token}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Header=function(){function Header(){this.progid=0,this.version=0,this.type=""}return Header}();aglsl.Header=Header}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var OpLUT=function(){function OpLUT(s,flags,dest,a,b,matrixwidth,matrixheight,ndwm,scaler,dm,lod){this.s=s,this.flags=flags,this.dest=dest,this.a=a,this.b=b,this.matrixwidth=matrixwidth,this.matrixheight=matrixheight,this.ndwm=ndwm,this.scalar=scaler,this.dm=dm,this.lod=lod}return OpLUT}();aglsl.OpLUT=OpLUT}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Description=function(){function Description(){this.regread=[[],[],[],[],[],[],[]],this.regwrite=[[],[],[],[],[],[],[]],this.hasindirect=!1,this.writedepth=!1,this.hasmatrix=!1,this.samplers=[],this.tokens=[],this.header=new aglsl.Header}return Description}();aglsl.Description=Description}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Destination=function(){function Destination(){this.mask=0,this.regnum=0,this.regtype=0,this.dim=0}return Destination}();aglsl.Destination=Destination}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Mapping=function(){function Mapping(){}return Mapping.agal2glsllut=[new aglsl.OpLUT("%dest = %cast(%a);\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a + %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a - %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a * %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a / %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(1.0) / %a;\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(min(%a,%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(max(%a,%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(fract(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(sqrt(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(inversesqrt(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(pow(abs(%a),%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(log2(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(exp2(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(normalize(vec3( %a ) ));\n",0,!0,!0,!1,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(sin(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(cos(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(cross(vec3(%a),vec3(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(abs(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a * -1.0);\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(clamp(%a,0.0,1.0));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",null,!0,!0,!0,3,3,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,!0,!0,!0,4,4,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,!0,!0,!0,4,3,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dFdx(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(dFdx(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("if (float(%a)==float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("if (float(%a)!=float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("if (float(%a)>=float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("if (float(%a)<float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("} else {;\n",0,!1,!1,!1,null,null,null,null,null,null),new aglsl.OpLUT("};\n",0,!1,!1,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(texture%texdimLod(%b,%texsize(%a)).%dm);\n",null,!0,!0,!0,null,null,null,null,!0,null),new aglsl.OpLUT("if ( float(%a)<0.0 ) discard;\n",null,!1,!0,!1,null,null,null,!0,null,null),new aglsl.OpLUT("%dest = %cast(texture%texdim(%b,%texsize(%a)%lod).%dm);\n",null,!0,!0,!0,null,null,!0,null,!0,!0),new aglsl.OpLUT("%dest = %cast(greaterThanEqual(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new aglsl.OpLUT("%dest = %cast(lessThan(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new aglsl.OpLUT("%dest = %cast(sign(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(equal(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new aglsl.OpLUT("%dest = %cast(notEqual(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null)],Mapping}();aglsl.Mapping=Mapping}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Opcode=function(){function Opcode(dest,aformat,asize,bformat,bsize,opcode,simple,horizontal,fragonly,matrix){this.a=new aglsl.assembler.FS,this.b=new aglsl.assembler.FS,this.flags=new aglsl.assembler.Flags,this.dest=dest,this.a.format=aformat,this.a.size=asize,this.b.format=bformat,this.b.size=bsize,this.opcode=opcode,this.flags.simple=simple,this.flags.horizontal=horizontal,this.flags.fragonly=fragonly,this.flags.matrix=matrix}return Opcode}();assembler.Opcode=Opcode;var FS=function(){function FS(){}return FS}();assembler.FS=FS;var Flags=function(){function Flags(){}return Flags}();assembler.Flags=Flags}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var OpcodeMap=function(){function OpcodeMap(){}return Object.defineProperty(OpcodeMap,"map",{get:function(){return OpcodeMap._map||(OpcodeMap._map=new Array,OpcodeMap._map.mov=new aglsl.assembler.Opcode("vector","vector",4,"none",0,0,!0,null,null,null),OpcodeMap._map.add=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,1,!0,null,null,null),OpcodeMap._map.sub=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,2,!0,null,null,null),OpcodeMap._map.mul=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,3,!0,null,null,null),OpcodeMap._map.div=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,4,!0,null,null,null),OpcodeMap._map.rcp=new aglsl.assembler.Opcode("vector","vector",4,"none",0,5,!0,null,null,null),OpcodeMap._map.min=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,6,!0,null,null,null),OpcodeMap._map.max=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,7,!0,null,null,null),OpcodeMap._map.frc=new aglsl.assembler.Opcode("vector","vector",4,"none",0,8,!0,null,null,null),OpcodeMap._map.sqt=new aglsl.assembler.Opcode("vector","vector",4,"none",0,9,!0,null,null,null),OpcodeMap._map.rsq=new aglsl.assembler.Opcode("vector","vector",4,"none",0,10,!0,null,null,null),OpcodeMap._map.pow=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,11,!0,null,null,null),OpcodeMap._map.log=new aglsl.assembler.Opcode("vector","vector",4,"none",0,12,!0,null,null,null),OpcodeMap._map.exp=new aglsl.assembler.Opcode("vector","vector",4,"none",0,13,!0,null,null,null),OpcodeMap._map.nrm=new aglsl.assembler.Opcode("vector","vector",4,"none",0,14,!0,null,null,null),OpcodeMap._map.sin=new aglsl.assembler.Opcode("vector","vector",4,"none",0,15,!0,null,null,null),OpcodeMap._map.cos=new aglsl.assembler.Opcode("vector","vector",4,"none",0,16,!0,null,null,null),OpcodeMap._map.crs=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,17,!0,!0,null,null),OpcodeMap._map.dp3=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,18,!0,!0,null,null),OpcodeMap._map.dp4=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,19,!0,!0,null,null),OpcodeMap._map.abs=new aglsl.assembler.Opcode("vector","vector",4,"none",0,20,!0,null,null,null),OpcodeMap._map.neg=new aglsl.assembler.Opcode("vector","vector",4,"none",0,21,!0,null,null,null),OpcodeMap._map.sat=new aglsl.assembler.Opcode("vector","vector",4,"none",0,22,!0,null,null,null),OpcodeMap._map.ted=new aglsl.assembler.Opcode("vector","vector",4,"sampler",1,38,!0,null,!0,null),OpcodeMap._map.kil=new aglsl.assembler.Opcode("none","scalar",1,"none",0,39,!0,null,!0,null),OpcodeMap._map.tex=new aglsl.assembler.Opcode("vector","vector",4,"sampler",1,40,!0,null,!0,null),OpcodeMap._map.m33=new aglsl.assembler.Opcode("vector","matrix",3,"vector",3,23,!0,null,null,!0),OpcodeMap._map.m44=new aglsl.assembler.Opcode("vector","matrix",4,"vector",4,24,!0,null,null,!0),OpcodeMap._map.m43=new aglsl.assembler.Opcode("vector","matrix",3,"vector",4,25,!0,null,null,!0),OpcodeMap._map.sge=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,41,!0,null,null,null),OpcodeMap._map.slt=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,42,!0,null,null,null),OpcodeMap._map.sgn=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,43,!0,null,null,null),OpcodeMap._map.seq=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,44,!0,null,null,null),OpcodeMap._map.sne=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,45,!0,null,null,null)),OpcodeMap._map},enumerable:!0,configurable:!0}),OpcodeMap}();assembler.OpcodeMap=OpcodeMap}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Part=function(){function Part(name,version){"undefined"==typeof name&&(name=null),"undefined"==typeof version&&(version=null),this.name="",this.version=0,this.name=name,this.version=version,this.data=new away.utils.ByteArray}return Part}();assembler.Part=Part}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Reg=function(){function Reg(code,desc){this.code=code,this.desc=desc}return Reg}();assembler.Reg=Reg;var RegMap=function(){function RegMap(){}return Object.defineProperty(RegMap,"map",{get:function(){return RegMap._map||(RegMap._map=new Array,RegMap._map.va=new aglsl.assembler.Reg(0,"vertex attribute"),RegMap._map.fc=new aglsl.assembler.Reg(1,"fragment constant"),RegMap._map.vc=new aglsl.assembler.Reg(1,"vertex constant"),RegMap._map.ft=new aglsl.assembler.Reg(2,"fragment temporary"),RegMap._map.vt=new aglsl.assembler.Reg(2,"vertex temporary"),RegMap._map.vo=new aglsl.assembler.Reg(3,"vertex output"),RegMap._map.op=new aglsl.assembler.Reg(3,"vertex output"),RegMap._map.fd=new aglsl.assembler.Reg(3,"fragment depth output"),RegMap._map.fo=new aglsl.assembler.Reg(3,"fragment output"),RegMap._map.oc=new aglsl.assembler.Reg(3,"fragment output"),RegMap._map.v=new aglsl.assembler.Reg(4,"varying"),RegMap._map.vi=new aglsl.assembler.Reg(4,"varying output"),RegMap._map.fi=new aglsl.assembler.Reg(4,"varying input"),RegMap._map.fs=new aglsl.assembler.Reg(5,"sampler")),RegMap._map},enumerable:!0,configurable:!0}),RegMap}();assembler.RegMap=RegMap}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Sampler=function(){function Sampler(shift,mask,value){this.shift=shift,this.mask=mask,this.value=value}return Sampler}();assembler.Sampler=Sampler;var SamplerMap=function(){function SamplerMap(){}return Object.defineProperty(SamplerMap,"map",{get:function(){return SamplerMap._map||(SamplerMap._map=new Array,SamplerMap._map.rgba=new aglsl.assembler.Sampler(8,15,0),SamplerMap._map.rg=new aglsl.assembler.Sampler(8,15,5),SamplerMap._map.r=new aglsl.assembler.Sampler(8,15,4),SamplerMap._map.compressed=new aglsl.assembler.Sampler(8,15,1),SamplerMap._map.compressed_alpha=new aglsl.assembler.Sampler(8,15,2),SamplerMap._map.dxt1=new aglsl.assembler.Sampler(8,15,1),SamplerMap._map.dxt5=new aglsl.assembler.Sampler(8,15,2),SamplerMap._map["2d"]=new aglsl.assembler.Sampler(12,15,0),SamplerMap._map.cube=new aglsl.assembler.Sampler(12,15,1),SamplerMap._map["3d"]=new aglsl.assembler.Sampler(12,15,2),SamplerMap._map.centroid=new aglsl.assembler.Sampler(16,1,1),SamplerMap._map.ignoresampler=new aglsl.assembler.Sampler(16,4,4),SamplerMap._map.clamp=new aglsl.assembler.Sampler(20,15,0),SamplerMap._map.repeat=new aglsl.assembler.Sampler(20,15,1),SamplerMap._map.wrap=new aglsl.assembler.Sampler(20,15,1),SamplerMap._map.nomip=new aglsl.assembler.Sampler(24,15,0),SamplerMap._map.mipnone=new aglsl.assembler.Sampler(24,15,0),SamplerMap._map.mipnearest=new aglsl.assembler.Sampler(24,15,1),SamplerMap._map.miplinear=new aglsl.assembler.Sampler(24,15,2),SamplerMap._map.nearest=new aglsl.assembler.Sampler(28,15,0),SamplerMap._map.linear=new aglsl.assembler.Sampler(28,15,1)),SamplerMap._map},enumerable:!0,configurable:!0}),SamplerMap}();assembler.SamplerMap=SamplerMap}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var AGALMiniAssembler=function(){function AGALMiniAssembler(){this.r={},this.cur=new aglsl.assembler.Part}return AGALMiniAssembler.prototype.assemble=function(source,ext_part,ext_version){"undefined"==typeof ext_part&&(ext_part=null),"undefined"==typeof ext_version&&(ext_version=null),ext_version||(ext_version=1),ext_part&&this.addHeader(ext_part,ext_version);var lines=source.replace(/[\f\n\r\v]+/g,"\n").split("\n");for(var i in lines)this.processLine(lines[i],i);return this.r},AGALMiniAssembler.prototype.processLine=function(line,linenr){var startcomment=line.search("//");if(-1!=startcomment&&(line=line.slice(0,startcomment)),line=line.replace(/^\s+|\s+$/g,""),line.length>0){var optsi=line.search(/<.*>/g),opts=null;-1!=optsi&&(opts=line.slice(optsi).match(/([\w\.\-\+]+)/gi),line=line.slice(0,optsi));var tokens=line.match(/([\w\.\+\[\]]+)/gi);if(!tokens||tokens.length<1)return line.length>=3&&console.log("Warning: bad line "+linenr+": "+line),void 0;switch(tokens[0]){case"part":this.addHeader(tokens[1],Number(tokens[2]));break;case"endpart":if(!this.cur)throw"Unexpected endpart";return this.cur.data.position=0,this.cur=null,void 0;default:if(!this.cur)return console.log("Warning: bad line "+linenr+": "+line+" (Outside of any part definition)"),void 0;if("comment"==this.cur.name)return;var op=assembler.OpcodeMap.map[tokens[0]];if(!op)throw"Bad opcode "+tokens[0]+" "+linenr+": "+line;this.emitOpcode(this.cur,op.opcode);var ti=1;if(op.dest&&"none"!=op.dest){if(!this.emitDest(this.cur,tokens[ti++],op.dest))throw"Bad destination register "+tokens[ti-1]+" "+linenr+": "+line}else this.emitZeroDword(this.cur);if(op.a&&"none"!=op.a.format){if(!this.emitSource(this.cur,tokens[ti++],op.a))throw"Bad source register "+tokens[ti-1]+" "+linenr+": "+line}else this.emitZeroQword(this.cur);if(op.b&&"none"!=op.b.format){if("sampler"==op.b.format){if(!this.emitSampler(this.cur,tokens[ti++],op.b,opts))throw"Bad sampler register "+tokens[ti-1]+" "+linenr+": "+line}else if(!this.emitSource(this.cur,tokens[ti++],op.b))throw"Bad source register "+tokens[ti-1]+" "+linenr+": "+line}else this.emitZeroQword(this.cur)}}},AGALMiniAssembler.prototype.emitHeader=function(pr){switch(pr.data.writeUnsignedByte(160),pr.data.writeUnsignedInt(pr.version),pr.version>=16&&pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(161),pr.name){case"fragment":pr.data.writeUnsignedByte(1);break;case"vertex":pr.data.writeUnsignedByte(0);break;case"cpu":pr.data.writeUnsignedByte(2);break;default:pr.data.writeUnsignedByte(255)}},AGALMiniAssembler.prototype.emitOpcode=function(pr,opcode){pr.data.writeUnsignedInt(opcode)},AGALMiniAssembler.prototype.emitZeroDword=function(pr){pr.data.writeUnsignedInt(0)},AGALMiniAssembler.prototype.emitZeroQword=function(pr){pr.data.writeUnsignedInt(0),pr.data.writeUnsignedInt(0)},AGALMiniAssembler.prototype.emitDest=function(pr,token){var reg=token.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i);if(!assembler.RegMap.map[reg[1]])return!1;var em={num:reg[2]?reg[2]:0,code:assembler.RegMap.map[reg[1]].code,mask:this.stringToMask(reg[3])};return pr.data.writeUnsignedShort(em.num),pr.data.writeUnsignedByte(em.mask),pr.data.writeUnsignedByte(em.code),!0},AGALMiniAssembler.prototype.stringToMask=function(s){if(!s)return 15;var r=0;return-1!=s.indexOf("x")&&(r|=1),-1!=s.indexOf("y")&&(r|=2),-1!=s.indexOf("z")&&(r|=4),-1!=s.indexOf("w")&&(r|=8),r},AGALMiniAssembler.prototype.stringToSwizzle=function(s){if(!s)return 228;var chartoindex={x:0,y:1,z:2,w:3},sw=0;if("."!=s.charAt(0))throw"Missing . for swizzle";return s.length>1&&(sw|=chartoindex[s.charAt(1)]),sw|=s.length>2?chartoindex[s.charAt(2)]<<2:(3&sw)<<2,sw|=s.length>3?chartoindex[s.charAt(3)]<<4:(12&sw)<<2,sw|=s.length>4?chartoindex[s.charAt(4)]<<6:(48&sw)<<2},AGALMiniAssembler.prototype.emitSampler=function(pr,token,opsrc,opts){var reg=token.match(/fs(\d*)/i);if(!reg||!reg[1])return!1;pr.data.writeUnsignedShort(parseInt(reg[1])),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(0);for(var samplerbits=5,sampleroptset=0,i=0;i<opts.length;i++){var o=assembler.SamplerMap.map[opts[i].toLowerCase()];o?(0!=(sampleroptset>>o.shift&o.mask)&&console.log("Warning, duplicate sampler option"),sampleroptset|=o.mask<<o.shift,samplerbits&=~(o.mask<<o.shift),samplerbits|=o.value<<o.shift):console.log("Warning, unknown sampler option: ",opts[i])}return pr.data.writeUnsignedInt(samplerbits),!0},AGALMiniAssembler.prototype.emitSource=function(pr,token){var reg,indexed=token.match(/vc\[(v[tcai])(\d+)\.([xyzw])([\+\-]\d+)?\](\.[xyzw]{1,4})?/i);if(indexed){if(!assembler.RegMap.map[indexed[1]])return!1;var selindex={x:0,y:1,z:2,w:3},em={num:0|indexed[2],code:assembler.RegMap.map[indexed[1]].code,swizzle:this.stringToSwizzle(indexed[5]),select:selindex[indexed[3]],offset:0|indexed[4]};pr.data.writeUnsignedShort(em.num),pr.data.writeByte(em.offset),pr.data.writeUnsignedByte(em.swizzle),pr.data.writeUnsignedByte(1),pr.data.writeUnsignedByte(em.code),pr.data.writeUnsignedByte(em.select),pr.data.writeUnsignedByte(128)}else{if(reg=token.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i),!assembler.RegMap.map[reg[1]])return!1;var em={num:0|reg[2],code:assembler.RegMap.map[reg[1]].code,swizzle:this.stringToSwizzle(reg[3])};pr.data.writeUnsignedShort(em.num),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(em.swizzle),pr.data.writeUnsignedByte(em.code),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(0)}return!0},AGALMiniAssembler.prototype.addHeader=function(partname,version){if(version||(version=1),void 0==this.r[partname])this.r[partname]=new aglsl.assembler.Part(partname,version),this.emitHeader(this.r[partname]);else if(this.r[partname].version!=version)throw"Multiple versions for part "+partname;this.cur=this.r[partname]},AGALMiniAssembler}();assembler.AGALMiniAssembler=AGALMiniAssembler}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var AGALTokenizer=function(){function AGALTokenizer(){}return AGALTokenizer.prototype.decribeAGALByteArray=function(bytes){var header=new aglsl.Header;if(160!=bytes.readUnsignedByte())throw"Bad AGAL: Missing 0xa0 magic byte.";if(header.version=bytes.readUnsignedInt(),header.version>=16&&(bytes.readUnsignedByte(),header.version>>=1),161!=bytes.readUnsignedByte())throw"Bad AGAL: Missing 0xa1 magic byte.";switch(header.progid=bytes.readUnsignedByte(),header.progid){case 1:header.type="fragment";break;case 0:header.type="vertex";break;case 2:header.type="cpu";break;default:header.type=""}for(var desc=new aglsl.Description,tokens=[];bytes.position<bytes.length;){var token=new aglsl.Token;token.opcode=bytes.readUnsignedInt();var lutentry=aglsl.Mapping.agal2glsllut[token.opcode];if(!lutentry)throw"Opcode not valid or not implemented yet: "+token.opcode;lutentry.matrixheight&&(desc.hasmatrix=!0),lutentry.dest?(token.dest.regnum=bytes.readUnsignedShort(),token.dest.mask=bytes.readUnsignedByte(),token.dest.regtype=bytes.readUnsignedByte(),desc.regwrite[token.dest.regtype][token.dest.regnum]|=token.dest.mask):(token.dest=null,bytes.readUnsignedInt()),lutentry.a?this.readReg(token.a,1,desc,bytes):(token.a=null,bytes.readUnsignedInt(),bytes.readUnsignedInt()),lutentry.b?this.readReg(token.b,0|lutentry.matrixheight,desc,bytes):(token.b=null,bytes.readUnsignedInt(),bytes.readUnsignedInt()),tokens.push(token)}return desc.header=header,desc.tokens=tokens,desc},AGALTokenizer.prototype.readReg=function(s,mh,desc,bytes){if(s.regnum=bytes.readUnsignedShort(),s.indexoffset=bytes.readByte(),s.swizzle=bytes.readUnsignedByte(),s.regtype=bytes.readUnsignedByte(),desc.regread[s.regtype][s.regnum]=15,5==s.regtype?(s.lodbiad=s.indexoffset,s.indexoffset=void 0,s.swizzle=void 0,s.readmode=bytes.readUnsignedByte(),s.dim=s.readmode>>4,s.readmode&=15,s.special=bytes.readUnsignedByte(),s.wrap=s.special>>4,s.special&=15,s.mipmap=bytes.readUnsignedByte(),s.filter=s.mipmap>>4,s.mipmap&=15,desc.samplers[s.regnum]=s):(s.indexregtype=bytes.readUnsignedByte(),s.indexselect=bytes.readUnsignedByte(),s.indirectflag=bytes.readUnsignedByte()),s.indirectflag&&(desc.hasindirect=!0),!s.indirectflag&&mh)for(var mhi=0;mh>mhi;mhi++)desc.regread[s.regtype][s.regnum+mhi]=desc.regread[s.regtype][s.regnum]},AGALTokenizer}();aglsl.AGALTokenizer=AGALTokenizer}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var AGLSLParser=function(){function AGLSLParser(){}return AGLSLParser.prototype.parse=function(desc){var header="",body="";header+="precision highp float;\n";var tag=desc.header.type[0];if("vertex"==desc.header.type&&(header+="uniform float yflip;\n"),desc.hasindirect)header+="uniform vec4 "+tag+"carrr["+away.stagegl.ContextStage3D.maxvertexconstants+"];\n";else for(var i=0;i<desc.regread[1].length;i++)desc.regread[1][i]&&(header+="uniform vec4 "+tag+"c"+i+";\n");for(var i=0;i<desc.regread[2].length||i<desc.regwrite[2].length;i++)(desc.regread[2][i]||desc.regwrite[2][i])&&(header+="vec4 "+tag+"t"+i+";\n");for(var i=0;i<desc.regread[0].length;i++)desc.regread[0][i]&&(header+="attribute vec4 va"+i+";\n");for(var i=0;i<desc.regread[4].length||i<desc.regwrite[4].length;i++)(desc.regread[4][i]||desc.regwrite[4][i])&&(header+="varying vec4 vi"+i+";\n");for(var samptype=["2D","Cube","3D",""],i=0;i<desc.samplers.length;i++)desc.samplers[i]&&(header+="uniform sampler"+samptype[3&desc.samplers[i].dim]+" fs"+i+";\n");"vertex"==desc.header.type&&(header+="vec4 outpos;\n"),desc.writedepth&&(header+="vec4 tmp_FragDepth;\n"),body+="void main() {\n";for(var i=0;i<desc.tokens.length;i++){var lutentry=aglsl.Mapping.agal2glsllut[desc.tokens[i].opcode];if(!lutentry)throw"Opcode not valid or not implemented yet: ";for(var sublines=lutentry.matrixheight||1,sl=0;sublines>sl;sl++){var line="  "+lutentry.s;if(desc.tokens[i].dest){if(lutentry.matrixheight){if(1!=(desc.tokens[i].dest.mask>>sl&1))continue;var destregstring=this.regtostring(desc.tokens[i].dest.regtype,desc.tokens[i].dest.regnum,desc,tag),destcaststring="float",destmaskstring=["x","y","z","w"][sl];destregstring+="."+destmaskstring}else{var destcaststring,destmaskstring,destregstring=this.regtostring(desc.tokens[i].dest.regtype,desc.tokens[i].dest.regnum,desc,tag);if(15!=desc.tokens[i].dest.mask){var ndest=0;switch(destmaskstring="",1&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="x"),2&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="y"),4&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="z"),8&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="w"),destregstring+="."+destmaskstring,ndest){case 1:destcaststring="float";break;case 2:destcaststring="vec2";break;case 3:destcaststring="vec3";break;default:throw"Unexpected destination mask"}}else destcaststring="vec4",destmaskstring="xyzw"}line=line.replace("%dest",destregstring),line=line.replace("%cast",destcaststring),line=line.replace("%dm",destmaskstring)}var dwm=15;if(!lutentry.ndwm&&lutentry.dest&&desc.tokens[i].dest&&(dwm=desc.tokens[i].dest.mask),desc.tokens[i].a&&(line=line.replace("%a",this.sourcetostring(desc.tokens[i].a,0,dwm,lutentry.scalar,desc,tag))),desc.tokens[i].b&&(line=line.replace("%b",this.sourcetostring(desc.tokens[i].b,sl,dwm,lutentry.scalar,desc,tag)),5==desc.tokens[i].b.regtype)){var texdim=["2D","Cube","3D"][desc.tokens[i].b.dim],texsize=["vec2","vec3","vec3"][desc.tokens[i].b.dim];line=line.replace("%texdim",texdim),line=line.replace("%texsize",texsize);var texlod="";line=line.replace("%lod",texlod)}body+=line}}return"vertex"==desc.header.type&&(body+="  gl_Position = vec4(outpos.x, outpos.y, outpos.z*2.0 - outpos.w, outpos.w);\n"),desc.writedepth&&(body+="  gl_FragDepth = clamp(tmp_FragDepth,0.0,1.0);\n"),body+="}\n",header+body},AGLSLParser.prototype.regtostring=function(regtype,regnum,desc,tag){switch(regtype){case 0:return"va"+regnum;case 1:return desc.hasindirect&&"vertex"==desc.header.type?"vcarrr["+regnum+"]":tag+"c"+regnum;case 2:return tag+"t"+regnum;case 3:return"vertex"==desc.header.type?"outpos":"gl_FragColor";case 4:return"vi"+regnum;case 5:return"fs"+regnum;case 6:return"tmp_FragDepth";default:throw"Unknown register type"}},AGLSLParser.prototype.sourcetostring=function(s,subline,dwm,isscalar,desc,tag){var r,swiz=["x","y","z","w"];if(s.indirectflag){r="vcarrr[int("+this.regtostring(s.indexregtype,s.regnum,desc,tag)+"."+swiz[s.indexselect]+")";var realofs=subline+s.indexoffset;0>realofs&&(r+=realofs.toString()),realofs>0&&(r+="+"+realofs.toString()),r+="]"}else r=this.regtostring(s.regtype,s.regnum+subline,desc,tag);return 5==s.regtype?r:isscalar?r+"."+swiz[s.swizzle>>0&3]:228==s.swizzle&&15==dwm?r:(r+=".",1&dwm&&(r+=swiz[s.swizzle>>0&3]),2&dwm&&(r+=swiz[s.swizzle>>2&3]),4&dwm&&(r+=swiz[s.swizzle>>4&3]),8&dwm&&(r+=swiz[s.swizzle>>6&3]),r)},AGLSLParser}();aglsl.AGLSLParser=AGLSLParser}(aglsl||(aglsl={}));var __extends=this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);__.prototype=b.prototype,d.prototype=new __},away;!function(away){!function(events){var AnimatorEvent=function(_super){function AnimatorEvent(type,animator){_super.call(this,type),this._animator=animator}return __extends(AnimatorEvent,_super),Object.defineProperty(AnimatorEvent.prototype,"animator",{get:function(){return this._animator},enumerable:!0,configurable:!0}),AnimatorEvent.prototype.clone=function(){return new AnimatorEvent(this.type,this._animator)},AnimatorEvent.START="start",AnimatorEvent.STOP="stop",AnimatorEvent.CYCLE_COMPLETE="cycle_complete",AnimatorEvent}(events.Event);events.AnimatorEvent=AnimatorEvent}(away.events||(away.events={}));away.events}(away||(away={}));var away;!function(away){!function(events){var ShadingMethodEvent=function(_super){function ShadingMethodEvent(type){_super.call(this,type)}return __extends(ShadingMethodEvent,_super),ShadingMethodEvent.SHADER_INVALIDATED="ShaderInvalidated",ShadingMethodEvent}(away.events.Event);events.ShadingMethodEvent=ShadingMethodEvent}(away.events||(away.events={}));away.events}(away||(away={}));var away;!function(away){!function(errors){var AnimationSetError=function(_super){function AnimationSetError(message){_super.call(this,message)}return __extends(AnimationSetError,_super),AnimationSetError}(errors.Error);errors.AnimationSetError=AnimationSetError}(away.errors||(away.errors={}));away.errors}(away||(away={}));var away;!function(away){!function(_pool){var SubGeometryEvent=away.events.SubGeometryEvent,RenderableBase=function(){function RenderableBase(pool,sourceEntity,materialOwner,level,indexOffset){"undefined"==typeof level&&(level=0),"undefined"==typeof indexOffset&&(indexOffset=0);var _this=this;this._geometryDirty=!0,this._indexDataDirty=!0,this._vertexData=new Object,this._pVertexDataDirty=new Object,this._vertexOffset=new Object,this._onIndicesUpdatedDelegate=function(event){return _this._onIndicesUpdated(event)},this._onVerticesUpdatedDelegate=function(event){return _this._onVerticesUpdated(event)},this._pool=pool,this._level=level,this._indexOffset=indexOffset,this.sourceEntity=sourceEntity,this.materialOwner=materialOwner}return Object.defineProperty(RenderableBase.prototype,"overflow",{get:function(){return this._indexDataDirty&&this._updateIndexData(),this._overflow},enumerable:!0,configurable:!0}),Object.defineProperty(RenderableBase.prototype,"numTriangles",{get:function(){return this._numTriangles},enumerable:!0,configurable:!0}),RenderableBase.prototype.getIndexData=function(){return this._indexDataDirty&&this._updateIndexData(),this._indexData},RenderableBase.prototype.getVertexData=function(dataType){return this._indexDataDirty&&this._updateIndexData(),this._pVertexDataDirty[dataType]&&this._updateVertexData(dataType),this._vertexData[this._concatenateArrays?away.base.TriangleSubGeometry.VERTEX_DATA:dataType]},RenderableBase.prototype.getVertexOffset=function(dataType){return this._indexDataDirty&&this._updateIndexData(),this._pVertexDataDirty[dataType]&&this._updateVertexData(dataType),this._vertexOffset[dataType]},RenderableBase.prototype.dispose=function(){this._pool.disposeItem(this.materialOwner),this._indexData.dispose(),this._indexData=null;for(var dataType in this._vertexData)this._vertexData[dataType].dispose(),this._vertexData[dataType]=null;this._overflow&&(this._overflow.dispose(),this._overflow=null)},RenderableBase.prototype.invalidateGeometry=function(){this._geometryDirty=!0,0==this._level&&(this._indexDataDirty=!0),this._overflow&&this._overflow.invalidateGeometry()},RenderableBase.prototype.invalidateIndexData=function(){this._indexDataDirty=!0},RenderableBase.prototype.invalidateVertexData=function(dataType){this._pVertexDataDirty[dataType]=!0},RenderableBase.prototype._pGetSubGeometry=function(){throw new away.errors.AbstractMethodError},RenderableBase.prototype._iFillIndexData=function(indexOffset){this._geometryDirty&&this._updateGeometry(),this._indexData=away.pool.IndexDataPool.getItem(this._subGeometry,this._level,indexOffset),this._numTriangles=this._indexData.data.length/3,indexOffset=this._indexData.offset,indexOffset<this._subGeometry.indices.length?(this._overflow||(this._overflow=this._pGetOverflowRenderable(this._pool,this.materialOwner,indexOffset,this._level+1)),this._overflow._iFillIndexData(indexOffset)):this._overflow&&(this._overflow.dispose(),this._overflow=null)},RenderableBase.prototype._pGetOverflowRenderable=function(){throw new away.errors.AbstractMethodError},RenderableBase.prototype._updateGeometry=function(){this._subGeometry&&(0==this._level&&this._subGeometry.removeEventListener(SubGeometryEvent.INDICES_UPDATED,this._onIndicesUpdatedDelegate),this._subGeometry.removeEventListener(SubGeometryEvent.VERTICES_UPDATED,this._onVerticesUpdatedDelegate)),this._subGeometry=this._pGetSubGeometry(),this._concatenateArrays=this._subGeometry.concatenateArrays,this._subGeometry&&(0==this._level&&this._subGeometry.addEventListener(SubGeometryEvent.INDICES_UPDATED,this._onIndicesUpdatedDelegate),this._subGeometry.addEventListener(SubGeometryEvent.VERTICES_UPDATED,this._onVerticesUpdatedDelegate)),this._geometryDirty=!1
},RenderableBase.prototype._updateIndexData=function(){this._iFillIndexData(this._indexOffset),this._indexDataDirty=!1},RenderableBase.prototype._updateVertexData=function(dataType){this._vertexOffset[dataType]=this._subGeometry.getOffset(dataType),this._subGeometry.concatenateArrays&&(dataType=away.base.SubGeometryBase.VERTEX_DATA),this._vertexData[dataType]=away.pool.VertexDataPool.getItem(this._subGeometry,this.getIndexData(),dataType),this._pVertexDataDirty[dataType]=!1},RenderableBase.prototype._onIndicesUpdated=function(){this.invalidateIndexData()},RenderableBase.prototype._onVerticesUpdated=function(event){this._concatenateArrays=event.target.concatenateArrays,this.invalidateVertexData(event.dataType)},RenderableBase}();_pool.RenderableBase=RenderableBase}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var TriangleSubGeometry=away.base.TriangleSubGeometry,BillboardRenderable=function(_super){function BillboardRenderable(pool,billboard){_super.call(this,pool,billboard,billboard),this._billboard=billboard}return __extends(BillboardRenderable,_super),BillboardRenderable.prototype._pGetSubGeometry=function(){var material=this._billboard.material,geometry=BillboardRenderable._materialGeometry[material.id];return geometry?geometry.updatePositions(Array(0,material.height,0,material.width,material.height,0,material.width,0,0,0,0,0)):(geometry=BillboardRenderable._materialGeometry[material.id]=new TriangleSubGeometry(!0),geometry.autoDeriveNormals=!1,geometry.autoDeriveTangents=!1,geometry.updateIndices(Array(0,1,2,0,2,3)),geometry.updatePositions(Array(0,material.height,0,material.width,material.height,0,material.width,0,0,0,0,0)),geometry.updateVertexNormals(Array(1,0,0,1,0,0,1,0,0,1,0,0)),geometry.updateVertexTangents(Array(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),geometry.updateUVs(Array(0,0,1,0,1,1,0,1))),this._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA]=!0,this._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA]=!0,this._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA]=!0,this._pVertexDataDirty[TriangleSubGeometry.UV_DATA]=!0,geometry},BillboardRenderable._materialGeometry=new Object,BillboardRenderable.id="billboard",BillboardRenderable}(_pool.RenderableBase);_pool.BillboardRenderable=BillboardRenderable}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var IndexData=function(){function IndexData(level){this._dataDirty=!0,this.invalid=new Array(8),this.contexts=new Array(8),this.buffers=new Array(8),this.level=level}return IndexData.prototype.updateData=function(offset,indices,numVertices){if(this._dataDirty)if(this._dataDirty=!1,indices.length<IndexData.LIMIT_INDICES&&numVertices<IndexData.LIMIT_VERTS)this.indexMappings=null,this.originalIndices=null,this.setData(indices),this.offset=indices.length;else{var i,len,outIndex,j,k,splitIndices=new Array;for(this.indexMappings=new Array(indices.length),this.originalIndices=new Array,i=this.indexMappings.length;i--;)this.indexMappings[i]=-1;var originalIndex,splitIndex;for(outIndex=0,len=indices.length,i=offset,k=0;len>i&&outIndex+3<IndexData.LIMIT_INDICES&&k+3<IndexData.LIMIT_VERTS;){for(j=0;3>j;j++)originalIndex=indices[i+j],this.indexMappings[originalIndex]>=0?splitIndex=this.indexMappings[originalIndex]:(splitIndex=k++,this.indexMappings[originalIndex]=splitIndex,this.originalIndices.push(originalIndex)),splitIndices[outIndex+j]=splitIndex;outIndex+=3,i+=3}this.setData(splitIndices),this.offset=i}},IndexData.prototype.invalidateData=function(){this._dataDirty=!0},IndexData.prototype.dispose=function(){for(var i=0;8>i;++i)this.contexts[i]&&(this.contexts[i].disposeIndexData(this),this.contexts[i]=null)},IndexData.prototype.disposeBuffers=function(){for(var i=0;8>i;++i)this.buffers[i]&&(this.buffers[i].dispose(),this.buffers[i]=null)},IndexData.prototype.invalidateBuffers=function(){for(var i=0;8>i;++i)this.invalid[i]=!0},IndexData.prototype.setData=function(data){this.data&&this.data.length!=data.length?this.disposeBuffers():this.invalidateBuffers(),this.data=data},IndexData.LIMIT_VERTS=65535,IndexData.LIMIT_INDICES=16777215,IndexData}();pool.IndexData=IndexData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var IndexDataPool=function(){function IndexDataPool(){}return IndexDataPool.getItem=function(subGeometry,level,indexOffset){var subGeometryData=IndexDataPool._pool[subGeometry.id]||(IndexDataPool._pool[subGeometry.id]=new Array),indexData=subGeometryData[level]||(subGeometryData[level]=new pool.IndexData(level));return indexData.updateData(indexOffset,subGeometry.indices,subGeometry.numVertices),indexData},IndexDataPool.disposeItem=function(id,level){var subGeometryData=this._pool[id];subGeometryData[level].dispose(),subGeometryData[level]=null},IndexDataPool.prototype.disposeData=function(id){for(var subGeometryData=IndexDataPool._pool[id],len=subGeometryData.length,i=0;len>i;i++)subGeometryData[i].dispose(),subGeometryData[i]=null;IndexDataPool._pool[id]=null},IndexDataPool._pool=new Object,IndexDataPool}();pool.IndexDataPool=IndexDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var LineSubGeometry=away.base.LineSubGeometry,LineSubMeshRenderable=function(_super){function LineSubMeshRenderable(pool,subMesh,level,indexOffset){"undefined"==typeof level&&(level=0),"undefined"==typeof indexOffset&&(indexOffset=0),_super.call(this,pool,subMesh.parentMesh,subMesh,level,indexOffset),this.subMesh=subMesh}return __extends(LineSubMeshRenderable,_super),LineSubMeshRenderable.prototype._pGetSubGeometry=function(){var subGeometry=this.subMesh.subGeometry;return this._pVertexDataDirty[LineSubGeometry.START_POSITION_DATA]=!0,this._pVertexDataDirty[LineSubGeometry.END_POSITION_DATA]=!0,subGeometry.thickness&&(this._pVertexDataDirty[LineSubGeometry.THICKNESS_DATA]=!0),subGeometry.startColors&&(this._pVertexDataDirty[LineSubGeometry.COLOR_DATA]=!0),subGeometry},LineSubMeshRenderable.prototype._pGetOverflowRenderable=function(pool,materialOwner,level,indexOffset){return new LineSubMeshRenderable(pool,materialOwner,level,indexOffset)},LineSubMeshRenderable.id="linesubmesh",LineSubMeshRenderable}(_pool.RenderableBase);_pool.LineSubMeshRenderable=LineSubMeshRenderable}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var ProgramData=function(){function ProgramData(pool,context,key){this.usages=0,this._pool=pool,this.context=context,this._key=key,this.context.registerProgram(this)}return ProgramData.prototype.dispose=function(){this.usages--,this.usages||(this._pool.disposeItem(this._key),this.context.unRegisterProgram(this),this.program&&this.program.dispose()),this.program=null},ProgramData.PROGRAMDATA_ID_COUNT=0,ProgramData}();_pool.ProgramData=ProgramData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var ProgramDataPool=function(){function ProgramDataPool(context){this._pool=new Object,this._context=context}return ProgramDataPool.prototype.getItem=function(key){return this._pool[key]||(this._pool[key]=new pool.ProgramData(this,this._context,key))},ProgramDataPool.prototype.disposeItem=function(key){this._pool[key]=null},ProgramDataPool}();pool.ProgramDataPool=ProgramDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var TriangleSubGeometry=away.base.TriangleSubGeometry,SkyboxRenderable=function(_super){function SkyboxRenderable(pool,skybox){_super.call(this,pool,skybox,skybox)}return __extends(SkyboxRenderable,_super),SkyboxRenderable.prototype._pGetSubGeometry=function(){var geometry=SkyboxRenderable._geometry;return geometry||(geometry=SkyboxRenderable._geometry=new TriangleSubGeometry(!0),geometry.autoDeriveNormals=!1,geometry.autoDeriveTangents=!1,geometry.updateIndices(Array(0,1,2,2,3,0,6,5,4,4,7,6,2,6,7,7,3,2,4,5,1,1,0,4,4,0,3,3,7,4,2,1,5,5,6,2)),geometry.updatePositions(Array(-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1))),this._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA]=!0,geometry},SkyboxRenderable.id="skybox",SkyboxRenderable}(_pool.RenderableBase);_pool.SkyboxRenderable=SkyboxRenderable}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var RenderOrderData=function(){function RenderOrderData(pool,context,material){this._pool=pool,this.context=context,this.material=material}return RenderOrderData.prototype.dispose=function(){this._pool.disposeItem(this.material),this.shaderObjects=null},RenderOrderData.prototype.reset=function(){this.shaderObjects=null},RenderOrderData.prototype.invalidate=function(){this.invalid=!0},RenderOrderData}();_pool.RenderOrderData=RenderOrderData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var RenderOrderDataPool=function(){function RenderOrderDataPool(context){this._pool=new Object,this._context=context}return RenderOrderDataPool.prototype.getItem=function(material){return this._pool[material.id]||(this._pool[material.id]=material._iAddRenderOrderData(new pool.RenderOrderData(this,this._context,material)))},RenderOrderDataPool.prototype.disposeItem=function(material){material._iRemoveRenderOrderData(this._pool[material.id]),this._pool[material.id]=null},RenderOrderDataPool}();pool.RenderOrderDataPool=RenderOrderDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var ShaderObjectData=function(){function ShaderObjectData(pool,context,materialPassVO){this.animationVertexCode="",this.animationFragmentCode="",this._pool=pool,this.context=context,this.materialPassVO=materialPassVO}return ShaderObjectData.prototype.dispose=function(){this._pool.disposeItem(this.materialPassVO),this.shaderObject.dispose(),this.shaderObject=null,this.programData.dispose(),this.programData=null},ShaderObjectData.prototype.invalidate=function(){this.invalid=!0},ShaderObjectData}();_pool.ShaderObjectData=ShaderObjectData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var ShaderObjectDataPool=function(){function ShaderObjectDataPool(context){this._pool=new Object,this._context=context}return ShaderObjectDataPool.prototype.getItem=function(materialPass){return this._pool[materialPass._iUniqueId]||(this._pool[materialPass._iUniqueId]=materialPass._iAddShaderObjectData(new pool.ShaderObjectData(this,this._context,materialPass)))},ShaderObjectDataPool.prototype.disposeItem=function(materialPass){materialPass._iRemoveShaderObjectData(this._pool[materialPass._iUniqueId]),this._pool[materialPass._iUniqueId]=null},ShaderObjectDataPool}();pool.ShaderObjectDataPool=ShaderObjectDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var TextureData=function(){function TextureData(pool,context,textureProxy){this._pool=pool,this.context=context,this.textureProxy=textureProxy}return TextureData.prototype.dispose=function(){this._pool.disposeItem(this.textureProxy),this.texture.dispose(),this.texture=null},TextureData.prototype.invalidate=function(){this.invalid=!0},TextureData}();_pool.TextureData=TextureData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var TextureDataPool=function(){function TextureDataPool(context){this._pool=new Object,this._context=context}return TextureDataPool.prototype.getItem=function(textureProxy){return this._pool[textureProxy.id]||(this._pool[textureProxy.id]=textureProxy._iAddTextureData(new pool.TextureData(this,this._context,textureProxy)))},TextureDataPool.prototype.disposeItem=function(textureProxy){textureProxy._iRemoveTextureData(this._pool[textureProxy.id]),this._pool[textureProxy.id]=null},TextureDataPool}();pool.TextureDataPool=TextureDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(_pool){var TriangleSubGeometry=away.base.TriangleSubGeometry,TriangleSubMeshRenderable=function(_super){function TriangleSubMeshRenderable(pool,subMesh,level,indexOffset){"undefined"==typeof level&&(level=0),"undefined"==typeof indexOffset&&(indexOffset=0),_super.call(this,pool,subMesh.parentMesh,subMesh,level,indexOffset),this.subMesh=subMesh}return __extends(TriangleSubMeshRenderable,_super),TriangleSubMeshRenderable.prototype._pGetSubGeometry=function(){var subGeometry;switch(subGeometry=this.subMesh.animator?this.subMesh.animator.getRenderableSubGeometry(this,this.subMesh.subGeometry):this.subMesh.subGeometry,this._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA]=!0,subGeometry.vertexNormals&&(this._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA]=!0),subGeometry.vertexTangents&&(this._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA]=!0),subGeometry.uvs&&(this._pVertexDataDirty[TriangleSubGeometry.UV_DATA]=!0),subGeometry.secondaryUVs&&(this._pVertexDataDirty[TriangleSubGeometry.SECONDARY_UV_DATA]=!0),subGeometry.jointIndices&&(this._pVertexDataDirty[TriangleSubGeometry.JOINT_INDEX_DATA]=!0),subGeometry.jointWeights&&(this._pVertexDataDirty[TriangleSubGeometry.JOINT_WEIGHT_DATA]=!0),subGeometry.jointsPerVertex){case 1:this.JOINT_INDEX_FORMAT=this.JOINT_WEIGHT_FORMAT=away.stagegl.ContextGLVertexBufferFormat.FLOAT_1;break;case 2:this.JOINT_INDEX_FORMAT=this.JOINT_WEIGHT_FORMAT=away.stagegl.ContextGLVertexBufferFormat.FLOAT_2;break;case 3:this.JOINT_INDEX_FORMAT=this.JOINT_WEIGHT_FORMAT=away.stagegl.ContextGLVertexBufferFormat.FLOAT_3;break;case 4:this.JOINT_INDEX_FORMAT=this.JOINT_WEIGHT_FORMAT=away.stagegl.ContextGLVertexBufferFormat.FLOAT_4}return subGeometry},TriangleSubMeshRenderable.prototype._pGetOverflowRenderable=function(pool,materialOwner,level,indexOffset){return new TriangleSubMeshRenderable(pool,materialOwner,level,indexOffset)},TriangleSubMeshRenderable.id="trianglesubmesh",TriangleSubMeshRenderable}(_pool.RenderableBase);_pool.TriangleSubMeshRenderable=TriangleSubMeshRenderable}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var SubGeometryBase=away.base.SubGeometryBase,SubGeometryEvent=away.events.SubGeometryEvent,VertexData=function(){function VertexData(subGeometry,dataType){var _this=this;this._dataDirty=!0,this.invalid=new Array(8),this.buffers=new Array(8),this.contexts=new Array(8),this._subGeometry=subGeometry,this._dataType=dataType,this._onVerticesUpdatedDelegate=function(event){return _this._onVerticesUpdated(event)},this._subGeometry.addEventListener(SubGeometryEvent.VERTICES_UPDATED,this._onVerticesUpdatedDelegate)}return VertexData.prototype.updateData=function(originalIndices,indexMappings){if("undefined"==typeof originalIndices&&(originalIndices=null),"undefined"==typeof indexMappings&&(indexMappings=null),this._dataDirty){this._dataDirty=!1,this.dataPerVertex=this._subGeometry.getStride(this._dataType);var vertices=this._subGeometry[this._dataType];if(null==indexMappings)this.setData(vertices);else{for(var originalIndex,splitIndex,splitVerts=new Array(originalIndices.length*this.dataPerVertex),i=0,j=0;i<originalIndices.length;){for(originalIndex=originalIndices[i],splitIndex=indexMappings[originalIndex]*this.dataPerVertex,originalIndex*=this.dataPerVertex,j=0;j<this.dataPerVertex;j++)splitVerts[splitIndex+j]=vertices[originalIndex+j];i++}this.setData(splitVerts)}}},VertexData.prototype.dispose=function(){for(var i=0;8>i;++i)this.contexts[i]&&(this.contexts[i].disposeVertexData(this),this.contexts[i]=null)},VertexData.prototype.disposeBuffers=function(){for(var i=0;8>i;++i)this.buffers[i]&&(this.buffers[i].dispose(),this.buffers[i]=null)},VertexData.prototype.invalidateBuffers=function(){for(var i=0;8>i;++i)this.invalid[i]=!0},VertexData.prototype.setData=function(data){this.data&&this.data.length!=data.length?this.disposeBuffers():this.invalidateBuffers(),this.data=data},VertexData.prototype._onVerticesUpdated=function(event){var dataType=this._subGeometry.concatenateArrays?SubGeometryBase.VERTEX_DATA:event.dataType;dataType==this._dataType&&(this._dataDirty=!0)},VertexData}();pool.VertexData=VertexData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var SubGeometryBase=away.base.SubGeometryBase,VertexDataPool=function(){function VertexDataPool(){}return VertexDataPool.getItem=function(subGeometry,indexData,dataType){subGeometry.concatenateArrays&&(dataType=SubGeometryBase.VERTEX_DATA);var subGeometryDictionary=VertexDataPool._pool[subGeometry.id]||(VertexDataPool._pool[subGeometry.id]=new Object),subGeometryData=subGeometryDictionary[dataType]||(subGeometryDictionary[dataType]=new Array),vertexData=subGeometryData[indexData.level]||(subGeometryData[indexData.level]=new pool.VertexData(subGeometry,dataType));return vertexData.updateData(indexData.originalIndices,indexData.indexMappings),vertexData},VertexDataPool.disposeItem=function(subGeometry,level,dataType){var subGeometryDictionary=VertexDataPool._pool[subGeometry.id],subGeometryData=subGeometryDictionary[dataType];subGeometryData[level].dispose(),subGeometryData[level]=null},VertexDataPool.prototype.disposeData=function(subGeometry){var subGeometryDictionary=VertexDataPool._pool[subGeometry.id];for(var key in subGeometryDictionary)for(var subGeometryData=subGeometryDictionary[key],len=subGeometryData.length,i=0;len>i;i++)subGeometryData[i].dispose(),subGeometryData[i]=null;VertexDataPool._pool[subGeometry.id]=null},VertexDataPool._pool=new Object,VertexDataPool}();pool.VertexDataPool=VertexDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(stagegl){var AbstractMethodError=away.errors.AbstractMethodError,ShaderObjectDataPool=away.pool.ShaderObjectDataPool,TextureDataPool=away.pool.TextureDataPool,ProgramDataPool=away.pool.ProgramDataPool,RenderOrderDataPool=away.pool.RenderOrderDataPool,RenderTexture=away.textures.RenderTexture,ContextGLBase=function(){function ContextGLBase(stageIndex){this._programData=new Array,this._numUsedStreams=0,this._numUsedTextures=0,this._stageIndex=-1,this._antiAlias=0,this._renderTarget=null,this._renderSurfaceSelector=0,this._stageIndex=stageIndex,this._texturePool=new TextureDataPool(this),this._renderOrderPool=new RenderOrderDataPool(this),this._shaderObjectDataPool=new ShaderObjectDataPool(this),this._programDataPool=new ProgramDataPool(this)}return Object.defineProperty(ContextGLBase.prototype,"container",{get:function(){return this._pContainer},enumerable:!0,configurable:!0}),ContextGLBase.prototype.setRenderTarget=function(target,enableDepthAndStencil,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),(this._renderTarget!==target||surfaceSelector!=this._renderSurfaceSelector||this._enableDepthAndStencil!=enableDepthAndStencil)&&(this._renderTarget=target,this._renderSurfaceSelector=surfaceSelector,this._enableDepthAndStencil=enableDepthAndStencil,target instanceof RenderTexture?this.setRenderToTexture(this.getRenderTexture(target),enableDepthAndStencil,this._antiAlias,surfaceSelector):(this.setRenderToBackBuffer(),this.configureBackBuffer(this._width,this._height,this._antiAlias,this._enableDepthAndStencil)))},ContextGLBase.prototype.getRenderTexture=function(textureProxy){var textureData=this._texturePool.getItem(textureProxy);return textureData.texture||(textureData.texture=this.createTexture(textureProxy.width,textureProxy.height,stagegl.ContextGLTextureFormat.BGRA,!0)),textureData.texture},ContextGLBase.prototype.getShaderObject=function(materialPassVO,profile){var shaderObjectData=this._shaderObjectDataPool.getItem(materialPassVO);if(shaderObjectData.shaderObject||(shaderObjectData.shaderObject=materialPassVO.materialPass.createShaderObject(profile),shaderObjectData.invalid=!0),shaderObjectData.invalid){shaderObjectData.invalid=!1;var compiler=shaderObjectData.shaderObject.createCompiler(materialPassVO);compiler.compile(),shaderObjectData.shadedTarget=compiler.shadedTarget,shaderObjectData.vertexCode=compiler.vertexCode,shaderObjectData.fragmentCode=compiler.fragmentCode,shaderObjectData.postAnimationFragmentCode=compiler.postAnimationFragmentCode,shaderObjectData.key=""}return shaderObjectData},ContextGLBase.prototype.getProgram=function(shaderObjectData){if(shaderObjectData.key.length)return shaderObjectData.programData;shaderObjectData.key=shaderObjectData.animationVertexCode+shaderObjectData.vertexCode+"---"+shaderObjectData.fragmentCode+shaderObjectData.animationFragmentCode+shaderObjectData.postAnimationFragmentCode;var programData=this._programDataPool.getItem(shaderObjectData.key);return shaderObjectData.programData!=programData&&(shaderObjectData.programData&&shaderObjectData.programData.dispose(),shaderObjectData.programData=programData,programData.usages++),programData},ContextGLBase.prototype.getRenderOrderId=function(material,profile){var renderOrderData=this._renderOrderPool.getItem(material),shaderObjects=renderOrderData.shaderObjects;if(!shaderObjects){shaderObjects=renderOrderData.shaderObjects=new Array(numPasses);for(var passes=material.iPasses,numPasses=passes.length,i=0;numPasses>i;i++)shaderObjects[i]=this.getShaderObject(passes[i].getMaterialPassVO(material.id),profile);renderOrderData.invalid=!0}if(renderOrderData.invalid){renderOrderData.invalid=!1;for(var shaderObject,enabledGPUAnimation=this.getEnabledGPUAnimation(material,shaderObjects),renderOrderId=0,mult=1,len=shaderObjects.length,i=0;len>i;i++)shaderObject=shaderObjects[i],shaderObject.shaderObject.usesAnimation=enabledGPUAnimation,this.calcAnimationCode(material,shaderObject),renderOrderId+=this.getProgram(shaderObject).id*mult,mult*=1e3;return renderOrderData.id=renderOrderId}return renderOrderData.id},ContextGLBase.prototype.activateBuffer=function(index,buffer,offset,format){buffer.contexts[this._stageIndex]||(buffer.contexts[this._stageIndex]=this),buffer.buffers[this._stageIndex]||(buffer.buffers[this._stageIndex]=this.createVertexBuffer(buffer.data.length/buffer.dataPerVertex,buffer.dataPerVertex),buffer.invalid[this._stageIndex]=!0),buffer.invalid[this._stageIndex]&&(buffer.buffers[this._stageIndex].uploadFromArray(buffer.data,0,buffer.data.length/buffer.dataPerVertex),buffer.invalid[this._stageIndex]=!1),this.setVertexBufferAt(index,buffer.buffers[this._stageIndex],offset,format)},ContextGLBase.prototype.disposeVertexData=function(buffer){buffer.buffers[this._stageIndex].dispose(),buffer.buffers[this._stageIndex]=null},ContextGLBase.prototype.activateRenderTexture=function(index,textureProxy){this.setTextureAt(index,this.getRenderTexture(textureProxy))},ContextGLBase.prototype.activateShaderObject=function(shaderObjectData,stage,camera){for(var i=shaderObjectData.shaderObject.numUsedStreams;i<this._numUsedStreams;i++)this.setVertexBufferAt(i,null);for(var i=shaderObjectData.shaderObject.numUsedTextures;i<this._numUsedTextures;i++)this.setTextureAt(i,null);shaderObjectData.shaderObject.iActivate(stage,camera);var programData=this.getProgram(shaderObjectData);if(!programData.program){programData.program=this.createProgram();var vertexByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part vertex 1\n"+shaderObjectData.animationVertexCode+shaderObjectData.vertexCode+"endpart").vertex.data,fragmentByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part fragment 1\n"+shaderObjectData.fragmentCode+shaderObjectData.animationFragmentCode+shaderObjectData.postAnimationFragmentCode+"endpart").fragment.data;programData.program.upload(vertexByteCode,fragmentByteCode)}this.setProgram(programData.program)},ContextGLBase.prototype.deactivateShaderObject=function(shaderObjectData,stage){shaderObjectData.shaderObject.iDeactivate(stage),this._numUsedStreams=shaderObjectData.shaderObject.numUsedStreams,this._numUsedTextures=shaderObjectData.shaderObject.numUsedTextures},ContextGLBase.prototype.activateTexture=function(index,textureProxy){var textureData=this._texturePool.getItem(textureProxy);if(textureData.texture||(textureData.texture=this.createTexture(textureProxy.width,textureProxy.height,stagegl.ContextGLTextureFormat.BGRA,!0),textureData.invalid=!0),textureData.invalid)if(textureData.invalid=!1,textureProxy.generateMipmaps)for(var mipmapData=textureProxy._iGetMipmapData(),len=mipmapData.length,i=0;len>i;i++)textureData.texture.uploadFromData(mipmapData[i],i);else textureData.texture.uploadFromData(textureProxy._iGetTextureData(),0);this.setTextureAt(index,textureData.texture)},ContextGLBase.prototype.activateCubeTexture=function(index,textureProxy){var textureData=this._texturePool.getItem(textureProxy);if(textureData.texture||(textureData.texture=this.createCubeTexture(textureProxy.size,stagegl.ContextGLTextureFormat.BGRA,!1),textureData.invalid=!0),textureData.invalid){textureData.invalid=!1;for(var i=0;6>i;++i)if(textureProxy.generateMipmaps)for(var mipmapData=textureProxy._iGetMipmapData(i),len=mipmapData.length,j=0;len>j;j++)textureData.texture.uploadFromData(mipmapData[j],i,j);else textureData.texture.uploadFromData(textureProxy._iGetTextureData(i),i,0)}this.setTextureAt(index,textureData.texture)},ContextGLBase.prototype.getIndexBuffer=function(buffer){return buffer.contexts[this._stageIndex]||(buffer.contexts[this._stageIndex]=this),buffer.buffers[this._stageIndex]||(buffer.buffers[this._stageIndex]=this.createIndexBuffer(buffer.data.length),buffer.invalid[this._stageIndex]=!0),buffer.invalid[this._stageIndex]&&(buffer.buffers[this._stageIndex].uploadFromArray(buffer.data,0,buffer.data.length),buffer.invalid[this._stageIndex]=!1),buffer.buffers[this._stageIndex]},ContextGLBase.prototype.disposeIndexData=function(buffer){buffer.buffers[this._stageIndex].dispose(),buffer.buffers[this._stageIndex]=null},ContextGLBase.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){"undefined"==typeof red&&(red=0),"undefined"==typeof green&&(green=0),"undefined"==typeof blue&&(blue=0),"undefined"==typeof alpha&&(alpha=1),"undefined"==typeof depth&&(depth=1),"undefined"==typeof stencil&&(stencil=0),"undefined"==typeof mask&&(mask=stagegl.ContextGLClearMask.ALL)},ContextGLBase.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!0),this._width=width,this._height=height},ContextGLBase.prototype.createIndexBuffer=function(){throw new AbstractMethodError},ContextGLBase.prototype.createVertexBuffer=function(){throw new AbstractMethodError},ContextGLBase.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){throw"undefined"==typeof streamingLevels&&(streamingLevels=0),new AbstractMethodError},ContextGLBase.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){throw"undefined"==typeof streamingLevels&&(streamingLevels=0),new AbstractMethodError},ContextGLBase.prototype.createProgram=function(){throw new AbstractMethodError},ContextGLBase.prototype.dispose=function(){},ContextGLBase.prototype.present=function(){},ContextGLBase.prototype.setRenderToTexture=function(target,enableDepthAndStencil,antiAlias,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof antiAlias&&(antiAlias=0),"undefined"==typeof surfaceSelector&&(surfaceSelector=0)},ContextGLBase.prototype.setRenderToBackBuffer=function(){},ContextGLBase.prototype.setScissorRectangle=function(){},ContextGLBase.prototype.setTextureAt=function(){},ContextGLBase.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){"undefined"==typeof bufferOffset&&(bufferOffset=0),"undefined"==typeof format&&(format=null)},ContextGLBase.prototype.setProgram=function(){},ContextGLBase.prototype.registerProgram=function(programData){for(var i=0;null!=this._programData[i];)i++;this._programData[i]=programData,programData.id=i},ContextGLBase.prototype.unRegisterProgram=function(programData){this._programData[programData.id]=null,programData.id=-1},ContextGLBase.prototype.getEnabledGPUAnimation=function(material,shaderObjects){if(material.animationSet){material.animationSet.resetGPUCompatibility();for(var owners=material.iOwners,numOwners=owners.length,len=shaderObjects.length,i=0;len>i;i++)for(var j=0;numOwners>j;j++)owners[j].animator&&owners[j].animator.testGPUCompatibility(shaderObjects[i].shaderObject);return!material.animationSet.usesCPU}return!1},ContextGLBase.prototype.calcAnimationCode=function(material,shaderObjectData){shaderObjectData.key="",shaderObjectData.animationVertexCode="",shaderObjectData.animationFragmentCode="";var shaderObject=shaderObjectData.shaderObject;if(shaderObject.usesAnimation){var animationSet=material.animationSet;shaderObjectData.animationVertexCode+=animationSet.getAGALVertexCode(shaderObject),shaderObject.uvDependencies>0&&!shaderObject.usesUVTransform&&(shaderObjectData.animationVertexCode+=animationSet.getAGALUVCode(shaderObject)),shaderObject.usesFragmentAnimation&&(shaderObjectData.animationFragmentCode+=animationSet.getAGALFragmentCode(shaderObject,shaderObjectData.shadedTarget)),animationSet.doneAGALCode(shaderObject)}else{for(var len=shaderObject.animatableAttributes.length,i=0;len>i;++i)shaderObjectData.animationVertexCode+="mov "+shaderObject.animationTargetRegisters[i]+", "+shaderObject.animatableAttributes[i]+"\n";shaderObject.uvDependencies>0&&!shaderObject.usesUVTransform&&(shaderObjectData.animationVertexCode+="mov "+shaderObject.uvTarget+","+shaderObject.uvSource+"\n")}},ContextGLBase}();stagegl.ContextGLBase=ContextGLBase}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLClearMask=function(){function ContextGLClearMask(){}return ContextGLClearMask.COLOR=1,ContextGLClearMask.DEPTH=2,ContextGLClearMask.STENCIL=4,ContextGLClearMask.ALL=ContextGLClearMask.COLOR|ContextGLClearMask.DEPTH|ContextGLClearMask.STENCIL,ContextGLClearMask}();stagegl.ContextGLClearMask=ContextGLClearMask}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLTextureFormat=function(){function ContextGLTextureFormat(){}return ContextGLTextureFormat.BGRA="bgra",ContextGLTextureFormat.BGRA_PACKED="bgraPacked4444",ContextGLTextureFormat.BGR_PACKED="bgrPacked565",ContextGLTextureFormat.COMPRESSED="compressed",ContextGLTextureFormat.COMPRESSED_ALPHA="compressedAlpha",ContextGLTextureFormat}();stagegl.ContextGLTextureFormat=ContextGLTextureFormat}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLTriangleFace=function(){function ContextGLTriangleFace(){}return ContextGLTriangleFace.BACK="back",ContextGLTriangleFace.FRONT="front",ContextGLTriangleFace.FRONT_AND_BACK="frontAndBack",ContextGLTriangleFace.NONE="none",ContextGLTriangleFace}();stagegl.ContextGLTriangleFace=ContextGLTriangleFace}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLVertexBufferFormat=function(){function ContextGLVertexBufferFormat(){}return ContextGLVertexBufferFormat.BYTES_4="bytes4",ContextGLVertexBufferFormat.FLOAT_1="float1",ContextGLVertexBufferFormat.FLOAT_2="float2",ContextGLVertexBufferFormat.FLOAT_3="float3",ContextGLVertexBufferFormat.FLOAT_4="float4",ContextGLVertexBufferFormat}();stagegl.ContextGLVertexBufferFormat=ContextGLVertexBufferFormat}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLProgramType=function(){function ContextGLProgramType(){}return ContextGLProgramType.FRAGMENT="fragment",ContextGLProgramType.VERTEX="vertex",ContextGLProgramType}();stagegl.ContextGLProgramType=ContextGLProgramType}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLBlendFactor=function(){function ContextGLBlendFactor(){}return ContextGLBlendFactor.DESTINATION_ALPHA="destinationAlpha",ContextGLBlendFactor.DESTINATION_COLOR="destinationColor",ContextGLBlendFactor.ONE="one",ContextGLBlendFactor.ONE_MINUS_DESTINATION_ALPHA="oneMinusDestinationAlpha",ContextGLBlendFactor.ONE_MINUS_DESTINATION_COLOR="oneMinusDestinationColor",ContextGLBlendFactor.ONE_MINUS_SOURCE_ALPHA="oneMinusSourceAlpha",ContextGLBlendFactor.ONE_MINUS_SOURCE_COLOR="oneMinusSourceColor",ContextGLBlendFactor.SOURCE_ALPHA="sourceAlpha",ContextGLBlendFactor.SOURCE_COLOR="sourceColor",ContextGLBlendFactor.ZERO="zero",ContextGLBlendFactor
}();stagegl.ContextGLBlendFactor=ContextGLBlendFactor}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLCompareMode=function(){function ContextGLCompareMode(){}return ContextGLCompareMode.ALWAYS="always",ContextGLCompareMode.EQUAL="equal",ContextGLCompareMode.GREATER="greater",ContextGLCompareMode.GREATER_EQUAL="greaterEqual",ContextGLCompareMode.LESS="less",ContextGLCompareMode.LESS_EQUAL="lessEqual",ContextGLCompareMode.NEVER="never",ContextGLCompareMode.NOT_EQUAL="notEqual",ContextGLCompareMode}();stagegl.ContextGLCompareMode=ContextGLCompareMode}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLMipFilter=function(){function ContextGLMipFilter(){}return ContextGLMipFilter.MIPLINEAR="miplinear",ContextGLMipFilter.MIPNEAREST="mipnearest",ContextGLMipFilter.MIPNONE="mipnone",ContextGLMipFilter}();stagegl.ContextGLMipFilter=ContextGLMipFilter}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLProfile=function(){function ContextGLProfile(){}return ContextGLProfile.BASELINE="baseline",ContextGLProfile.BASELINE_CONSTRAINED="baselineConstrained",ContextGLProfile.BASELINE_EXTENDED="baselineExtended",ContextGLProfile}();stagegl.ContextGLProfile=ContextGLProfile}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLStencilAction=function(){function ContextGLStencilAction(){}return ContextGLStencilAction.DECREMENT_SATURATE="decrementSaturate",ContextGLStencilAction.DECREMENT_WRAP="decrementWrap",ContextGLStencilAction.INCREMENT_SATURATE="incrementSaturate",ContextGLStencilAction.INCREMENT_WRAP="incrementWrap",ContextGLStencilAction.INVERT="invert",ContextGLStencilAction.KEEP="keep",ContextGLStencilAction.SET="set",ContextGLStencilAction.ZERO="zero",ContextGLStencilAction}();stagegl.ContextGLStencilAction=ContextGLStencilAction}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLTextureFilter=function(){function ContextGLTextureFilter(){}return ContextGLTextureFilter.LINEAR="linear",ContextGLTextureFilter.NEAREST="nearest",ContextGLTextureFilter}();stagegl.ContextGLTextureFilter=ContextGLTextureFilter}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLWrapMode=function(){function ContextGLWrapMode(){}return ContextGLWrapMode.CLAMP="clamp",ContextGLWrapMode.REPEAT="repeat",ContextGLWrapMode}();stagegl.ContextGLWrapMode=ContextGLWrapMode}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextStage3D=function(_super){function ContextStage3D(container,stageIndex,callback){function callbackSWFObject(callbackInfo){callbackInfo.success&&(context3dObj._pContainer=callbackInfo.ref,context3dObj._iCallback=callback)}_super.call(this,stageIndex),this._cmdStream="",this._resources=new Array;var swfVersionStr="11.0.0",flashvars={id:container.id},params={quality:"high",bgcolor:"#ffffff",allowscriptaccess:"sameDomain",allowfullscreen:"true",wmode:"direct"};this._errorCheckingEnabled=!1,this._iDriverInfo="Unknown";var attributes={salign:"tl",id:container.id,name:container.name};this._oldCanvas=container.cloneNode(),this._oldParent=container.parentNode;var context3dObj=this;ContextStage3D.contexts[container.id]=this,swfobject.embedSWF("../libs/molehill_js_flashbridge.swf",container.id,String(container.width),String(container.height),swfVersionStr,"",flashvars,params,attributes,callbackSWFObject)}return __extends(ContextStage3D,_super),Object.defineProperty(ContextStage3D.prototype,"container",{get:function(){return this._pContainer},enumerable:!0,configurable:!0}),Object.defineProperty(ContextStage3D.prototype,"driverInfo",{get:function(){return this._iDriverInfo},enumerable:!0,configurable:!0}),Object.defineProperty(ContextStage3D.prototype,"errorCheckingEnabled",{get:function(){return this._errorCheckingEnabled},set:function(value){this._errorCheckingEnabled!=value&&(this._errorCheckingEnabled=value,this.addStream(String.fromCharCode(away.stagegl.OpCodes.enableErrorChecking,value?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)),this.execute())},enumerable:!0,configurable:!0}),ContextStage3D.prototype._iAddResource=function(resource){this._resources.push(resource)},ContextStage3D.prototype._iRemoveResource=function(resource){this._resources.splice(this._resources.indexOf(resource))},ContextStage3D.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){return"undefined"==typeof streamingLevels&&(streamingLevels=0),new stagegl.TextureFlash(this,width,height,format,optimizeForRenderToTexture)},ContextStage3D.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){return"undefined"==typeof streamingLevels&&(streamingLevels=0),new stagegl.CubeTextureFlash(this,size,format,optimizeForRenderToTexture)},ContextStage3D.prototype.setTextureAt=function(sampler,texture){texture?this.addStream(String.fromCharCode(away.stagegl.OpCodes.setTextureAt)+sampler+","+texture.id+","):this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearTextureAt)+sampler.toString()+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setSamplerStateAt=function(){},ContextStage3D.prototype.setStencilActions=function(triangleFace,compareMode,actionOnBothPass,actionOnDepthFail,actionOnDepthPassStencilFail){"undefined"==typeof triangleFace&&(triangleFace="frontAndBack"),"undefined"==typeof compareMode&&(compareMode="always"),"undefined"==typeof actionOnBothPass&&(actionOnBothPass="keep"),"undefined"==typeof actionOnDepthFail&&(actionOnDepthFail="keep"),"undefined"==typeof actionOnDepthPassStencilFail&&(actionOnDepthPassStencilFail="keep"),this.addStream(String.fromCharCode(away.stagegl.OpCodes.setStencilActions)+triangleFace+"$"+compareMode+"$"+actionOnBothPass+"$"+actionOnDepthFail+"$"+actionOnDepthPassStencilFail+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setStencilReferenceValue=function(referenceValue,readMask,writeMask){"undefined"==typeof readMask&&(readMask=255),"undefined"==typeof writeMask&&(writeMask=255),this.addStream(String.fromCharCode(away.stagegl.OpCodes.setStencilReferenceValue,referenceValue+away.stagegl.OpCodes.intMask,readMask+away.stagegl.OpCodes.intMask,writeMask+away.stagegl.OpCodes.intMask)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setCulling=function(triangleFaceToCull,coordinateSystem){"undefined"==typeof coordinateSystem&&(coordinateSystem="leftHanded"),this.addStream(String.fromCharCode(away.stagegl.OpCodes.setCulling)+triangleFaceToCull+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.drawTriangles=function(indexBuffer,firstIndex,numTriangles){"undefined"==typeof firstIndex&&(firstIndex=0),"undefined"==typeof numTriangles&&(numTriangles=-1),firstIndex=firstIndex||0,(!numTriangles||0>numTriangles)&&(numTriangles=indexBuffer.numIndices/3),this.addStream(String.fromCharCode(away.stagegl.OpCodes.drawTriangles,indexBuffer.id+away.stagegl.OpCodes.intMask)+firstIndex+","+numTriangles+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setProgramConstantsFromMatrix=function(programType,firstRegister,matrix,transposedMatrix){"undefined"==typeof transposedMatrix&&(transposedMatrix=!1);var d=matrix.rawData;transposedMatrix?(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[4],d[8],d[12]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[1],d[5],d[9],d[13]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[2],d[6],d[10],d[14]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[3],d[7],d[11],d[15]],1)):(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[1],d[2],d[3]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[4],d[5],d[6],d[7]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[8],d[9],d[10],d[11]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[12],d[13],d[14],d[15]],1))},ContextStage3D.prototype.setProgramConstantsFromArray=function(programType,firstRegister,data,numRegisters){"undefined"==typeof numRegisters&&(numRegisters=-1);for(var startIndex,target=programType==stagegl.ContextGLProgramType.VERTEX?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,i=0;numRegisters>i;i++)startIndex=4*i,this.addStream(String.fromCharCode(away.stagegl.OpCodes.setProgramConstant,target,firstRegister+i+away.stagegl.OpCodes.intMask)+data[startIndex]+","+data[startIndex+1]+","+data[startIndex+2]+","+data[startIndex+3]+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setProgram=function(program){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setProgram,program.id+away.stagegl.OpCodes.intMask)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.present=function(){this.addStream(String.fromCharCode(away.stagegl.OpCodes.present)),this.execute()},ContextStage3D.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){"undefined"==typeof red&&(red=0),"undefined"==typeof green&&(green=0),"undefined"==typeof blue&&(blue=0),"undefined"==typeof alpha&&(alpha=1),"undefined"==typeof depth&&(depth=1),"undefined"==typeof stencil&&(stencil=0),"undefined"==typeof mask&&(mask=stagegl.ContextGLClearMask.ALL),this.addStream(String.fromCharCode(away.stagegl.OpCodes.clear)+red+","+green+","+blue+","+alpha+","+depth+","+stencil+","+mask+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.createProgram=function(){return new stagegl.ProgramFlash(this)},ContextStage3D.prototype.createVertexBuffer=function(numVertices,data32PerVertex){return new stagegl.VertexBufferFlash(this,numVertices,data32PerVertex)},ContextStage3D.prototype.createIndexBuffer=function(numIndices){return new stagegl.IndexBufferFlash(this,numIndices)},ContextStage3D.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!0),_super.prototype.configureBackBuffer.call(this,width,height,antiAlias,enableDepthAndStencil),this.addStream(String.fromCharCode(away.stagegl.OpCodes.configureBackBuffer)+width+","+height+",")},ContextStage3D.prototype.drawToBitmapData=function(){},ContextStage3D.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){"undefined"==typeof bufferOffset&&(bufferOffset=0),"undefined"==typeof format&&(format=null),buffer?this.addStream(String.fromCharCode(away.stagegl.OpCodes.setVertexBufferAt,index+away.stagegl.OpCodes.intMask)+buffer.id+","+bufferOffset+","+format+"$"):this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearVertexBufferAt,index+away.stagegl.OpCodes.intMask)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setColorMask=function(red,green,blue,alpha){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setColorMask,red?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,green?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,blue?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,alpha?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setBlendFactors=function(sourceFactor,destinationFactor){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setBlendFactors)+sourceFactor+"$"+destinationFactor+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setRenderToTexture=function(target,enableDepthAndStencil,antiAlias,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof antiAlias&&(antiAlias=0),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),null===target||void 0===target?this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearRenderToTexture)):this.addStream(String.fromCharCode(away.stagegl.OpCodes.setRenderToTexture,enableDepthAndStencil?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+target.id+","+(antiAlias||0)+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setRenderToBackBuffer=function(){this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearRenderToTexture)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setScissorRectangle=function(rectangle){rectangle?this.addStream(String.fromCharCode(away.stagegl.OpCodes.setScissorRect)+rectangle.x+","+rectangle.y+","+rectangle.width+","+rectangle.height+","):this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearScissorRect)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setDepthTest=function(depthMask,passCompareMode){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setDepthTest,depthMask?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+passCompareMode+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.dispose=function(){if(null!=this._pContainer){for(console.log("Context3D dispose, releasing "+this._resources.length+" resources.");this._resources.length;)this._resources[0].dispose();this._pContainer&&(this.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeContext)),this.execute(),swfobject.removeSWF(this._oldCanvas.id),this._oldCanvas&&this._oldParent&&(this._oldParent.appendChild(this._oldCanvas),this._oldParent=null),this._pContainer=null),this._oldCanvas=null}},ContextStage3D.prototype.addStream=function(stream){this._cmdStream+=stream},ContextStage3D.prototype.execute=function(){ContextStage3D.logStream&&console.log(this._cmdStream);var result=this._pContainer.CallFunction('<invoke name="execStage3dOpStream" returntype="javascript"><arguments><string>'+this._cmdStream+"</string></arguments></invoke>");if(Number(result)<=-3)throw"Exec stream failed";return this._cmdStream="",Number(result)},ContextStage3D.contexts=new Object,ContextStage3D.maxvertexconstants=128,ContextStage3D.maxfragconstants=28,ContextStage3D.maxtemp=8,ContextStage3D.maxstreams=8,ContextStage3D.maxtextures=8,ContextStage3D.defaultsampler=new aglsl.Sampler,ContextStage3D.debug=!1,ContextStage3D.logStream=!1,ContextStage3D}(stagegl.ContextGLBase);stagegl.ContextStage3D=ContextStage3D}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextWebGL=function(_super){function ContextWebGL(canvas,stageIndex){_super.call(this,stageIndex),this._blendFactorDictionary=new Object,this._depthTestDictionary=new Object,this._textureIndexDictionary=new Array(8),this._textureTypeDictionary=new Object,this._wrapDictionary=new Object,this._filterDictionary=new Object,this._mipmapFilterDictionary=new Object,this._uniformLocationNameDictionary=new Object,this._vertexBufferDimensionDictionary=new Object,this._indexBufferList=new Array,this._vertexBufferList=new Array,this._textureList=new Array,this._programList=new Array,this._samplerStates=new Array(8),this._pContainer=canvas;try{this._gl=canvas.getContext("experimental-webgl",{premultipliedAlpha:!1,alpha:!1}),this._gl||(this._gl=canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!1}))}catch(e){}this._gl?(this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE]=this._gl.ONE,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.DESTINATION_ALPHA]=this._gl.DST_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.DESTINATION_COLOR]=this._gl.DST_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE]=this._gl.ONE,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_DESTINATION_ALPHA]=this._gl.ONE_MINUS_DST_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_DESTINATION_COLOR]=this._gl.ONE_MINUS_DST_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_SOURCE_ALPHA]=this._gl.ONE_MINUS_SRC_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_SOURCE_COLOR]=this._gl.ONE_MINUS_SRC_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.SOURCE_ALPHA]=this._gl.SRC_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.SOURCE_COLOR]=this._gl.SRC_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ZERO]=this._gl.ZERO,this._depthTestDictionary[stagegl.ContextGLCompareMode.ALWAYS]=this._gl.ALWAYS,this._depthTestDictionary[stagegl.ContextGLCompareMode.EQUAL]=this._gl.EQUAL,this._depthTestDictionary[stagegl.ContextGLCompareMode.GREATER]=this._gl.GREATER,this._depthTestDictionary[stagegl.ContextGLCompareMode.GREATER_EQUAL]=this._gl.GEQUAL,this._depthTestDictionary[stagegl.ContextGLCompareMode.LESS]=this._gl.LESS,this._depthTestDictionary[stagegl.ContextGLCompareMode.LESS_EQUAL]=this._gl.LEQUAL,this._depthTestDictionary[stagegl.ContextGLCompareMode.NEVER]=this._gl.NEVER,this._depthTestDictionary[stagegl.ContextGLCompareMode.NOT_EQUAL]=this._gl.NOTEQUAL,this._textureIndexDictionary[0]=this._gl.TEXTURE0,this._textureIndexDictionary[1]=this._gl.TEXTURE1,this._textureIndexDictionary[2]=this._gl.TEXTURE2,this._textureIndexDictionary[3]=this._gl.TEXTURE3,this._textureIndexDictionary[4]=this._gl.TEXTURE4,this._textureIndexDictionary[5]=this._gl.TEXTURE5,this._textureIndexDictionary[6]=this._gl.TEXTURE6,this._textureIndexDictionary[7]=this._gl.TEXTURE7,this._textureTypeDictionary.texture2d=this._gl.TEXTURE_2D,this._textureTypeDictionary.textureCube=this._gl.TEXTURE_CUBE_MAP,this._wrapDictionary[stagegl.ContextGLWrapMode.REPEAT]=this._gl.REPEAT,this._wrapDictionary[stagegl.ContextGLWrapMode.CLAMP]=this._gl.CLAMP_TO_EDGE,this._filterDictionary[stagegl.ContextGLTextureFilter.LINEAR]=this._gl.LINEAR,this._filterDictionary[stagegl.ContextGLTextureFilter.NEAREST]=this._gl.NEAREST,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR]=new Object,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR][stagegl.ContextGLMipFilter.MIPNEAREST]=this._gl.LINEAR_MIPMAP_NEAREST,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR][stagegl.ContextGLMipFilter.MIPLINEAR]=this._gl.LINEAR_MIPMAP_LINEAR,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR][stagegl.ContextGLMipFilter.MIPNONE]=this._gl.LINEAR,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST]=new Object,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST][stagegl.ContextGLMipFilter.MIPNEAREST]=this._gl.NEAREST_MIPMAP_NEAREST,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST][stagegl.ContextGLMipFilter.MIPLINEAR]=this._gl.NEAREST_MIPMAP_LINEAR,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST][stagegl.ContextGLMipFilter.MIPNONE]=this._gl.NEAREST,this._uniformLocationNameDictionary[stagegl.ContextGLProgramType.VERTEX]="vc",this._uniformLocationNameDictionary[stagegl.ContextGLProgramType.FRAGMENT]="fc",this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_1]=1,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_2]=2,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_3]=3,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_4]=4,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.BYTES_4]=4):alert("WebGL is not available.");for(var i=0;i<ContextWebGL.MAX_SAMPLERS;++i)this._samplerStates[i]=new stagegl.SamplerState,this._samplerStates[i].wrap=this._gl.REPEAT,this._samplerStates[i].filter=this._gl.LINEAR,this._samplerStates[i].mipfilter=this._gl.LINEAR}return __extends(ContextWebGL,_super),Object.defineProperty(ContextWebGL.prototype,"container",{get:function(){return this._pContainer},enumerable:!0,configurable:!0}),ContextWebGL.prototype.gl=function(){return this._gl},ContextWebGL.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){"undefined"==typeof red&&(red=0),"undefined"==typeof green&&(green=0),"undefined"==typeof blue&&(blue=0),"undefined"==typeof alpha&&(alpha=1),"undefined"==typeof depth&&(depth=1),"undefined"==typeof stencil&&(stencil=0),"undefined"==typeof mask&&(mask=stagegl.ContextGLClearMask.ALL),this._drawing||(this.updateBlendStatus(),this._drawing=!0);var glmask=0;mask&stagegl.ContextGLClearMask.COLOR&&(glmask|=this._gl.COLOR_BUFFER_BIT),mask&stagegl.ContextGLClearMask.STENCIL&&(glmask|=this._gl.STENCIL_BUFFER_BIT),mask&stagegl.ContextGLClearMask.DEPTH&&(glmask|=this._gl.DEPTH_BUFFER_BIT),this._gl.clearColor(red,green,blue,alpha),this._gl.clearDepth(depth),this._gl.clearStencil(stencil),this._gl.clear(glmask)},ContextWebGL.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!0),_super.prototype.configureBackBuffer.call(this,width,height,antiAlias,enableDepthAndStencil),enableDepthAndStencil&&(this._gl.enable(this._gl.STENCIL_TEST),this._gl.enable(this._gl.DEPTH_TEST)),this._gl.viewport.width=width,this._gl.viewport.height=height,this._gl.viewport(0,0,width,height)},ContextWebGL.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){"undefined"==typeof streamingLevels&&(streamingLevels=0);var texture=new stagegl.CubeTextureWebGL(this._gl,size);return this._textureList.push(texture),texture},ContextWebGL.prototype.createIndexBuffer=function(numIndices){var indexBuffer=new stagegl.IndexBufferWebGL(this._gl,numIndices);return this._indexBufferList.push(indexBuffer),indexBuffer},ContextWebGL.prototype.createProgram=function(){var program=new stagegl.ProgramWebGL(this._gl);return this._programList.push(program),program},ContextWebGL.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){"undefined"==typeof streamingLevels&&(streamingLevels=0);var texture=new stagegl.TextureWebGL(this._gl,width,height);return this._textureList.push(texture),texture},ContextWebGL.prototype.createVertexBuffer=function(numVertices,data32PerVertex){var vertexBuffer=new stagegl.VertexBufferWebGL(this._gl,numVertices,data32PerVertex);return this._vertexBufferList.push(vertexBuffer),vertexBuffer},ContextWebGL.prototype.dispose=function(){var i;for(i=0;i<this._indexBufferList.length;++i)this._indexBufferList[i].dispose();for(this._indexBufferList=null,i=0;i<this._vertexBufferList.length;++i)this._vertexBufferList[i].dispose();for(this._vertexBufferList=null,i=0;i<this._textureList.length;++i)this._textureList[i].dispose();for(this._textureList=null,i=0;i<this._programList.length;++i)this._programList[i].dispose();for(i=0;i<this._samplerStates.length;++i)this._samplerStates[i]=null;this._programList=null},ContextWebGL.prototype.drawToBitmapData=function(destination){var arrayBuffer=new ArrayBuffer(destination.width*destination.height*4);this._gl.readPixels(0,0,destination.width,destination.height,this._gl.RGBA,this._gl.UNSIGNED_BYTE,new Uint8Array(arrayBuffer));var byteArray=new away.utils.ByteArray;byteArray.setArrayBuffer(arrayBuffer),destination.setPixels(new away.geom.Rectangle(0,0,destination.width,destination.height),byteArray)},ContextWebGL.prototype.drawTriangles=function(indexBuffer,firstIndex,numTriangles){if("undefined"==typeof firstIndex&&(firstIndex=0),"undefined"==typeof numTriangles&&(numTriangles=-1),!this._drawing)throw"Need to clear before drawing if the buffer has not been cleared since the last present() call.";this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,indexBuffer.glBuffer),this._gl.drawElements(this._gl.TRIANGLES,-1==numTriangles?indexBuffer.numIndices:3*numTriangles,this._gl.UNSIGNED_SHORT,firstIndex)},ContextWebGL.prototype.present=function(){this._drawing=!1},ContextWebGL.prototype.setBlendFactors=function(sourceFactor,destinationFactor){this._blendEnabled=!0,this._blendSourceFactor=this._blendFactorDictionary[sourceFactor],this._blendDestinationFactor=this._blendFactorDictionary[destinationFactor],this.updateBlendStatus()},ContextWebGL.prototype.setColorMask=function(red,green,blue,alpha){this._gl.colorMask(red,green,blue,alpha)},ContextWebGL.prototype.setCulling=function(triangleFaceToCull,coordinateSystem){if("undefined"==typeof coordinateSystem&&(coordinateSystem="leftHanded"),triangleFaceToCull==stagegl.ContextGLTriangleFace.NONE)this._gl.disable(this._gl.CULL_FACE);else switch(this._gl.enable(this._gl.CULL_FACE),triangleFaceToCull){case stagegl.ContextGLTriangleFace.BACK:this._gl.cullFace("leftHanded"==coordinateSystem?this._gl.FRONT:this._gl.BACK);break;case stagegl.ContextGLTriangleFace.FRONT:this._gl.cullFace("leftHanded"==coordinateSystem?this._gl.BACK:this._gl.FRONT);break;case stagegl.ContextGLTriangleFace.FRONT_AND_BACK:this._gl.cullFace(this._gl.FRONT_AND_BACK);break;default:throw"Unknown ContextGLTriangleFace type."}},ContextWebGL.prototype.setDepthTest=function(depthMask,passCompareMode){this._gl.depthFunc(this._depthTestDictionary[passCompareMode]),this._gl.depthMask(depthMask)},ContextWebGL.prototype.setProgram=function(program){this._currentProgram=program,program.focusProgram()},ContextWebGL.prototype.setProgramConstantsFromMatrix=function(programType,firstRegister,matrix,transposedMatrix){"undefined"==typeof transposedMatrix&&(transposedMatrix=!1);var d=matrix.rawData;transposedMatrix?(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[4],d[8],d[12]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[1],d[5],d[9],d[13]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[2],d[6],d[10],d[14]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[3],d[7],d[11],d[15]],1)):(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[1],d[2],d[3]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[4],d[5],d[6],d[7]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[8],d[9],d[10],d[11]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[12],d[13],d[14],d[15]],1))},ContextWebGL.prototype.setProgramConstantsFromArray=function(programType,firstRegister,data,numRegisters){"undefined"==typeof numRegisters&&(numRegisters=-1);for(var startIndex,locationName=this._uniformLocationNameDictionary[programType],i=0;numRegisters>i;i++)startIndex=4*i,this._gl.uniform4f(this._gl.getUniformLocation(this._currentProgram.glProgram,locationName+(firstRegister+i)),data[startIndex],data[startIndex+1],data[startIndex+2],data[startIndex+3])},ContextWebGL.prototype.setScissorRectangle=function(rectangle){return rectangle?(this._gl.enable(this._gl.SCISSOR_TEST),this._gl.scissor(rectangle.x,rectangle.y,rectangle.width,rectangle.height),void 0):(this._gl.disable(this._gl.SCISSOR_TEST),void 0)},ContextWebGL.prototype.setTextureAt=function(sampler,texture){var samplerState=this._samplerStates[sampler];if(this._activeTexture!=sampler&&(texture||samplerState.type)&&(this._activeTexture=sampler,this._gl.activeTexture(this._textureIndexDictionary[sampler])),!texture)return samplerState.type&&(this._gl.bindTexture(samplerState.type,null),samplerState.type=null),void 0;var textureType=this._textureTypeDictionary[texture.textureType];samplerState.type=textureType,this._gl.bindTexture(textureType,texture.glTexture),this._gl.uniform1i(this._gl.getUniformLocation(this._currentProgram.glProgram,"fs"+sampler),sampler),this._gl.texParameteri(textureType,this._gl.TEXTURE_WRAP_S,samplerState.wrap),this._gl.texParameteri(textureType,this._gl.TEXTURE_WRAP_T,samplerState.wrap),this._gl.texParameteri(textureType,this._gl.TEXTURE_MAG_FILTER,samplerState.filter),this._gl.texParameteri(textureType,this._gl.TEXTURE_MIN_FILTER,samplerState.mipfilter)},ContextWebGL.prototype.setSamplerStateAt=function(sampler,wrap,filter,mipfilter){if(!(sampler>=0&&sampler<ContextWebGL.MAX_SAMPLERS))throw"Sampler is out of bounds.";this._samplerStates[sampler].wrap=this._wrapDictionary[wrap],this._samplerStates[sampler].filter=this._filterDictionary[filter],this._samplerStates[sampler].mipfilter=this._mipmapFilterDictionary[filter][mipfilter]},ContextWebGL.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){"undefined"==typeof bufferOffset&&(bufferOffset=0),"undefined"==typeof format&&(format=null);var location=this._currentProgram?this._gl.getAttribLocation(this._currentProgram.glProgram,"va"+index):-1;return buffer?(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,buffer.glBuffer),this._gl.enableVertexAttribArray(location),this._gl.vertexAttribPointer(location,this._vertexBufferDimensionDictionary[format],this._gl.FLOAT,!1,4*buffer.data32PerVertex,4*bufferOffset),void 0):(location>-1&&this._gl.disableVertexAttribArray(location),void 0)},ContextWebGL.prototype.setRenderToTexture=function(target,enableDepthAndStencil,antiAlias,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof antiAlias&&(antiAlias=0),"undefined"==typeof surfaceSelector&&(surfaceSelector=0);var texture=target,frameBuffer=texture.frameBuffer;this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,frameBuffer),enableDepthAndStencil&&(this._gl.enable(this._gl.STENCIL_TEST),this._gl.enable(this._gl.DEPTH_TEST)),this._gl.viewport(0,0,texture.width,texture.height)},ContextWebGL.prototype.setRenderToBackBuffer=function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)},ContextWebGL.prototype.updateBlendStatus=function(){this._blendEnabled?(this._gl.enable(this._gl.BLEND),this._gl.blendEquation(this._gl.FUNC_ADD),this._gl.blendFunc(this._blendSourceFactor,this._blendDestinationFactor)):this._gl.disable(this._gl.BLEND)},ContextWebGL.MAX_SAMPLERS=8,ContextWebGL.modulo=0,ContextWebGL}(stagegl.ContextGLBase);stagegl.ContextWebGL=ContextWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ResourceBaseFlash=function(){function ResourceBaseFlash(){}return Object.defineProperty(ResourceBaseFlash.prototype,"id",{get:function(){return this._pId},enumerable:!0,configurable:!0}),ResourceBaseFlash.prototype.dispose=function(){},ResourceBaseFlash}();stagegl.ResourceBaseFlash=ResourceBaseFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var TextureBaseWebGL=function(){function TextureBaseWebGL(gl){this.textureType="",this._gl=gl}return TextureBaseWebGL.prototype.dispose=function(){throw"Abstract method must be overridden."},Object.defineProperty(TextureBaseWebGL.prototype,"glTexture",{get:function(){throw new away.errors.AbstractMethodError},enumerable:!0,configurable:!0}),TextureBaseWebGL}();stagegl.TextureBaseWebGL=TextureBaseWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ByteArrayBase=away.utils.ByteArrayBase,CubeTextureFlash=function(_super){function CubeTextureFlash(context,size,format,forRTT,streaming){"undefined"==typeof streaming&&(streaming=!1),_super.call(this),this._context=context,this._size=size,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initCubeTexture,forRTT?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+size+","+streaming+","+format+"$"),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(CubeTextureFlash,_super),Object.defineProperty(CubeTextureFlash.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),CubeTextureFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeCubeTexture)+this._pId.toString()+","),this._context.execute(),this._context._iRemoveResource(this),this._context=null},CubeTextureFlash.prototype.uploadFromData=function(data,side,miplevel){if("undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData)data=data.imageData.data;else if(data instanceof HTMLImageElement){var can=document.createElement("canvas"),w=data.width,h=data.height;can.width=w,can.height=h;
var ctx=can.getContext("2d");ctx.drawImage(data,0,0),data=ctx.getImageData(0,0,w,h).data}var pos=0,bytes=ByteArrayBase.internalGetBase64String(data.length,function(){return data[pos++]},null);this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadBytesCubeTexture)+this._pId+","+miplevel+","+side+","+(this.size>>miplevel)+","+bytes+"%"),this._context.execute()},CubeTextureFlash.prototype.uploadCompressedTextureFromByteArray=function(data,byteArrayOffset,async){"undefined"==typeof async&&(async=!1)},CubeTextureFlash}(stagegl.ResourceBaseFlash);stagegl.CubeTextureFlash=CubeTextureFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var CubeTextureWebGL=function(_super){function CubeTextureWebGL(gl,size){_super.call(this,gl),this._textureSelectorDictionary=new Array(6),this.textureType="textureCube",this._size=size,this._texture=this._gl.createTexture(),this._textureSelectorDictionary[0]=gl.TEXTURE_CUBE_MAP_POSITIVE_X,this._textureSelectorDictionary[1]=gl.TEXTURE_CUBE_MAP_NEGATIVE_X,this._textureSelectorDictionary[2]=gl.TEXTURE_CUBE_MAP_POSITIVE_Y,this._textureSelectorDictionary[3]=gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,this._textureSelectorDictionary[4]=gl.TEXTURE_CUBE_MAP_POSITIVE_Z,this._textureSelectorDictionary[5]=gl.TEXTURE_CUBE_MAP_NEGATIVE_Z}return __extends(CubeTextureWebGL,_super),CubeTextureWebGL.prototype.dispose=function(){this._gl.deleteTexture(this._texture)},CubeTextureWebGL.prototype.uploadFromData=function(data,side,miplevel){"undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData&&(data=data.imageData),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,this._texture),this._gl.texImage2D(this._textureSelectorDictionary[side],miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null)},CubeTextureWebGL.prototype.uploadCompressedTextureFromByteArray=function(data,byteArrayOffset,async){"undefined"==typeof async&&(async=!1)},Object.defineProperty(CubeTextureWebGL.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(CubeTextureWebGL.prototype,"glTexture",{get:function(){return this._texture},enumerable:!0,configurable:!0}),CubeTextureWebGL}(stagegl.TextureBaseWebGL);stagegl.CubeTextureWebGL=CubeTextureWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(){}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var IndexBufferFlash=function(_super){function IndexBufferFlash(context,numIndices){_super.call(this),this._context=context,this._numIndices=numIndices,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initIndexBuffer,numIndices+away.stagegl.OpCodes.intMask)),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(IndexBufferFlash,_super),IndexBufferFlash.prototype.uploadFromArray=function(data,startOffset,count){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadArrayIndexBuffer,this._pId+away.stagegl.OpCodes.intMask)+data.join()+"#"+startOffset+","+count+","),this._context.execute()},IndexBufferFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeIndexBuffer,this._pId+away.stagegl.OpCodes.intMask)),this._context.execute(),this._context._iRemoveResource(this),this._context=null},Object.defineProperty(IndexBufferFlash.prototype,"numIndices",{get:function(){return this._numIndices},enumerable:!0,configurable:!0}),IndexBufferFlash}(stagegl.ResourceBaseFlash);stagegl.IndexBufferFlash=IndexBufferFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var IndexBufferWebGL=function(){function IndexBufferWebGL(gl,numIndices){this._gl=gl,this._buffer=this._gl.createBuffer(),this._numIndices=numIndices}return IndexBufferWebGL.prototype.uploadFromArray=function(data){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._buffer),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(data),this._gl.STATIC_DRAW)},IndexBufferWebGL.prototype.dispose=function(){this._gl.deleteBuffer(this._buffer)},Object.defineProperty(IndexBufferWebGL.prototype,"numIndices",{get:function(){return this._numIndices},enumerable:!0,configurable:!0}),Object.defineProperty(IndexBufferWebGL.prototype,"glBuffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),IndexBufferWebGL}();stagegl.IndexBufferWebGL=IndexBufferWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(){}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var OpCodes=function(){function OpCodes(){}return OpCodes.trueValue=32,OpCodes.falseValue=33,OpCodes.intMask=63,OpCodes.drawTriangles=41,OpCodes.setProgramConstant=42,OpCodes.setProgram=43,OpCodes.present=44,OpCodes.clear=45,OpCodes.initProgram=46,OpCodes.initVertexBuffer=47,OpCodes.initIndexBuffer=48,OpCodes.configureBackBuffer=49,OpCodes.uploadArrayIndexBuffer=50,OpCodes.uploadArrayVertexBuffer=51,OpCodes.uploadAGALBytesProgram=52,OpCodes.setVertexBufferAt=53,OpCodes.uploadBytesIndexBuffer=54,OpCodes.uploadBytesVertexBuffer=55,OpCodes.setColorMask=56,OpCodes.setDepthTest=57,OpCodes.disposeProgram=58,OpCodes.disposeContext=59,OpCodes.disposeVertexBuffer=61,OpCodes.disposeIndexBuffer=63,OpCodes.initTexture=64,OpCodes.setTextureAt=65,OpCodes.uploadBytesTexture=66,OpCodes.disposeTexture=67,OpCodes.setCulling=68,OpCodes.setScissorRect=69,OpCodes.clearScissorRect=70,OpCodes.setBlendFactors=71,OpCodes.setRenderToTexture=72,OpCodes.clearTextureAt=73,OpCodes.clearVertexBufferAt=74,OpCodes.setStencilActions=75,OpCodes.setStencilReferenceValue=76,OpCodes.initCubeTexture=77,OpCodes.disposeCubeTexture=78,OpCodes.uploadBytesCubeTexture=79,OpCodes.clearRenderToTexture=80,OpCodes.enableErrorChecking=81,OpCodes}();stagegl.OpCodes=OpCodes}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ProgramFlash=function(_super){function ProgramFlash(context){_super.call(this),this._context=context,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initProgram)),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(ProgramFlash,_super),ProgramFlash.prototype.upload=function(vertexProgram,fragmentProgram){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadAGALBytesProgram,this._pId+away.stagegl.OpCodes.intMask)+vertexProgram.readBase64String(vertexProgram.length)+"%"+fragmentProgram.readBase64String(fragmentProgram.length)+"%"),stagegl.ContextStage3D.debug&&this._context.execute()},ProgramFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeProgram,this._pId+away.stagegl.OpCodes.intMask)),this._context.execute(),this._context._iRemoveResource(this),this._context=null},ProgramFlash}(stagegl.ResourceBaseFlash);stagegl.ProgramFlash=ProgramFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ProgramWebGL=function(){function ProgramWebGL(gl){this._gl=gl,this._program=this._gl.createProgram()}return ProgramWebGL.prototype.upload=function(vertexProgram,fragmentProgram){var vertexString=ProgramWebGL._aglslParser.parse(ProgramWebGL._tokenizer.decribeAGALByteArray(vertexProgram)),fragmentString=ProgramWebGL._aglslParser.parse(ProgramWebGL._tokenizer.decribeAGALByteArray(fragmentProgram));if(this._vertexShader=this._gl.createShader(this._gl.VERTEX_SHADER),this._fragmentShader=this._gl.createShader(this._gl.FRAGMENT_SHADER),this._gl.shaderSource(this._vertexShader,vertexString),this._gl.compileShader(this._vertexShader),!this._gl.getShaderParameter(this._vertexShader,this._gl.COMPILE_STATUS))throw new Error(this._gl.getShaderInfoLog(this._vertexShader));if(this._gl.shaderSource(this._fragmentShader,fragmentString),this._gl.compileShader(this._fragmentShader),!this._gl.getShaderParameter(this._fragmentShader,this._gl.COMPILE_STATUS))throw new Error(this._gl.getShaderInfoLog(this._fragmentShader));if(this._gl.attachShader(this._program,this._vertexShader),this._gl.attachShader(this._program,this._fragmentShader),this._gl.linkProgram(this._program),!this._gl.getProgramParameter(this._program,this._gl.LINK_STATUS))throw new Error(this._gl.getProgramInfoLog(this._program))},ProgramWebGL.prototype.dispose=function(){this._gl.deleteProgram(this._program)},ProgramWebGL.prototype.focusProgram=function(){this._gl.useProgram(this._program)},Object.defineProperty(ProgramWebGL.prototype,"glProgram",{get:function(){return this._program},enumerable:!0,configurable:!0}),ProgramWebGL._tokenizer=new aglsl.AGALTokenizer,ProgramWebGL._aglslParser=new aglsl.AGLSLParser,ProgramWebGL}();stagegl.ProgramWebGL=ProgramWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var SamplerState=function(){function SamplerState(){}return SamplerState}();stagegl.SamplerState=SamplerState}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ByteArrayBase=away.utils.ByteArrayBase,TextureFlash=function(_super){function TextureFlash(context,width,height,format,forRTT,streaming){"undefined"==typeof streaming&&(streaming=!1),_super.call(this),this._context=context,this._width=width,this._height=height,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initTexture,forRTT?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+width+","+height+","+streaming+","+format+"$"),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(TextureFlash,_super),Object.defineProperty(TextureFlash.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(TextureFlash.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),TextureFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeTexture)+this._pId.toString()+","),this._context.execute(),this._context._iRemoveResource(this),this._context=null},TextureFlash.prototype.uploadFromData=function(data,miplevel){if("undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData)data=data.imageData.data;else if(data instanceof HTMLImageElement){var can=document.createElement("canvas"),w=data.width,h=data.height;can.width=w,can.height=h;var ctx=can.getContext("2d");ctx.drawImage(data,0,0),data=ctx.getImageData(0,0,w,h).data}var pos=0,bytes=ByteArrayBase.internalGetBase64String(data.length,function(){return data[pos++]},null);this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadBytesTexture)+this._pId+","+miplevel+","+(this._width>>miplevel)+","+(this._height>>miplevel)+","+bytes+"%"),this._context.execute()},TextureFlash}(stagegl.ResourceBaseFlash);stagegl.TextureFlash=TextureFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var TextureWebGL=function(_super){function TextureWebGL(gl,width,height){_super.call(this,gl),this.textureType="texture2d",this._width=width,this._height=height,this._glTexture=this._gl.createTexture()}return __extends(TextureWebGL,_super),TextureWebGL.prototype.dispose=function(){this._gl.deleteTexture(this._glTexture)},Object.defineProperty(TextureWebGL.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(TextureWebGL.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(TextureWebGL.prototype,"frameBuffer",{get:function(){if(!this._frameBuffer){this._frameBuffer=this._gl.createFramebuffer(),this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._frameBuffer),this._gl.bindTexture(this._gl.TEXTURE_2D,this._glTexture),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._width,this._height,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,null);var renderBuffer=this._gl.createRenderbuffer();this._gl.bindRenderbuffer(this._gl.RENDERBUFFER,renderBuffer),this._gl.renderbufferStorage(this._gl.RENDERBUFFER,this._gl.DEPTH_COMPONENT16,this._width,this._height),this._gl.framebufferTexture2D(this._gl.FRAMEBUFFER,this._gl.COLOR_ATTACHMENT0,this._gl.TEXTURE_2D,this._glTexture,0),this._gl.framebufferRenderbuffer(this._gl.FRAMEBUFFER,this._gl.DEPTH_ATTACHMENT,this._gl.RENDERBUFFER,renderBuffer),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindRenderbuffer(this._gl.RENDERBUFFER,null),this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)}return this._frameBuffer},enumerable:!0,configurable:!0}),TextureWebGL.prototype.uploadFromData=function(data,miplevel){"undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData&&(data=data.imageData),this._gl.bindTexture(this._gl.TEXTURE_2D,this._glTexture),this._gl.texImage2D(this._gl.TEXTURE_2D,miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data),this._gl.bindTexture(this._gl.TEXTURE_2D,null)},TextureWebGL.prototype.uploadCompressedTextureFromByteArray=function(data,byteArrayOffset,async){"undefined"==typeof async&&(async=!1);this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")},Object.defineProperty(TextureWebGL.prototype,"glTexture",{get:function(){return this._glTexture},enumerable:!0,configurable:!0}),TextureWebGL.prototype.generateMipmaps=function(){},TextureWebGL}(stagegl.TextureBaseWebGL);stagegl.TextureWebGL=TextureWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var VertexBufferFlash=function(_super){function VertexBufferFlash(context,numVertices,data32PerVertex){_super.call(this),this._context=context,this._numVertices=numVertices,this._data32PerVertex=data32PerVertex,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initVertexBuffer,data32PerVertex+away.stagegl.OpCodes.intMask)+numVertices.toString()+","),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(VertexBufferFlash,_super),VertexBufferFlash.prototype.uploadFromArray=function(data,startVertex,numVertices){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadArrayVertexBuffer,this._pId+away.stagegl.OpCodes.intMask)+data.join()+"#"+[startVertex,numVertices].join()+","),this._context.execute()},Object.defineProperty(VertexBufferFlash.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:!0,configurable:!0}),Object.defineProperty(VertexBufferFlash.prototype,"data32PerVertex",{get:function(){return this._data32PerVertex},enumerable:!0,configurable:!0}),VertexBufferFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeVertexBuffer,this._pId+away.stagegl.OpCodes.intMask)),this._context.execute(),this._context._iRemoveResource(this),this._context=null},VertexBufferFlash}(stagegl.ResourceBaseFlash);stagegl.VertexBufferFlash=VertexBufferFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var VertexBufferWebGL=function(){function VertexBufferWebGL(gl,numVertices,data32PerVertex){this._gl=gl,this._buffer=this._gl.createBuffer(),this._numVertices=numVertices,this._data32PerVertex=data32PerVertex}return VertexBufferWebGL.prototype.uploadFromArray=function(vertices){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(vertices),this._gl.STATIC_DRAW)},Object.defineProperty(VertexBufferWebGL.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:!0,configurable:!0}),Object.defineProperty(VertexBufferWebGL.prototype,"data32PerVertex",{get:function(){return this._data32PerVertex},enumerable:!0,configurable:!0}),Object.defineProperty(VertexBufferWebGL.prototype,"glBuffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),VertexBufferWebGL.prototype.dispose=function(){this._gl.deleteBuffer(this._buffer)},VertexBufferWebGL}();stagegl.VertexBufferWebGL=VertexBufferWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(managers){var StageEvent=away.events.StageEvent,AGALProgramCache=function(){function AGALProgramCache(stage,agalProgramCacheSingletonEnforcer){if(!agalProgramCacheSingletonEnforcer)throw new Error("This class is a multiton and cannot be instantiated manually. Use StageManager.getInstance instead.");this._stage=stage,this._program3Ds=new Object,this._ids=new Object,this._usages=new Object,this._keys=new Object}return AGALProgramCache.getInstance=function(stage){var index=stage.stageIndex;return null==AGALProgramCache._instances&&(AGALProgramCache._instances=new Array(8)),AGALProgramCache._instances[index]||(AGALProgramCache._instances[index]=new AGALProgramCache(stage,new AGALProgramCacheSingletonEnforcer),stage.addEventListener(StageEvent.CONTEXT_DISPOSED,AGALProgramCache.onContextGLDisposed),stage.addEventListener(StageEvent.CONTEXT_CREATED,AGALProgramCache.onContextGLDisposed),stage.addEventListener(StageEvent.CONTEXT_RECREATED,AGALProgramCache.onContextGLDisposed)),AGALProgramCache._instances[index]},AGALProgramCache.getInstanceFromIndex=function(index){if(!AGALProgramCache._instances[index])throw new Error("Instance not created yet!");return AGALProgramCache._instances[index]},AGALProgramCache.onContextGLDisposed=function(event){var stage=event.target,index=stage.stageIndex;AGALProgramCache._instances[index].dispose(),AGALProgramCache._instances[index]=null,stage.removeEventListener(StageEvent.CONTEXT_DISPOSED,AGALProgramCache.onContextGLDisposed),stage.removeEventListener(StageEvent.CONTEXT_CREATED,AGALProgramCache.onContextGLDisposed),stage.removeEventListener(StageEvent.CONTEXT_RECREATED,AGALProgramCache.onContextGLDisposed)},AGALProgramCache.prototype.dispose=function(){for(var key in this._program3Ds)this.destroyProgram(key);this._keys=null,this._program3Ds=null,this._usages=null},AGALProgramCache.prototype.setProgram=function(programIds,programs,vertexCode,fragmentCode){var program,stageIndex=this._stage.stageIndex,key=this.getKey(vertexCode,fragmentCode);if(null==this._program3Ds[key]){this._keys[AGALProgramCache._currentId]=key,this._usages[AGALProgramCache._currentId]=0,this._ids[key]=AGALProgramCache._currentId,++AGALProgramCache._currentId,program=this._stage.context.createProgram();var vertexByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part vertex 1\n"+vertexCode+"endpart").vertex.data,fragmentByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part fragment 1\n"+fragmentCode+"endpart").fragment.data;program.upload(vertexByteCode,fragmentByteCode),this._program3Ds[key]=program}var oldId=programIds[stageIndex],newId=this._ids[key];oldId!=newId&&(oldId>=0&&this.freeProgram(oldId),this._usages[newId]++),programIds[stageIndex]=newId,programs[stageIndex]=this._program3Ds[key]},AGALProgramCache.prototype.freeProgram=function(programId){this._usages[programId]--,0==this._usages[programId]&&this.destroyProgram(this._keys[programId])},AGALProgramCache.prototype.destroyProgram=function(key){this._program3Ds[key].dispose(),this._program3Ds[key]=null,delete this._program3Ds[key],this._ids[key]=-1},AGALProgramCache.prototype.getKey=function(vertexCode,fragmentCode){return vertexCode+"---"+fragmentCode},AGALProgramCache._currentId=0,AGALProgramCache}();managers.AGALProgramCache=AGALProgramCache}(away.managers||(away.managers={}));away.managers}(away||(away={}));var AGALProgramCacheSingletonEnforcer=function(){function AGALProgramCacheSingletonEnforcer(){}return AGALProgramCacheSingletonEnforcer}(),away;!function(away){!function(managers){var RTTBufferManager=function(_super){function RTTBufferManager(se,stage){if(_super.call(this),this._viewWidth=-1,this._viewHeight=-1,this._textureWidth=-1,this._textureHeight=-1,this._buffersInvalid=!0,!se)throw new Error("No cheating the multiton!");this._renderToTextureRect=new away.geom.Rectangle,this._stage=stage}return __extends(RTTBufferManager,_super),RTTBufferManager.getInstance=function(stage){if(!stage)throw new Error("stage key cannot be null!");null==RTTBufferManager._instances&&(RTTBufferManager._instances=new Array);var rttBufferManager=RTTBufferManager.getRTTBufferManagerFromStage(stage);if(null==rttBufferManager){rttBufferManager=new RTTBufferManager(new SingletonEnforcer,stage);var vo=new RTTBufferManagerVO;vo.stage3d=stage,vo.rttbfm=rttBufferManager,RTTBufferManager._instances.push(vo)}return rttBufferManager},RTTBufferManager.getRTTBufferManagerFromStage=function(stage){for(var r,l=RTTBufferManager._instances.length,c=0;l>c;c++)if(r=RTTBufferManager._instances[c],r.stage3d===stage)return r.rttbfm;return null},RTTBufferManager.deleteRTTBufferManager=function(stage){for(var r,l=RTTBufferManager._instances.length,c=0;l>c;c++)if(r=RTTBufferManager._instances[c],r.stage3d===stage)return RTTBufferManager._instances.splice(c,1),void 0},Object.defineProperty(RTTBufferManager.prototype,"textureRatioX",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._textureRatioX},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"textureRatioY",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._textureRatioY},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"viewWidth",{get:function(){return this._viewWidth},set:function(value){value!=this._viewWidth&&(this._viewWidth=value,this._buffersInvalid=!0,this._textureWidth=away.utils.TextureUtils.getBestPowerOf2(this._viewWidth),this._textureWidth>this._viewWidth?(this._renderToTextureRect.x=Math.floor(.5*(this._textureWidth-this._viewWidth)),this._renderToTextureRect.width=this._viewWidth):(this._renderToTextureRect.x=0,this._renderToTextureRect.width=this._textureWidth),this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE)))},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"viewHeight",{get:function(){return this._viewHeight},set:function(value){value!=this._viewHeight&&(this._viewHeight=value,this._buffersInvalid=!0,this._textureHeight=away.utils.TextureUtils.getBestPowerOf2(this._viewHeight),this._textureHeight>this._viewHeight?(this._renderToTextureRect.y=Math.floor(.5*(this._textureHeight-this._viewHeight)),this._renderToTextureRect.height=this._viewHeight):(this._renderToTextureRect.y=0,this._renderToTextureRect.height=this._textureHeight),this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE)))},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"renderToTextureVertexBuffer",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._renderToTextureVertexBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"renderToScreenVertexBuffer",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._renderToScreenVertexBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"renderToTextureRect",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._renderToTextureRect},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"textureWidth",{get:function(){return this._textureWidth},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"textureHeight",{get:function(){return this._textureHeight},enumerable:!0,configurable:!0}),RTTBufferManager.prototype.dispose=function(){RTTBufferManager.deleteRTTBufferManager(this._stage),this._indexBuffer&&(this._indexBuffer.dispose(),this._renderToScreenVertexBuffer.dispose(),this._renderToTextureVertexBuffer.dispose(),this._renderToScreenVertexBuffer=null,this._renderToTextureVertexBuffer=null,this._indexBuffer=null)},RTTBufferManager.prototype.updateRTTBuffers=function(){var textureVerts,screenVerts,x,y,context=this._stage.context;null==this._renderToTextureVertexBuffer&&(this._renderToTextureVertexBuffer=context.createVertexBuffer(4,5)),null==this._renderToScreenVertexBuffer&&(this._renderToScreenVertexBuffer=context.createVertexBuffer(4,5)),this._indexBuffer||(this._indexBuffer=context.createIndexBuffer(6),this._indexBuffer.uploadFromArray([2,1,0,3,2,0],0,6)),this._textureRatioX=x=Math.min(this._viewWidth/this._textureWidth,1),this._textureRatioY=y=Math.min(this._viewHeight/this._textureHeight,1);var u1=.5*(1-x),u2=.5*(x+1),v1=.5*(y+1),v2=.5*(1-y);textureVerts=[-x,-y,u1,v1,0,x,-y,u2,v1,1,x,y,u2,v2,2,-x,y,u1,v2,3],screenVerts=[-1,-1,u1,v1,0,1,-1,u2,v1,1,1,1,u2,v2,2,-1,1,u1,v2,3],this._renderToTextureVertexBuffer.uploadFromArray(textureVerts,0,4),this._renderToScreenVertexBuffer.uploadFromArray(screenVerts,0,4),this._buffersInvalid=!1},RTTBufferManager}(away.events.EventDispatcher);managers.RTTBufferManager=RTTBufferManager;var RTTBufferManagerVO=function(){function RTTBufferManagerVO(){}return RTTBufferManagerVO}()}(away.managers||(away.managers={}));away.managers}(away||(away={}));var SingletonEnforcer=function(){function SingletonEnforcer(){}return SingletonEnforcer}(),away;!function(away){!function(materials){var TriangleSubGeometry=away.base.TriangleSubGeometry,ShaderObjectBase=function(){function ShaderObjectBase(profile){this._pInverseSceneMatrix=new Array,this.ambientR=255,this.ambientG=255,this.ambientB=255,this.usesGlobalPosFragment=!1,this.vertexConstantData=new Array,this.fragmentConstantData=new Array,this.profile=profile}return ShaderObjectBase.prototype.createCompiler=function(materialPassVO){return new materials.ShaderCompilerBase(materialPassVO,this)},ShaderObjectBase.prototype.reset=function(){this.projectionDependencies=0,this.normalDependencies=0,this.viewDirDependencies=0,this.uvDependencies=0,this.secondaryUVDependencies=0,this.globalPosDependencies=0,this.tangentDependencies=0,this.usesGlobalPosFragment=!1,this.usesFragmentAnimation=!1,this.usesTangentSpace=!1,this.outputsNormals=!1,this.outputsTangentNormals=!1},ShaderObjectBase.prototype.addWorldSpaceDependencies=function(){this.viewDirDependencies>0&&++this.globalPosDependencies},ShaderObjectBase.prototype.pInitRegisterIndices=function(){this.commonsDataIndex=-1,this.cameraPositionIndex=-1,this.uvBufferIndex=-1,this.uvTransformIndex=-1,this.secondaryUVBufferIndex=-1,this.normalBufferIndex=-1,this.tangentBufferIndex=-1,this.sceneMatrixIndex=-1,this.sceneNormalMatrixIndex=-1},ShaderObjectBase.prototype.initConstantData=function(registerCache,animatableAttributes,animationTargetRegisters,uvSource,uvTarget){this.numUsedVertexConstants=registerCache.numUsedVertexConstants,this.numUsedFragmentConstants=registerCache.numUsedFragmentConstants,this.numUsedStreams=registerCache.numUsedStreams,this.numUsedTextures=registerCache.numUsedTextures,this.numUsedVaryings=registerCache.numUsedVaryings,this.numUsedFragmentConstants=registerCache.numUsedFragmentConstants,this.animatableAttributes=animatableAttributes,this.animationTargetRegisters=animationTargetRegisters,this.uvSource=uvSource,this.uvTarget=uvTarget,this.vertexConstantData.length=4*this.numUsedVertexConstants,this.fragmentConstantData.length=4*this.numUsedFragmentConstants,this.fragmentConstantData[this.commonsDataIndex]=.5,this.fragmentConstantData[this.commonsDataIndex+1]=0,this.fragmentConstantData[this.commonsDataIndex+2]=1/255,this.fragmentConstantData[this.commonsDataIndex+3]=1,this.uvTransformIndex>=0&&(this.vertexConstantData[this.uvTransformIndex]=1,this.vertexConstantData[this.uvTransformIndex+1]=0,this.vertexConstantData[this.uvTransformIndex+2]=0,this.vertexConstantData[this.uvTransformIndex+3]=0,this.vertexConstantData[this.uvTransformIndex+4]=0,this.vertexConstantData[this.uvTransformIndex+5]=1,this.vertexConstantData[this.uvTransformIndex+6]=0,this.vertexConstantData[this.uvTransformIndex+7]=0),this.cameraPositionIndex>=0&&(this.vertexConstantData[this.cameraPositionIndex+3]=1)},ShaderObjectBase.prototype.iActivate=function(stage,camera){if(!this.usesTangentSpace&&this.cameraPositionIndex>=0){var pos=camera.scenePosition;this.vertexConstantData[this.cameraPositionIndex]=pos.x,this.vertexConstantData[this.cameraPositionIndex+1]=pos.y,this.vertexConstantData[this.cameraPositionIndex+2]=pos.z}},ShaderObjectBase.prototype.iDeactivate=function(){},ShaderObjectBase.prototype.setRenderState=function(renderable,stage,camera){var context=stage.context;if(renderable.materialOwner.animator&&renderable.materialOwner.animator.setRenderState(this,renderable,stage,camera,this.numUsedVertexConstants,this.numUsedStreams),this.uvBufferIndex>=0&&context.activateBuffer(this.uvBufferIndex,renderable.getVertexData(TriangleSubGeometry.UV_DATA),renderable.getVertexOffset(TriangleSubGeometry.UV_DATA),TriangleSubGeometry.UV_FORMAT),this.secondaryUVBufferIndex>=0&&context.activateBuffer(this.secondaryUVBufferIndex,renderable.getVertexData(TriangleSubGeometry.SECONDARY_UV_DATA),renderable.getVertexOffset(TriangleSubGeometry.SECONDARY_UV_DATA),TriangleSubGeometry.SECONDARY_UV_FORMAT),this.normalBufferIndex>=0&&context.activateBuffer(this.normalBufferIndex,renderable.getVertexData(TriangleSubGeometry.NORMAL_DATA),renderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA),TriangleSubGeometry.NORMAL_FORMAT),this.tangentBufferIndex>=0&&context.activateBuffer(this.tangentBufferIndex,renderable.getVertexData(TriangleSubGeometry.TANGENT_DATA),renderable.getVertexOffset(TriangleSubGeometry.TANGENT_DATA),TriangleSubGeometry.TANGENT_FORMAT),this.usesUVTransform){var uvTransform=renderable.materialOwner.uvTransform.matrix;uvTransform?(this.vertexConstantData[this.uvTransformIndex]=uvTransform.a,this.vertexConstantData[this.uvTransformIndex+1]=uvTransform.b,this.vertexConstantData[this.uvTransformIndex+3]=uvTransform.tx,this.vertexConstantData[this.uvTransformIndex+4]=uvTransform.c,this.vertexConstantData[this.uvTransformIndex+5]=uvTransform.d,this.vertexConstantData[this.uvTransformIndex+7]=uvTransform.ty):(this.vertexConstantData[this.uvTransformIndex]=1,this.vertexConstantData[this.uvTransformIndex+1]=0,this.vertexConstantData[this.uvTransformIndex+3]=0,this.vertexConstantData[this.uvTransformIndex+4]=0,this.vertexConstantData[this.uvTransformIndex+5]=1,this.vertexConstantData[this.uvTransformIndex+7]=0)}if(this.sceneNormalMatrixIndex>=0&&renderable.sourceEntity.inverseSceneTransform.copyRawDataTo(this.vertexConstantData,this.sceneNormalMatrixIndex,!1),this.usesTangentSpace&&this.cameraPositionIndex>=0){renderable.sourceEntity.inverseSceneTransform.copyRawDataTo(this._pInverseSceneMatrix);var pos=camera.scenePosition,x=pos.x,y=pos.y,z=pos.z;this.vertexConstantData[this.cameraPositionIndex]=this._pInverseSceneMatrix[0]*x+this._pInverseSceneMatrix[4]*y+this._pInverseSceneMatrix[8]*z+this._pInverseSceneMatrix[12],this.vertexConstantData[this.cameraPositionIndex+1]=this._pInverseSceneMatrix[1]*x+this._pInverseSceneMatrix[5]*y+this._pInverseSceneMatrix[9]*z+this._pInverseSceneMatrix[13],this.vertexConstantData[this.cameraPositionIndex+2]=this._pInverseSceneMatrix[2]*x+this._pInverseSceneMatrix[6]*y+this._pInverseSceneMatrix[10]*z+this._pInverseSceneMatrix[14]}},ShaderObjectBase.prototype.dispose=function(){},ShaderObjectBase}();materials.ShaderObjectBase=ShaderObjectBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShaderLightingObject=function(_super){function ShaderLightingObject(profile){_super.call(this,profile)}return __extends(ShaderLightingObject,_super),ShaderLightingObject.prototype.createCompiler=function(materialPassVO){return new materials.ShaderLightingCompiler(materialPassVO,this)},ShaderLightingObject.prototype.reset=function(){_super.prototype.reset.call(this),this.numLights=0,this.usesLightFallOff=!0
},ShaderLightingObject.prototype.addWorldSpaceDependencies=function(fragmentLights){_super.prototype.addWorldSpaceDependencies.call(this,fragmentLights),this.numPointLights>0&&this.usesLights&&(++this.globalPosDependencies,fragmentLights&&(this.usesGlobalPosFragment=!0))},ShaderLightingObject.prototype.setRenderState=function(renderable,stage,camera,viewProjection){_super.prototype.setRenderState.call(this,renderable,stage,camera,viewProjection),this.usesLights&&this.updateLights(),this.usesProbes&&this.updateProbes(stage)},ShaderLightingObject.prototype.updateLights=function(){var dirLight,pointLight,len,dirPos,l,offset,i=0,k=0,total=0,numLightTypes=this.usesShadows?2:1;this.ambientR=this.ambientG=this.ambientB=0,l=this.lightVertexConstantIndex,k=this.lightFragmentConstantIndex;var cast=0,dirLights=this.lightPicker.directionalLights;for(offset=this.directionalLightsOffset,len=this.lightPicker.directionalLights.length,offset>len&&(cast=1,offset-=len);numLightTypes>cast;++cast)for(cast&&(dirLights=this.lightPicker.castingDirectionalLights),len=dirLights.length,len>this.numDirectionalLights&&(len=this.numDirectionalLights),i=0;len>i;++i){if(dirLight=dirLights[offset+i],dirPos=dirLight.sceneDirection,this.ambientR+=dirLight._iAmbientR,this.ambientG+=dirLight._iAmbientG,this.ambientB+=dirLight._iAmbientB,this.usesTangentSpace){var x=-dirPos.x,y=-dirPos.y,z=-dirPos.z;this.vertexConstantData[l++]=this._pInverseSceneMatrix[0]*x+this._pInverseSceneMatrix[4]*y+this._pInverseSceneMatrix[8]*z,this.vertexConstantData[l++]=this._pInverseSceneMatrix[1]*x+this._pInverseSceneMatrix[5]*y+this._pInverseSceneMatrix[9]*z,this.vertexConstantData[l++]=this._pInverseSceneMatrix[2]*x+this._pInverseSceneMatrix[6]*y+this._pInverseSceneMatrix[10]*z,this.vertexConstantData[l++]=1}else this.fragmentConstantData[k++]=-dirPos.x,this.fragmentConstantData[k++]=-dirPos.y,this.fragmentConstantData[k++]=-dirPos.z,this.fragmentConstantData[k++]=1;this.fragmentConstantData[k++]=dirLight._iDiffuseR,this.fragmentConstantData[k++]=dirLight._iDiffuseG,this.fragmentConstantData[k++]=dirLight._iDiffuseB,this.fragmentConstantData[k++]=1,this.fragmentConstantData[k++]=dirLight._iSpecularR,this.fragmentConstantData[k++]=dirLight._iSpecularG,this.fragmentConstantData[k++]=dirLight._iSpecularB,this.fragmentConstantData[k++]=1,++total==this.numDirectionalLights&&(i=len,cast=numLightTypes)}if(this.numDirectionalLights>total)for(i=k+12*(this.numDirectionalLights-total);i>k;)this.fragmentConstantData[k++]=0;total=0;var pointLights=this.lightPicker.pointLights;for(offset=this.pointLightsOffset,len=this.lightPicker.pointLights.length,offset>len?(cast=1,offset-=len):cast=0;numLightTypes>cast;++cast)for(cast&&(pointLights=this.lightPicker.castingPointLights),len=pointLights.length,i=0;len>i;++i){pointLight=pointLights[offset+i],dirPos=pointLight.scenePosition,this.ambientR+=pointLight._iAmbientR,this.ambientG+=pointLight._iAmbientG,this.ambientB+=pointLight._iAmbientB,this.usesTangentSpace?(x=dirPos.x,y=dirPos.y,z=dirPos.z,this.vertexConstantData[l++]=this._pInverseSceneMatrix[0]*x+this._pInverseSceneMatrix[4]*y+this._pInverseSceneMatrix[8]*z+this._pInverseSceneMatrix[12],this.vertexConstantData[l++]=this._pInverseSceneMatrix[1]*x+this._pInverseSceneMatrix[5]*y+this._pInverseSceneMatrix[9]*z+this._pInverseSceneMatrix[13],this.vertexConstantData[l++]=this._pInverseSceneMatrix[2]*x+this._pInverseSceneMatrix[6]*y+this._pInverseSceneMatrix[10]*z+this._pInverseSceneMatrix[14],this.vertexConstantData[l++]=1):this.usesGlobalPosFragment?(this.fragmentConstantData[k++]=dirPos.x,this.fragmentConstantData[k++]=dirPos.y,this.fragmentConstantData[k++]=dirPos.z,this.fragmentConstantData[k++]=1):(this.vertexConstantData[l++]=dirPos.x,this.vertexConstantData[l++]=dirPos.y,this.vertexConstantData[l++]=dirPos.z,this.vertexConstantData[l++]=1),this.fragmentConstantData[k++]=pointLight._iDiffuseR,this.fragmentConstantData[k++]=pointLight._iDiffuseG,this.fragmentConstantData[k++]=pointLight._iDiffuseB;var radius=pointLight._pRadius;this.fragmentConstantData[k++]=radius*radius,this.fragmentConstantData[k++]=pointLight._iSpecularR,this.fragmentConstantData[k++]=pointLight._iSpecularG,this.fragmentConstantData[k++]=pointLight._iSpecularB,this.fragmentConstantData[k++]=pointLight._pFallOffFactor,++total==this.numPointLights&&(i=len,cast=numLightTypes)}if(this.numPointLights>total)for(i=k+12*(total-this.numPointLights);i>k;++k)this.fragmentConstantData[k]=0},ShaderLightingObject.prototype.updateProbes=function(stage){var probe,lightProbes=this.lightPicker.lightProbes,weights=this.lightPicker.lightProbeWeights,len=lightProbes.length-this.lightProbesOffset,addDiff=this.usesProbesForDiffuse,addSpec=this.usesProbesForSpecular;if(addDiff||addSpec){len>this.numLightProbes&&(len=this.numLightProbes);for(var i=0;len>i;++i)probe=lightProbes[this.lightProbesOffset+i],addDiff&&stage.context.activateCubeTexture(this.lightProbeDiffuseIndices[i],probe.diffuseMap),addSpec&&stage.context.activateCubeTexture(this.lightProbeSpecularIndices[i],probe.specularMap);for(i=0;len>i;++i)this.fragmentConstantData[this.probeWeightsIndex+i]=weights[this.lightProbesOffset+i]}},ShaderLightingObject}(materials.ShaderObjectBase);materials.ShaderLightingObject=ShaderLightingObject}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var MethodVO=function(){function MethodVO(method){this.useMethod=!0,this.method=method}return MethodVO.prototype.reset=function(){this.method.iReset(),this.texturesIndex=-1,this.vertexConstantsIndex=-1,this.fragmentConstantsIndex=-1,this.needsProjection=!1,this.needsView=!1,this.needsNormals=!1,this.needsTangents=!1,this.needsUV=!1,this.needsSecondaryUV=!1,this.needsGlobalVertexPos=!1,this.needsGlobalFragmentPos=!1},MethodVO}();materials.MethodVO=MethodVO}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var RegisterPool=function(){function RegisterPool(regName,regCount,persistent){"undefined"==typeof persistent&&(persistent=!0),this._regName=regName,this._regCount=regCount,this._persistent=persistent,this.initRegisters(regName,regCount)}return RegisterPool.prototype.requestFreeVectorReg=function(){for(var i=0;i<this._regCount;++i)if(!this.isRegisterUsed(i))return this._persistent&&this._usedVectorCount[i]++,this._vectorRegisters[i];throw new Error("Register overflow!")},RegisterPool.prototype.requestFreeRegComponent=function(){for(var i=0;i<this._regCount;++i)if(!(this._usedVectorCount[i]>0))for(var j=0;4>j;++j)if(0==this._usedSingleCount[j][i])return this._persistent&&this._usedSingleCount[j][i]++,this._registerComponents[j][i];throw new Error("Register overflow!")},RegisterPool.prototype.addUsage=function(register,usageCount){register._component>-1?this._usedSingleCount[register._component][register.index]+=usageCount:this._usedVectorCount[register.index]+=usageCount},RegisterPool.prototype.removeUsage=function(register){if(register._component>-1){if(--this._usedSingleCount[register._component][register.index]<0)throw new Error("More usages removed than exist!")}else if(--this._usedVectorCount[register.index]<0)throw new Error("More usages removed than exist!")},RegisterPool.prototype.dispose=function(){this._vectorRegisters=null,this._registerComponents=null,this._usedSingleCount=null,this._usedVectorCount=null},RegisterPool.prototype.hasRegisteredRegs=function(){for(var i=0;i<this._regCount;++i)if(this.isRegisterUsed(i))return!0;return!1},RegisterPool.prototype.initRegisters=function(regName,regCount){var hash=RegisterPool._initPool(regName,regCount);this._vectorRegisters=RegisterPool._regPool[hash],this._registerComponents=RegisterPool._regCompsPool[hash],this._usedVectorCount=this._initArray(Array(regCount),0),this._usedSingleCount=new Array(4),this._usedSingleCount[0]=this._initArray(new Array(regCount),0),this._usedSingleCount[1]=this._initArray(new Array(regCount),0),this._usedSingleCount[2]=this._initArray(new Array(regCount),0),this._usedSingleCount[3]=this._initArray(new Array(regCount),0)},RegisterPool._initPool=function(regName,regCount){var hash=regName+regCount;if(void 0!=RegisterPool._regPool[hash])return hash;var vectorRegisters=new Array(regCount);RegisterPool._regPool[hash]=vectorRegisters;var registerComponents=[[],[],[],[]];RegisterPool._regCompsPool[hash]=registerComponents;for(var i=0;regCount>i;++i){vectorRegisters[i]=new materials.ShaderRegisterElement(regName,i);for(var j=0;4>j;++j)registerComponents[j][i]=new materials.ShaderRegisterElement(regName,i,j)}return hash},RegisterPool.prototype.isRegisterUsed=function(index){if(this._usedVectorCount[index]>0)return!0;for(var i=0;4>i;++i)if(this._usedSingleCount[i][index]>0)return!0;return!1},RegisterPool.prototype._initArray=function(a,val){for(var l=a.length,c=0;l>c;c++)a[c]=val;return a},RegisterPool._regPool=new Object,RegisterPool._regCompsPool=new Object,RegisterPool}();materials.RegisterPool=RegisterPool}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShaderRegisterCache=function(){function ShaderRegisterCache(profile){this._numUsedVertexConstants=0,this._numUsedFragmentConstants=0,this._numUsedStreams=0,this._numUsedTextures=0,this._numUsedVaryings=0,this._profile=profile}return ShaderRegisterCache.prototype.reset=function(){this._fragmentTempCache=new materials.RegisterPool("ft",8,!1),this._vertexTempCache=new materials.RegisterPool("vt",8,!1),this._varyingCache=new materials.RegisterPool("v",8),this._textureCache=new materials.RegisterPool("fs",8),this._vertexAttributesCache=new materials.RegisterPool("va",8),this._fragmentConstantsCache=new materials.RegisterPool("fc",28),this._vertexConstantsCache=new materials.RegisterPool("vc",128),this._fragmentOutputRegister=new materials.ShaderRegisterElement("oc",-1),this._vertexOutputRegister=new materials.ShaderRegisterElement("op",-1),this._numUsedVertexConstants=0,this._numUsedStreams=0,this._numUsedTextures=0,this._numUsedVaryings=0,this._numUsedFragmentConstants=0;var i;for(i=0;i<this._vertexAttributesOffset;++i)this.getFreeVertexAttribute();for(i=0;i<this._vertexConstantOffset;++i)this.getFreeVertexConstant();for(i=0;i<this._varyingsOffset;++i)this.getFreeVarying();for(i=0;i<this._fragmentConstantOffset;++i)this.getFreeFragmentConstant()},ShaderRegisterCache.prototype.dispose=function(){this._fragmentTempCache.dispose(),this._vertexTempCache.dispose(),this._varyingCache.dispose(),this._fragmentConstantsCache.dispose(),this._vertexAttributesCache.dispose(),this._fragmentTempCache=null,this._vertexTempCache=null,this._varyingCache=null,this._fragmentConstantsCache=null,this._vertexAttributesCache=null,this._fragmentOutputRegister=null,this._vertexOutputRegister=null},ShaderRegisterCache.prototype.addFragmentTempUsages=function(register,usageCount){this._fragmentTempCache.addUsage(register,usageCount)},ShaderRegisterCache.prototype.removeFragmentTempUsage=function(register){this._fragmentTempCache.removeUsage(register)},ShaderRegisterCache.prototype.addVertexTempUsages=function(register,usageCount){this._vertexTempCache.addUsage(register,usageCount)},ShaderRegisterCache.prototype.removeVertexTempUsage=function(register){this._vertexTempCache.removeUsage(register)},ShaderRegisterCache.prototype.getFreeFragmentVectorTemp=function(){return this._fragmentTempCache.requestFreeVectorReg()},ShaderRegisterCache.prototype.getFreeFragmentSingleTemp=function(){return this._fragmentTempCache.requestFreeRegComponent()},ShaderRegisterCache.prototype.getFreeVarying=function(){return++this._numUsedVaryings,this._varyingCache.requestFreeVectorReg()},ShaderRegisterCache.prototype.getFreeFragmentConstant=function(){return++this._numUsedFragmentConstants,this._fragmentConstantsCache.requestFreeVectorReg()},ShaderRegisterCache.prototype.getFreeVertexConstant=function(){return++this._numUsedVertexConstants,this._vertexConstantsCache.requestFreeVectorReg()},ShaderRegisterCache.prototype.getFreeVertexVectorTemp=function(){return this._vertexTempCache.requestFreeVectorReg()},ShaderRegisterCache.prototype.getFreeVertexSingleTemp=function(){return this._vertexTempCache.requestFreeRegComponent()},ShaderRegisterCache.prototype.getFreeVertexAttribute=function(){return++this._numUsedStreams,this._vertexAttributesCache.requestFreeVectorReg()},ShaderRegisterCache.prototype.getFreeTextureReg=function(){return++this._numUsedTextures,this._textureCache.requestFreeVectorReg()},Object.defineProperty(ShaderRegisterCache.prototype,"vertexConstantOffset",{get:function(){return this._vertexConstantOffset},set:function(vertexConstantOffset){this._vertexConstantOffset=vertexConstantOffset},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"vertexAttributesOffset",{get:function(){return this._vertexAttributesOffset},set:function(value){this._vertexAttributesOffset=value},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"varyingsOffset",{get:function(){return this._varyingsOffset},set:function(value){this._varyingsOffset=value},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"fragmentConstantOffset",{get:function(){return this._fragmentConstantOffset},set:function(value){this._fragmentConstantOffset=value},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"fragmentOutputRegister",{get:function(){return this._fragmentOutputRegister},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"numUsedVertexConstants",{get:function(){return this._numUsedVertexConstants},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"numUsedFragmentConstants",{get:function(){return this._numUsedFragmentConstants},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"numUsedStreams",{get:function(){return this._numUsedStreams},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"numUsedTextures",{get:function(){return this._numUsedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterCache.prototype,"numUsedVaryings",{get:function(){return this._numUsedVaryings},enumerable:!0,configurable:!0}),ShaderRegisterCache}();materials.ShaderRegisterCache=ShaderRegisterCache}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShaderRegisterElement=function(){function ShaderRegisterElement(regName,index,component){"undefined"==typeof component&&(component=-1),this._component=component,this._regName=regName,this._index=index,this._toStr=this._regName,this._index>=0&&(this._toStr+=this._index),component>-1&&(this._toStr+="."+ShaderRegisterElement.COMPONENTS[component])}return ShaderRegisterElement.prototype.toString=function(){return this._toStr},Object.defineProperty(ShaderRegisterElement.prototype,"regName",{get:function(){return this._regName},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderRegisterElement.prototype,"index",{get:function(){return this._index},enumerable:!0,configurable:!0}),ShaderRegisterElement.COMPONENTS=["x","y","z","w"],ShaderRegisterElement}();materials.ShaderRegisterElement=ShaderRegisterElement}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShaderCompilerBase=function(){function ShaderCompilerBase(materialPassVO,shaderObject){this._pVertexCode="",this._pFragmentCode="",this._pPostAnimationFragmentCode="",this._pMaterialPass=materialPassVO.materialPass,this._pMaterial=materialPassVO.material,this._pShaderObject=shaderObject,this._pProfile=shaderObject.profile,this._pSharedRegisters=new materials.ShaderRegisterData,this._pRegisterCache=new materials.ShaderRegisterCache(this._pProfile),this._pRegisterCache.vertexAttributesOffset=1,this._pRegisterCache.reset()}return ShaderCompilerBase.prototype.compile=function(){this._pShaderObject.reset(),this.pCalculateDependencies(),this.pInitRegisterIndices(),this.pCompileDependencies(),this._pVertexCode+=this._pMaterialPass._iGetVertexCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters),this._pPostAnimationFragmentCode+=this._pMaterialPass._iGetFragmentCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters),this._pPostAnimationFragmentCode+="mov "+this._pRegisterCache.fragmentOutputRegister+", "+this._pSharedRegisters.shadedTarget+"\n",this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.shadedTarget),this._pShaderObject.initConstantData(this._pRegisterCache,this._pAnimatableAttributes,this._pAnimationTargetRegisters,this._uvSource,this._uvTarget),this._pMaterialPass._iInitConstantData(this._pShaderObject)},ShaderCompilerBase.prototype.pCompileDependencies=function(){this._pSharedRegisters.shadedTarget=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.shadedTarget,1),(this._pShaderObject.globalPosDependencies>0||this._pMaterialPass.forceSeparateMVP)&&this.compileGlobalPositionCode(),this._pShaderObject.uvDependencies>0&&this.compileUVCode(),this._pShaderObject.secondaryUVDependencies>0&&this.compileSecondaryUVCode(),this._pShaderObject.normalDependencies>0&&this.compileNormalCode(),this._pShaderObject.viewDirDependencies>0&&this.compileViewDirCode(),this._pVertexCode+=this._pMaterialPass._iGetPreVertexCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters),this._pFragmentCode+=this._pMaterialPass._iGetPreFragmentCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters)},ShaderCompilerBase.prototype.compileGlobalPositionCode=function(){this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.globalPositionVertex=this._pRegisterCache.getFreeVertexVectorTemp(),this._pShaderObject.globalPosDependencies);var sceneMatrixReg=this._pRegisterCache.getFreeVertexConstant();this._pRegisterCache.getFreeVertexConstant(),this._pRegisterCache.getFreeVertexConstant(),this._pRegisterCache.getFreeVertexConstant(),this._pShaderObject.sceneMatrixIndex=4*sceneMatrixReg.index,this._pVertexCode+="m44 "+this._pSharedRegisters.globalPositionVertex+", "+this._pSharedRegisters.localPosition+", "+sceneMatrixReg+"\n",this._pShaderObject.usesGlobalPosFragment&&(this._pSharedRegisters.globalPositionVarying=this._pRegisterCache.getFreeVarying(),this._pVertexCode+="mov "+this._pSharedRegisters.globalPositionVarying+", "+this._pSharedRegisters.globalPositionVertex+"\n")},ShaderCompilerBase.prototype.compileUVCode=function(){var uvAttributeReg=this._pRegisterCache.getFreeVertexAttribute();this._pShaderObject.uvBufferIndex=uvAttributeReg.index;var varying=this._pRegisterCache.getFreeVarying();if(this._pSharedRegisters.uvVarying=varying,this._pShaderObject.usesUVTransform){var uvTransform1=this._pRegisterCache.getFreeVertexConstant(),uvTransform2=this._pRegisterCache.getFreeVertexConstant();this._pShaderObject.uvTransformIndex=4*uvTransform1.index,this._pVertexCode+="dp4 "+varying+".x, "+uvAttributeReg+", "+uvTransform1+"\ndp4 "+varying+".y, "+uvAttributeReg+", "+uvTransform2+"\nmov "+varying+".zw, "+uvAttributeReg+".zw \n"}else this._pShaderObject.uvTransformIndex=-1,this._uvTarget=varying.toString(),this._uvSource=uvAttributeReg.toString()},ShaderCompilerBase.prototype.compileSecondaryUVCode=function(){var uvAttributeReg=this._pRegisterCache.getFreeVertexAttribute();this._pShaderObject.secondaryUVBufferIndex=uvAttributeReg.index,this._pSharedRegisters.secondaryUVVarying=this._pRegisterCache.getFreeVarying(),this._pVertexCode+="mov "+this._pSharedRegisters.secondaryUVVarying+", "+uvAttributeReg+"\n"},ShaderCompilerBase.prototype.compileViewDirCode=function(){var cameraPositionReg=this._pRegisterCache.getFreeVertexConstant();if(this._pSharedRegisters.viewDirVarying=this._pRegisterCache.getFreeVarying(),this._pSharedRegisters.viewDirFragment=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.viewDirFragment,this._pShaderObject.viewDirDependencies),this._pShaderObject.cameraPositionIndex=4*cameraPositionReg.index,this._pShaderObject.usesTangentSpace){var temp=this._pRegisterCache.getFreeVertexVectorTemp();this._pVertexCode+="sub "+temp+", "+cameraPositionReg+", "+this._pSharedRegisters.localPosition+"\nm33 "+this._pSharedRegisters.viewDirVarying+".xyz, "+temp+", "+this._pSharedRegisters.animatedTangent+"\nmov "+this._pSharedRegisters.viewDirVarying+".w, "+this._pSharedRegisters.localPosition+".w\n"}else this._pVertexCode+="sub "+this._pSharedRegisters.viewDirVarying+", "+cameraPositionReg+", "+this._pSharedRegisters.globalPositionVertex+"\n",this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex);this._pFragmentCode+="nrm "+this._pSharedRegisters.viewDirFragment+".xyz, "+this._pSharedRegisters.viewDirVarying+"\nmov "+this._pSharedRegisters.viewDirFragment+".w,   "+this._pSharedRegisters.viewDirVarying+".w\n"},ShaderCompilerBase.prototype.compileNormalCode=function(){if(this._pSharedRegisters.normalFragment=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.normalFragment,this._pShaderObject.normalDependencies),this._pShaderObject.outputsNormals&&!this._pShaderObject.outputsTangentNormals)return this._pVertexCode+=this._pMaterialPass._iGetNormalVertexCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters),this._pFragmentCode+=this._pMaterialPass._iGetNormalFragmentCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters),void 0;var normalMatrix;if(this._pShaderObject.outputsNormals&&this._pShaderObject.usesTangentSpace||(normalMatrix=new Array(3),normalMatrix[0]=this._pRegisterCache.getFreeVertexConstant(),normalMatrix[1]=this._pRegisterCache.getFreeVertexConstant(),normalMatrix[2]=this._pRegisterCache.getFreeVertexConstant(),this._pRegisterCache.getFreeVertexConstant(),this._pShaderObject.sceneNormalMatrixIndex=4*normalMatrix[0].index,this._pSharedRegisters.normalVarying=this._pRegisterCache.getFreeVarying()),this._pShaderObject.outputsNormals)if(this._pShaderObject.usesTangentSpace)this._pVertexCode+="nrm "+this._pSharedRegisters.animatedNormal+".xyz, "+this._pSharedRegisters.animatedNormal+"\nnrm "+this._pSharedRegisters.animatedTangent+".xyz, "+this._pSharedRegisters.animatedTangent+"\ncrs "+this._pSharedRegisters.bitangent+".xyz, "+this._pSharedRegisters.animatedNormal+", "+this._pSharedRegisters.animatedTangent+"\n",this._pFragmentCode+=this._pMaterialPass._iGetNormalFragmentCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters);else{this._pSharedRegisters.tangentVarying=this._pRegisterCache.getFreeVarying(),this._pSharedRegisters.bitangentVarying=this._pRegisterCache.getFreeVarying();var temp=this._pRegisterCache.getFreeVertexVectorTemp();this._pVertexCode+="m33 "+temp+".xyz, "+this._pSharedRegisters.animatedNormal+", "+normalMatrix[0]+"\nnrm "+this._pSharedRegisters.animatedNormal+".xyz, "+temp+"\nm33 "+temp+".xyz, "+this._pSharedRegisters.animatedTangent+", "+normalMatrix[0]+"\nnrm "+this._pSharedRegisters.animatedTangent+".xyz, "+temp+"\nmov "+this._pSharedRegisters.tangentVarying+".x, "+this._pSharedRegisters.animatedTangent+".x  \nmov "+this._pSharedRegisters.tangentVarying+".z, "+this._pSharedRegisters.animatedNormal+".x  \nmov "+this._pSharedRegisters.tangentVarying+".w, "+this._pSharedRegisters.normalInput+".w  \nmov "+this._pSharedRegisters.bitangentVarying+".x, "+this._pSharedRegisters.animatedTangent+".y  \nmov "+this._pSharedRegisters.bitangentVarying+".z, "+this._pSharedRegisters.animatedNormal+".y  \nmov "+this._pSharedRegisters.bitangentVarying+".w, "+this._pSharedRegisters.normalInput+".w  \nmov "+this._pSharedRegisters.normalVarying+".x, "+this._pSharedRegisters.animatedTangent+".z  \nmov "+this._pSharedRegisters.normalVarying+".z, "+this._pSharedRegisters.animatedNormal+".z  \nmov "+this._pSharedRegisters.normalVarying+".w, "+this._pSharedRegisters.normalInput+".w  \ncrs "+temp+".xyz, "+this._pSharedRegisters.animatedNormal+", "+this._pSharedRegisters.animatedTangent+"\nmov "+this._pSharedRegisters.tangentVarying+".y, "+temp+".x    \nmov "+this._pSharedRegisters.bitangentVarying+".y, "+temp+".y  \nmov "+this._pSharedRegisters.normalVarying+".y, "+temp+".z    \n",this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.animatedTangent);var t,b,n;t=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(t,1),b=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(b,1),n=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(n,1),this._pFragmentCode+="nrm "+t+".xyz, "+this._pSharedRegisters.tangentVarying+"\nmov "+t+".w, "+this._pSharedRegisters.tangentVarying+".w	\nnrm "+b+".xyz, "+this._pSharedRegisters.bitangentVarying+"\nnrm "+n+".xyz, "+this._pSharedRegisters.normalVarying+"\n",this._pFragmentCode+=this._pMaterialPass._iGetNormalFragmentCode(this._pShaderObject,this._pRegisterCache,this._pSharedRegisters)+"m33 "+this._pSharedRegisters.normalFragment+".xyz, "+this._pSharedRegisters.normalFragment+", "+t+"\nmov "+this._pSharedRegisters.normalFragment+".w, "+this._pSharedRegisters.normalVarying+".w\n",this._pRegisterCache.removeFragmentTempUsage(b),this._pRegisterCache.removeFragmentTempUsage(t),this._pRegisterCache.removeFragmentTempUsage(n)}else this._pVertexCode+="m33 "+this._pSharedRegisters.normalVarying+".xyz, "+this._pSharedRegisters.animatedNormal+", "+normalMatrix[0]+"\nmov "+this._pSharedRegisters.normalVarying+".w, "+this._pSharedRegisters.animatedNormal+".w\n",this._pFragmentCode+="nrm "+this._pSharedRegisters.normalFragment+".xyz, "+this._pSharedRegisters.normalVarying+"\nmov "+this._pSharedRegisters.normalFragment+".w, "+this._pSharedRegisters.normalVarying+".w\n",this._pShaderObject.tangentDependencies>0&&(this._pSharedRegisters.tangentVarying=this._pRegisterCache.getFreeVarying(),this._pVertexCode+="m33 "+this._pSharedRegisters.tangentVarying+".xyz, "+this._pSharedRegisters.animatedTangent+", "+normalMatrix[0]+"\nmov "+this._pSharedRegisters.tangentVarying+".w, "+this._pSharedRegisters.animatedTangent+".w\n");this._pShaderObject.usesTangentSpace||this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.animatedNormal)},ShaderCompilerBase.prototype.pInitRegisterIndices=function(){this._pShaderObject.pInitRegisterIndices(),this._pAnimatableAttributes=new Array("va0"),this._pAnimationTargetRegisters=new Array("vt0"),this._pVertexCode="",this._pFragmentCode="",this._pPostAnimationFragmentCode="",this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.localPosition=this._pRegisterCache.getFreeVertexVectorTemp(),1),this._pSharedRegisters.commons=this._pRegisterCache.getFreeFragmentConstant(),this._pShaderObject.commonsDataIndex=4*this._pSharedRegisters.commons.index,(this._pShaderObject.tangentDependencies>0||this._pShaderObject.outputsNormals)&&(this._pSharedRegisters.tangentInput=this._pRegisterCache.getFreeVertexAttribute(),this._pShaderObject.tangentBufferIndex=this._pSharedRegisters.tangentInput.index,this._pSharedRegisters.animatedTangent=this._pRegisterCache.getFreeVertexVectorTemp(),this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedTangent,1),this._pShaderObject.usesTangentSpace&&(this._pSharedRegisters.bitangent=this._pRegisterCache.getFreeVertexVectorTemp(),this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.bitangent,1)),this._pAnimatableAttributes.push(this._pSharedRegisters.tangentInput.toString()),this._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedTangent.toString())),this._pShaderObject.normalDependencies>0&&(this._pSharedRegisters.normalInput=this._pRegisterCache.getFreeVertexAttribute(),this._pShaderObject.normalBufferIndex=this._pSharedRegisters.normalInput.index,this._pSharedRegisters.animatedNormal=this._pRegisterCache.getFreeVertexVectorTemp(),this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedNormal,1),this._pAnimatableAttributes.push(this._pSharedRegisters.normalInput.toString()),this._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedNormal.toString()))},ShaderCompilerBase.prototype.pCalculateDependencies=function(){this._pShaderObject.useAlphaPremultiplied=this._pMaterial.alphaPremultiplied,this._pShaderObject.useBothSides=this._pMaterial.bothSides,this._pShaderObject.useMipmapping=this._pMaterial.mipmap,this._pShaderObject.useSmoothTextures=this._pMaterial.smooth,this._pShaderObject.repeatTextures=this._pMaterial.repeat,this._pShaderObject.usesAnimation=this._pMaterial.animationSet&&!this._pMaterial.animationSet.usesCPU,this._pShaderObject.usesUVTransform=this._pMaterial.animateUVs,this._pShaderObject.alphaThreshold=this._pMaterial.alphaThreshold,this._pShaderObject.usesFragmentAnimation=Boolean(this._pMaterialPass.passMode==materials.MaterialPassMode.SUPER_SHADER),this._pMaterialPass._iIncludeDependencies(this._pShaderObject)},ShaderCompilerBase.prototype.dispose=function(){this._pRegisterCache.dispose(),this._pRegisterCache=null,this._pSharedRegisters=null},Object.defineProperty(ShaderCompilerBase.prototype,"vertexCode",{get:function(){return this._pVertexCode},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderCompilerBase.prototype,"fragmentCode",{get:function(){return this._pFragmentCode},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderCompilerBase.prototype,"postAnimationFragmentCode",{get:function(){return this._pPostAnimationFragmentCode},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderCompilerBase.prototype,"shadedTarget",{get:function(){return this._pSharedRegisters.shadedTarget.toString()},enumerable:!0,configurable:!0}),ShaderCompilerBase}();materials.ShaderCompilerBase=ShaderCompilerBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLProfile=away.stagegl.ContextGLProfile,ShaderLightingCompiler=function(_super){function ShaderLightingCompiler(materialPassVO,shaderObject){_super.call(this,materialPassVO,shaderObject),this._materialLightingPass=materialPassVO.materialPass,this._shaderLightingObject=shaderObject}return __extends(ShaderLightingCompiler,_super),ShaderLightingCompiler.prototype.pCompileDependencies=function(){_super.prototype.pCompileDependencies.call(this),this._shaderLightingObject.usesShadows&&this.pCompileShadowCode(),this._pVertexCode+=this._materialLightingPass._iGetPreLightingVertexCode(this._shaderLightingObject,this._pRegisterCache,this._pSharedRegisters),this._pFragmentCode+=this._materialLightingPass._iGetPreLightingFragmentCode(this._shaderLightingObject,this._pRegisterCache,this._pSharedRegisters),this._shaderLightingObject.usesLights&&(this.initLightRegisters(),this.compileLightCode()),this._shaderLightingObject.usesProbes&&this.compileLightProbeCode(),this._pVertexCode+=this._materialLightingPass._iGetPostLightingVertexCode(this._shaderLightingObject,this._pRegisterCache,this._pSharedRegisters),this._pFragmentCode+=this._materialLightingPass._iGetPostLightingFragmentCode(this._shaderLightingObject,this._pRegisterCache,this._pSharedRegisters)},ShaderLightingCompiler.prototype.pCompileShadowCode=function(){this._shaderLightingObject.normalDependencies>0?this._pSharedRegisters.shadowTarget=this._pSharedRegisters.normalFragment:(this._pSharedRegisters.shadowTarget=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.shadowTarget,1))},ShaderLightingCompiler.prototype.initLightRegisters=function(){var i,len;if(this._dirLightVertexConstants)for(len=this._dirLightVertexConstants.length,i=0;len>i;++i)this._dirLightVertexConstants[i]=this._pRegisterCache.getFreeVertexConstant(),-1==this._shaderLightingObject.lightVertexConstantIndex&&(this._shaderLightingObject.lightVertexConstantIndex=4*this._dirLightVertexConstants[i].index);
if(this._pointLightVertexConstants)for(len=this._pointLightVertexConstants.length,i=0;len>i;++i)this._pointLightVertexConstants[i]=this._pRegisterCache.getFreeVertexConstant(),-1==this._shaderLightingObject.lightVertexConstantIndex&&(this._shaderLightingObject.lightVertexConstantIndex=4*this._pointLightVertexConstants[i].index);for(len=this._dirLightFragmentConstants.length,i=0;len>i;++i)this._dirLightFragmentConstants[i]=this._pRegisterCache.getFreeFragmentConstant(),-1==this._shaderLightingObject.lightFragmentConstantIndex&&(this._shaderLightingObject.lightFragmentConstantIndex=4*this._dirLightFragmentConstants[i].index);for(len=this._pointLightFragmentConstants.length,i=0;len>i;++i)this._pointLightFragmentConstants[i]=this._pRegisterCache.getFreeFragmentConstant(),-1==this._shaderLightingObject.lightFragmentConstantIndex&&(this._shaderLightingObject.lightFragmentConstantIndex=4*this._pointLightFragmentConstants[i].index)},ShaderLightingCompiler.prototype.compileLightCode=function(){for(var diffuseColorReg,specularColorReg,lightPosReg,lightDirReg,vertexRegIndex=0,fragmentRegIndex=0,addSpec=this._shaderLightingObject.usesLightsForSpecular,addDiff=this._shaderLightingObject.usesLightsForDiffuse,i=0;i<this._materialLightingPass.iNumDirectionalLights;++i){if(this._shaderLightingObject.usesTangentSpace){lightDirReg=this._dirLightVertexConstants[vertexRegIndex++];var lightVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="m33 "+lightVarying+".xyz, "+lightDirReg+", "+this._pSharedRegisters.animatedTangent+"\nmov "+lightVarying+".w, "+lightDirReg+".w\n",lightDirReg=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addVertexTempUsages(lightDirReg,1),this._pFragmentCode+="nrm "+lightDirReg+".xyz, "+lightVarying+"\nmov "+lightDirReg+".w, "+lightVarying+".w\n"}else lightDirReg=this._dirLightFragmentConstants[fragmentRegIndex++];diffuseColorReg=this._dirLightFragmentConstants[fragmentRegIndex++],specularColorReg=this._dirLightFragmentConstants[fragmentRegIndex++],addDiff&&(this._pFragmentCode+=this._materialLightingPass._iGetPerLightDiffuseFragmentCode(this._shaderLightingObject,lightDirReg,diffuseColorReg,this._pRegisterCache,this._pSharedRegisters)),addSpec&&(this._pFragmentCode+=this._materialLightingPass._iGetPerLightSpecularFragmentCode(this._shaderLightingObject,lightDirReg,specularColorReg,this._pRegisterCache,this._pSharedRegisters)),this._shaderLightingObject.usesTangentSpace&&this._pRegisterCache.removeVertexTempUsage(lightDirReg)}vertexRegIndex=0,fragmentRegIndex=0;for(var i=0;i<this._materialLightingPass.iNumPointLights;++i){lightPosReg=this._shaderLightingObject.usesTangentSpace||!this._shaderLightingObject.usesGlobalPosFragment?this._pointLightVertexConstants[vertexRegIndex++]:this._pointLightFragmentConstants[fragmentRegIndex++],diffuseColorReg=this._pointLightFragmentConstants[fragmentRegIndex++],specularColorReg=this._pointLightFragmentConstants[fragmentRegIndex++],lightDirReg=this._pRegisterCache.getFreeFragmentVectorTemp(),this._pRegisterCache.addFragmentTempUsages(lightDirReg,1);var lightVarying;if(this._shaderLightingObject.usesTangentSpace){lightVarying=this._pRegisterCache.getFreeVarying();var temp=this._pRegisterCache.getFreeVertexVectorTemp();this._pVertexCode+="sub "+temp+", "+lightPosReg+", "+this._pSharedRegisters.localPosition+"\nm33 "+lightVarying+".xyz, "+temp+", "+this._pSharedRegisters.animatedTangent+"\nmov "+lightVarying+".w, "+this._pSharedRegisters.localPosition+".w\n"}else this._shaderLightingObject.usesGlobalPosFragment?(lightVarying=lightDirReg,this._pFragmentCode+="sub "+lightDirReg+", "+lightPosReg+", "+this._pSharedRegisters.globalPositionVarying+"\n"):(lightVarying=this._pRegisterCache.getFreeVarying(),this._pVertexCode+="sub "+lightVarying+", "+lightPosReg+", "+this._pSharedRegisters.globalPositionVertex+"\n");this._pFragmentCode+=this._shaderLightingObject.usesLightFallOff?"dp3 "+lightDirReg+".w, "+lightVarying+", "+lightVarying+"\nsub "+lightDirReg+".w, "+lightDirReg+".w, "+diffuseColorReg+".w\nmul "+lightDirReg+".w, "+lightDirReg+".w, "+specularColorReg+".w\nsat "+lightDirReg+".w, "+lightDirReg+".w\nsub "+lightDirReg+".w, "+this._pSharedRegisters.commons+".w, "+lightDirReg+".w\nnrm "+lightDirReg+".xyz, "+lightVarying+"\n":"nrm "+lightDirReg+".xyz, "+lightVarying+"\nmov "+lightDirReg+".w, "+lightVarying+".w\n",-1==this._shaderLightingObject.lightFragmentConstantIndex&&(this._shaderLightingObject.lightFragmentConstantIndex=4*lightPosReg.index),addDiff&&(this._pFragmentCode+=this._materialLightingPass._iGetPerLightDiffuseFragmentCode(this._shaderLightingObject,lightDirReg,diffuseColorReg,this._pRegisterCache,this._pSharedRegisters)),addSpec&&(this._pFragmentCode+=this._materialLightingPass._iGetPerLightSpecularFragmentCode(this._shaderLightingObject,lightDirReg,specularColorReg,this._pRegisterCache,this._pSharedRegisters)),this._pRegisterCache.removeFragmentTempUsage(lightDirReg)}},ShaderLightingCompiler.prototype.compileLightProbeCode=function(){var weightReg,i,texReg,weightComponents=[".x",".y",".z",".w"],weightRegisters=new Array,addSpec=this._shaderLightingObject.usesProbesForSpecular,addDiff=this._shaderLightingObject.usesProbesForDiffuse;for(addDiff&&(this._shaderLightingObject.lightProbeDiffuseIndices=new Array),addSpec&&(this._shaderLightingObject.lightProbeSpecularIndices=new Array),i=0;i<this._pNumProbeRegisters;++i)weightRegisters[i]=this._pRegisterCache.getFreeFragmentConstant(),0==i&&(this._shaderLightingObject.probeWeightsIndex=4*weightRegisters[i].index);for(i=0;i<this._materialLightingPass.iNumLightProbes;++i)weightReg=weightRegisters[Math.floor(i/4)].toString()+weightComponents[i%4],addDiff&&(texReg=this._pRegisterCache.getFreeTextureReg(),this._shaderLightingObject.lightProbeDiffuseIndices[i]=texReg.index,this._pFragmentCode+=this._materialLightingPass._iGetPerProbeDiffuseFragmentCode(this._shaderLightingObject,texReg,weightReg,this._pRegisterCache,this._pSharedRegisters)),addSpec&&(texReg=this._pRegisterCache.getFreeTextureReg(),this._shaderLightingObject.lightProbeSpecularIndices[i]=texReg.index,this._pFragmentCode+=this._materialLightingPass._iGetPerProbeSpecularFragmentCode(this._shaderLightingObject,texReg,weightReg,this._pRegisterCache,this._pSharedRegisters))},ShaderLightingCompiler.prototype.pInitRegisterIndices=function(){_super.prototype.pInitRegisterIndices.call(this),this._shaderLightingObject.lightVertexConstantIndex=-1,this._shaderLightingObject.lightFragmentConstantIndex=-1,this._shaderLightingObject.probeWeightsIndex=-1,this._pNumProbeRegisters=Math.ceil(this._materialLightingPass.iNumLightProbes/4),this._shaderLightingObject.usesTangentSpace||!this._shaderLightingObject.usesGlobalPosFragment?(this._pointLightVertexConstants=new Array(this._materialLightingPass.iNumPointLights),this._pointLightFragmentConstants=new Array(2*this._materialLightingPass.iNumPointLights)):this._pointLightFragmentConstants=new Array(3*this._materialLightingPass.iNumPointLights),this._shaderLightingObject.usesTangentSpace?(this._dirLightVertexConstants=new Array(this._materialLightingPass.iNumDirectionalLights),this._dirLightFragmentConstants=new Array(2*this._materialLightingPass.iNumDirectionalLights)):this._dirLightFragmentConstants=new Array(3*this._materialLightingPass.iNumDirectionalLights)},ShaderLightingCompiler.prototype.pCalculateDependencies=function(){var numAllLights=this._materialLightingPass.iNumPointLights+this._materialLightingPass.iNumDirectionalLights,numLightProbes=this._materialLightingPass.iNumLightProbes,diffuseLightSources=this._pMaterial.diffuseLightSources,specularLightSources=this._materialLightingPass._iUsesSpecular()?this._pMaterial.specularLightSources:0,combinedLightSources=diffuseLightSources|specularLightSources;this._shaderLightingObject.usesLightFallOff=this._pMaterial.enableLightFallOff&&this._shaderLightingObject.profile!=ContextGLProfile.BASELINE_CONSTRAINED,this._shaderLightingObject.numLights=numAllLights+numLightProbes,this._shaderLightingObject.numPointLights=this._materialLightingPass.iNumPointLights,this._shaderLightingObject.numDirectionalLights=this._materialLightingPass.iNumDirectionalLights,this._shaderLightingObject.numLightProbes=numLightProbes,this._shaderLightingObject.pointLightsOffset=this._materialLightingPass.pointLightsOffset,this._shaderLightingObject.directionalLightsOffset=this._materialLightingPass.directionalLightsOffset,this._shaderLightingObject.lightProbesOffset=this._materialLightingPass.lightProbesOffset,this._shaderLightingObject.lightPicker=this._materialLightingPass.lightPicker,this._shaderLightingObject.usesLights=numAllLights>0&&0!=(combinedLightSources&materials.LightSources.LIGHTS),this._shaderLightingObject.usesProbes=numLightProbes>0&&0!=(combinedLightSources&materials.LightSources.PROBES),this._shaderLightingObject.usesLightsForSpecular=numAllLights>0&&0!=(specularLightSources&materials.LightSources.LIGHTS),this._shaderLightingObject.usesProbesForSpecular=numLightProbes>0&&0!=(specularLightSources&materials.LightSources.PROBES),this._shaderLightingObject.usesLightsForDiffuse=numAllLights>0&&0!=(diffuseLightSources&materials.LightSources.LIGHTS),this._shaderLightingObject.usesProbesForDiffuse=numLightProbes>0&&0!=(diffuseLightSources&materials.LightSources.PROBES),this._shaderLightingObject.usesShadows=this._materialLightingPass._iUsesShadows(),_super.prototype.pCalculateDependencies.call(this)},ShaderLightingCompiler}(materials.ShaderCompilerBase);materials.ShaderLightingCompiler=ShaderLightingCompiler}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShaderRegisterData=function(){function ShaderRegisterData(){}return ShaderRegisterData}();materials.ShaderRegisterData=ShaderRegisterData}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShadingMethodBase=function(_super){function ShadingMethodBase(){_super.call(this)}return __extends(ShadingMethodBase,_super),ShadingMethodBase.prototype.iIsUsed=function(){return!0},ShadingMethodBase.prototype.iInitVO=function(){},ShadingMethodBase.prototype.iInitConstants=function(){},ShadingMethodBase.prototype.iUsesTangentSpace=function(){return!0},Object.defineProperty(ShadingMethodBase.prototype,"passes",{get:function(){return this._passes},enumerable:!0,configurable:!0}),ShadingMethodBase.prototype.dispose=function(){},ShadingMethodBase.prototype.iReset=function(){this.iCleanCompilationData()},ShadingMethodBase.prototype.iCleanCompilationData=function(){},ShadingMethodBase.prototype.iGetVertexCode=function(){return""},ShadingMethodBase.prototype.iGetFragmentCode=function(){return null},ShadingMethodBase.prototype.iActivate=function(){},ShadingMethodBase.prototype.iSetRenderState=function(){},ShadingMethodBase.prototype.iDeactivate=function(){},ShadingMethodBase.prototype.iInvalidateShaderProgram=function(){this.dispatchEvent(new away.events.ShadingMethodEvent(away.events.ShadingMethodEvent.SHADER_INVALIDATED))},ShadingMethodBase.prototype.copyFrom=function(){},ShadingMethodBase}(away.library.NamedAssetBase);materials.ShadingMethodBase=ShadingMethodBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var LightingMethodBase=function(_super){function LightingMethodBase(){_super.call(this)}return __extends(LightingMethodBase,_super),LightingMethodBase.prototype.iGetFragmentPreLightingCode=function(){return""},LightingMethodBase.prototype.iGetFragmentCodePerLight=function(){return""},LightingMethodBase.prototype.iGetFragmentCodePerProbe=function(){return""},LightingMethodBase.prototype.iGetFragmentPostLightingCode=function(){return""},LightingMethodBase}(materials.ShadingMethodBase);materials.LightingMethodBase=LightingMethodBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,AmbientBasicMethod=function(_super){function AmbientBasicMethod(){_super.call(this),this._useTexture=!1,this._color=16777215,this._alpha=1,this._colorR=1,this._colorG=1,this._colorB=1,this._ambient=1}return __extends(AmbientBasicMethod,_super),AmbientBasicMethod.prototype.iInitVO=function(shaderObject,methodVO){methodVO.needsUV=this._useTexture},Object.defineProperty(AmbientBasicMethod.prototype,"ambient",{get:function(){return this._ambient},set:function(value){this._ambient!=value&&(this._ambient=value,this.updateColor())},enumerable:!0,configurable:!0}),Object.defineProperty(AmbientBasicMethod.prototype,"color",{get:function(){return this._color},set:function(value){this._color!=value&&(this._color=value,this.updateColor())},enumerable:!0,configurable:!0}),Object.defineProperty(AmbientBasicMethod.prototype,"alpha",{get:function(){return this._alpha},set:function(value){this._alpha!=value&&(this._alpha=value,this.updateColor())},enumerable:!0,configurable:!0}),Object.defineProperty(AmbientBasicMethod.prototype,"texture",{get:function(){return this._texture},set:function(value){var b=null!=value;(b!=this._useTexture||value&&this._texture&&(value.hasMipmaps!=this._texture.hasMipmaps||value.format!=this._texture.format))&&this.iInvalidateShaderProgram(),this._useTexture=b,this._texture=value},enumerable:!0,configurable:!0}),AmbientBasicMethod.prototype.copyFrom=function(method){var m=method,b=m,diff=b;this.ambient=diff.ambient,this.color=diff.color},AmbientBasicMethod.prototype.iGetFragmentCode=function(shaderObject,methodVO,targetReg,registerCache,sharedRegisters){var ambientInputRegister,code="";if(this._useTexture){if(ambientInputRegister=registerCache.getFreeTextureReg(),methodVO.texturesIndex=ambientInputRegister.index,code+=materials.ShaderCompilerHelper.getTex2DSampleCode(targetReg,sharedRegisters,ambientInputRegister,this._texture,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping),shaderObject.alphaThreshold>0){var cutOffReg=registerCache.getFreeFragmentConstant();methodVO.fragmentConstantsIndex=4*cutOffReg.index,code+="sub "+targetReg+".w, "+targetReg+".w, "+cutOffReg+".x\nkil "+targetReg+".w\nadd "+targetReg+".w, "+targetReg+".w, "+cutOffReg+".x\n"}}else ambientInputRegister=registerCache.getFreeFragmentConstant(),methodVO.fragmentConstantsIndex=4*ambientInputRegister.index,code+="mov "+targetReg+", "+ambientInputRegister+"\n";return code},AmbientBasicMethod.prototype.iActivate=function(shaderObject,methodVO,stage){if(this._useTexture)stage.context.setSamplerStateAt(methodVO.texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),stage.context.activateTexture(methodVO.texturesIndex,this._texture),shaderObject.alphaThreshold>0&&(shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex]=shaderObject.alphaThreshold);else{var index=methodVO.fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=this._colorR,data[index+1]=this._colorG,data[index+2]=this._colorB,data[index+3]=this._alpha}},AmbientBasicMethod.prototype.updateColor=function(){this._colorR=(this._color>>16&255)/255*this._ambient,this._colorG=(this._color>>8&255)/255*this._ambient,this._colorB=(255&this._color)/255*this._ambient},AmbientBasicMethod}(materials.ShadingMethodBase);materials.AmbientBasicMethod=AmbientBasicMethod}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,DiffuseBasicMethod=function(_super){function DiffuseBasicMethod(){_super.call(this),this._multiply=!0,this._diffuseColor=16777215,this._ambientColor=16777215,this._diffuseR=1,this._diffuseG=1,this._diffuseB=1,this._ambientR=1,this._ambientG=1,this._ambientB=1}return __extends(DiffuseBasicMethod,_super),DiffuseBasicMethod.prototype.iIsUsed=function(shaderObject){return shaderObject.numLights?!0:!1},Object.defineProperty(DiffuseBasicMethod.prototype,"multiply",{get:function(){return this._multiply},set:function(value){this._multiply!=value&&(this._multiply=value,this.iInvalidateShaderProgram())},enumerable:!0,configurable:!0}),DiffuseBasicMethod.prototype.iInitVO=function(shaderObject,methodVO){methodVO.needsUV=this._pUseTexture,methodVO.needsNormals=shaderObject.numLights>0},DiffuseBasicMethod.prototype.generateMip=function(stage){this._pUseTexture&&stage.context.activateTexture(0,this._texture)},Object.defineProperty(DiffuseBasicMethod.prototype,"diffuseColor",{get:function(){return this._diffuseColor},set:function(value){this._diffuseColor!=value&&(this._diffuseColor=value,this.updateDiffuse())},enumerable:!0,configurable:!0}),Object.defineProperty(DiffuseBasicMethod.prototype,"ambientColor",{get:function(){return this._ambientColor},set:function(value){this._ambientColor!=value&&(this._ambientColor=value,this.updateAmbient())},enumerable:!0,configurable:!0}),Object.defineProperty(DiffuseBasicMethod.prototype,"texture",{get:function(){return this._texture},set:function(value){var b=null!=value;(b!=this._pUseTexture||value&&this._texture&&(value.hasMipmaps!=this._texture.hasMipmaps||value.format!=this._texture.format))&&this.iInvalidateShaderProgram(),this._pUseTexture=b,this._texture=value},enumerable:!0,configurable:!0}),DiffuseBasicMethod.prototype.dispose=function(){this._texture=null},DiffuseBasicMethod.prototype.copyFrom=function(method){var diff=method;this.texture=diff.texture,this.multiply=diff.multiply,this.diffuseColor=diff.diffuseColor,this.ambientColor=diff.ambientColor},DiffuseBasicMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this),this._pTotalLightColorReg=null,this._pDiffuseInputRegister=null},DiffuseBasicMethod.prototype.iGetFragmentPreLightingCode=function(shaderObject,methodVO,registerCache){var code="";return this._pIsFirstLight=!0,this._pTotalLightColorReg=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(this._pTotalLightColorReg,1),code},DiffuseBasicMethod.prototype.iGetFragmentCodePerLight=function(shaderObject,methodVO,lightDirReg,lightColReg,registerCache,sharedRegisters){var t,code="";return this._pIsFirstLight?t=this._pTotalLightColorReg:(t=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(t,1)),code+="dp3 "+t+".x, "+lightDirReg+", "+sharedRegisters.normalFragment+"\nmax "+t+".w, "+t+".x, "+sharedRegisters.commons+".y\n",shaderObject.usesLightFallOff&&(code+="mul "+t+".w, "+t+".w, "+lightDirReg+".w\n"),null!=this._iModulateMethod&&(code+=this._iModulateMethod(shaderObject,methodVO,t,registerCache,sharedRegisters)),code+="mul "+t+", "+t+".w, "+lightColReg+"\n",this._pIsFirstLight||(code+="add "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+t+"\n",registerCache.removeFragmentTempUsage(t)),this._pIsFirstLight=!1,code},DiffuseBasicMethod.prototype.iGetFragmentCodePerProbe=function(shaderObject,methodVO,cubeMapReg,weightRegister,registerCache,sharedRegisters){var t,code="";return this._pIsFirstLight?t=this._pTotalLightColorReg:(t=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(t,1)),code+="tex "+t+", "+sharedRegisters.normalFragment+", "+cubeMapReg+" <cube,linear,miplinear>\nmul "+t+".xyz, "+t+".xyz, "+weightRegister+"\n",null!=this._iModulateMethod&&(code+=this._iModulateMethod(shaderObject,methodVO,t,registerCache,sharedRegisters)),this._pIsFirstLight||(code+="add "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+t+"\n",registerCache.removeFragmentTempUsage(t)),this._pIsFirstLight=!1,code},DiffuseBasicMethod.prototype.iGetFragmentPostLightingCode=function(shaderObject,methodVO,targetReg,registerCache,sharedRegisters){var albedo,code="";sharedRegisters.shadowTarget&&(code+=this.pApplyShadow(shaderObject,methodVO,registerCache,sharedRegisters)),albedo=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(albedo,1);var ambientColorRegister=registerCache.getFreeFragmentConstant();return methodVO.fragmentConstantsIndex=4*ambientColorRegister.index,this._pUseTexture?(this._pDiffuseInputRegister=registerCache.getFreeTextureReg(),methodVO.texturesIndex=this._pDiffuseInputRegister.index,code+=materials.ShaderCompilerHelper.getTex2DSampleCode(albedo,sharedRegisters,this._pDiffuseInputRegister,this._texture,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping)):(this._pDiffuseInputRegister=registerCache.getFreeFragmentConstant(),code+="mov "+albedo+", "+this._pDiffuseInputRegister+"\n"),code+="sat "+this._pTotalLightColorReg+", "+this._pTotalLightColorReg+"\nmul "+albedo+".xyz, "+albedo+", "+this._pTotalLightColorReg+"\n",code+=this._multiply?"add "+albedo+".xyz, "+albedo+", "+ambientColorRegister+"\nmul "+targetReg+".xyz, "+targetReg+", "+albedo+"\n":"mul "+targetReg+".xyz, "+targetReg+", "+ambientColorRegister+"\nmul "+this._pTotalLightColorReg+".xyz, "+targetReg+", "+this._pTotalLightColorReg+"\nsub "+targetReg+".xyz, "+targetReg+", "+this._pTotalLightColorReg+"\nadd "+targetReg+".xyz, "+targetReg+", "+albedo+"\n",registerCache.removeFragmentTempUsage(this._pTotalLightColorReg),registerCache.removeFragmentTempUsage(albedo),code},DiffuseBasicMethod.prototype.pApplyShadow=function(shaderObject,methodVO,regCache,sharedRegisters){return"mul "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+sharedRegisters.shadowTarget+".w\n"},DiffuseBasicMethod.prototype.iActivate=function(shaderObject,methodVO,stage){if(this._pUseTexture)stage.context.setSamplerStateAt(methodVO.texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),stage.context.activateTexture(methodVO.texturesIndex,this._texture);else{var index=methodVO.fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index+4]=this._diffuseR,data[index+5]=this._diffuseG,data[index+6]=this._diffuseB,data[index+7]=1}},DiffuseBasicMethod.prototype.updateDiffuse=function(){this._diffuseR=(this._diffuseColor>>16&255)/255,this._diffuseG=(this._diffuseColor>>8&255)/255,this._diffuseB=(255&this._diffuseColor)/255},DiffuseBasicMethod.prototype.updateAmbient=function(){this._ambientR=(this._ambientColor>>16&255)/255,this._ambientG=(this._ambientColor>>8&255)/255,this._ambientB=(255&this._ambientColor)/255},DiffuseBasicMethod.prototype.iSetRenderState=function(shaderObject,methodVO){if(shaderObject.numLights>0){var index=methodVO.fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=shaderObject.ambientR*this._ambientR,data[index+1]=shaderObject.ambientG*this._ambientG,data[index+2]=shaderObject.ambientB*this._ambientB,data[index+3]=1}},DiffuseBasicMethod}(materials.LightingMethodBase);materials.DiffuseBasicMethod=DiffuseBasicMethod}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var EffectMethodBase=function(_super){function EffectMethodBase(){_super.call(this)}return __extends(EffectMethodBase,_super),Object.defineProperty(EffectMethodBase.prototype,"assetType",{get:function(){return away.library.AssetType.EFFECTS_METHOD},enumerable:!0,configurable:!0}),EffectMethodBase.prototype.iGetFragmentCode=function(){throw new away.errors.AbstractMethodError},EffectMethodBase}(materials.ShadingMethodBase);materials.EffectMethodBase=EffectMethodBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var EffectColorTransformMethod=function(_super){function EffectColorTransformMethod(){_super.call(this)}return __extends(EffectColorTransformMethod,_super),Object.defineProperty(EffectColorTransformMethod.prototype,"colorTransform",{get:function(){return this._colorTransform},set:function(value){this._colorTransform=value},enumerable:!0,configurable:!0}),EffectColorTransformMethod.prototype.iGetFragmentCode=function(shaderObject,methodVO,targetReg,registerCache){var code="",colorMultReg=registerCache.getFreeFragmentConstant(),colorOffsReg=registerCache.getFreeFragmentConstant();return methodVO.fragmentConstantsIndex=4*colorMultReg.index,code+="mul "+targetReg+", "+targetReg+", "+colorMultReg+"\nadd "+targetReg+", "+targetReg+", "+colorOffsReg+"\n"},EffectColorTransformMethod.prototype.iActivate=function(shaderObject,methodVO){var inv=1/255,index=methodVO.fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=this._colorTransform.redMultiplier,data[index+1]=this._colorTransform.greenMultiplier,data[index+2]=this._colorTransform.blueMultiplier,data[index+3]=this._colorTransform.alphaMultiplier,data[index+4]=this._colorTransform.redOffset*inv,data[index+5]=this._colorTransform.greenOffset*inv,data[index+6]=this._colorTransform.blueOffset*inv,data[index+7]=this._colorTransform.alphaOffset*inv},EffectColorTransformMethod}(materials.EffectMethodBase);materials.EffectColorTransformMethod=EffectColorTransformMethod}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,NormalBasicMethod=function(_super){function NormalBasicMethod(){_super.call(this)}return __extends(NormalBasicMethod,_super),NormalBasicMethod.prototype.iIsUsed=function(shaderObject){return this._useTexture&&shaderObject.normalDependencies?!0:!1},NormalBasicMethod.prototype.iInitVO=function(shaderObject,methodVO){methodVO.needsUV=this._useTexture},NormalBasicMethod.prototype.iOutputsTangentNormals=function(){return!0},NormalBasicMethod.prototype.copyFrom=function(method){var bnm=method;null!=bnm.normalMap&&(this.normalMap=bnm.normalMap)},Object.defineProperty(NormalBasicMethod.prototype,"normalMap",{get:function(){return this._texture},set:function(value){var b=null!=value;(b!=this._useTexture||value&&this._texture&&(value.hasMipmaps!=this._texture.hasMipmaps||value.format!=this._texture.format))&&this.iInvalidateShaderProgram(),this._useTexture=b,this._texture=value},enumerable:!0,configurable:!0}),NormalBasicMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this),this._pNormalTextureRegister=null},NormalBasicMethod.prototype.dispose=function(){this._texture&&(this._texture=null)},NormalBasicMethod.prototype.iActivate=function(shaderObject,methodVO,stage){methodVO.texturesIndex>=0&&(stage.context.setSamplerStateAt(methodVO.texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),stage.context.activateTexture(methodVO.texturesIndex,this._texture))},NormalBasicMethod.prototype.iGetFragmentCode=function(shaderObject,methodVO,targetReg,registerCache,sharedRegisters){return this._pNormalTextureRegister=registerCache.getFreeTextureReg(),methodVO.texturesIndex=this._pNormalTextureRegister.index,materials.ShaderCompilerHelper.getTex2DSampleCode(targetReg,sharedRegisters,this._pNormalTextureRegister,this._texture,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping)+"sub "+targetReg+".xyz, "+targetReg+".xyz, "+sharedRegisters.commons+".xxx\nnrm "+targetReg+".xyz, "+targetReg+"\n"},NormalBasicMethod}(materials.ShadingMethodBase);materials.NormalBasicMethod=NormalBasicMethod}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShadowMapMethodBase=function(_super){function ShadowMapMethodBase(castingLight){_super.call(this),this._pEpsilon=.02,this._pAlpha=1,this._pCastingLight=castingLight,castingLight.castsShadows=!0,this._pShadowMapper=castingLight.shadowMapper}return __extends(ShadowMapMethodBase,_super),Object.defineProperty(ShadowMapMethodBase.prototype,"assetType",{get:function(){return away.library.AssetType.SHADOW_MAP_METHOD},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapMethodBase.prototype,"alpha",{get:function(){return this._pAlpha},set:function(value){this._pAlpha=value},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapMethodBase.prototype,"castingLight",{get:function(){return this._pCastingLight},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapMethodBase.prototype,"epsilon",{get:function(){return this._pEpsilon},set:function(value){this._pEpsilon=value},enumerable:!0,configurable:!0}),ShadowMapMethodBase}(materials.ShadingMethodBase);materials.ShadowMapMethodBase=ShadowMapMethodBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var PointLight=away.entities.PointLight,AbstractMethodError=away.errors.AbstractMethodError,ShadowMethodBase=function(_super){function ShadowMethodBase(castingLight){this._pUsePoint=castingLight instanceof PointLight,_super.call(this,castingLight)}return __extends(ShadowMethodBase,_super),ShadowMethodBase.prototype.iInitVO=function(shaderObject,methodVO){methodVO.needsView=!0,methodVO.needsGlobalVertexPos=!0,methodVO.needsGlobalFragmentPos=this._pUsePoint,methodVO.needsNormals=shaderObject.numLights>0},ShadowMethodBase.prototype.iInitConstants=function(shaderObject,methodVO){var fragmentData=shaderObject.fragmentConstantData,vertexData=shaderObject.vertexConstantData,index=methodVO.fragmentConstantsIndex;fragmentData[index]=1,fragmentData[index+1]=1/255,fragmentData[index+2]=1/65025,fragmentData[index+3]=1/16581375,fragmentData[index+6]=0,fragmentData[index+7]=1,this._pUsePoint&&(fragmentData[index+8]=0,fragmentData[index+9]=0,fragmentData[index+10]=0,fragmentData[index+11]=1),index=methodVO.vertexConstantsIndex,-1!=index&&(vertexData[index]=.5,vertexData[index+1]=.5,vertexData[index+2]=0,vertexData[index+3]=1)},Object.defineProperty(ShadowMethodBase.prototype,"_iDepthMapCoordReg",{get:function(){return this._pDepthMapCoordReg},set:function(value){this._pDepthMapCoordReg=value},enumerable:!0,configurable:!0}),ShadowMethodBase.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this),this._pDepthMapCoordReg=null},ShadowMethodBase.prototype.iGetVertexCode=function(shaderObject,methodVO,regCache,sharedRegisters){return this._pUsePoint?this._pGetPointVertexCode(methodVO,regCache,sharedRegisters):this.pGetPlanarVertexCode(methodVO,regCache,sharedRegisters)},ShadowMethodBase.prototype._pGetPointVertexCode=function(methodVO){return methodVO.vertexConstantsIndex=-1,""},ShadowMethodBase.prototype.pGetPlanarVertexCode=function(methodVO,regCache,sharedRegisters){var code="",temp=regCache.getFreeVertexVectorTemp(),dataReg=regCache.getFreeVertexConstant(),depthMapProj=regCache.getFreeVertexConstant();return regCache.getFreeVertexConstant(),regCache.getFreeVertexConstant(),regCache.getFreeVertexConstant(),this._pDepthMapCoordReg=regCache.getFreeVarying(),methodVO.vertexConstantsIndex=4*dataReg.index,code+="m44 "+temp+", "+sharedRegisters.globalPositionVertex+", "+depthMapProj+"\ndiv "+temp+", "+temp+", "+temp+".w\nmul "+temp+".xy, "+temp+".xy, "+dataReg+".xy\nadd "+this._pDepthMapCoordReg+", "+temp+", "+dataReg+".xxwz\n"},ShadowMethodBase.prototype.iGetFragmentCode=function(shaderObject,methodVO,targetReg,registerCache,sharedRegisters){var code=this._pUsePoint?this._pGetPointFragmentCode(methodVO,targetReg,registerCache,sharedRegisters):this._pGetPlanarFragmentCode(methodVO,targetReg,registerCache,sharedRegisters);
return code+="add "+targetReg+".w, "+targetReg+".w, fc"+(methodVO.fragmentConstantsIndex/4+1)+".y\nsat "+targetReg+".w, "+targetReg+".w\n"},ShadowMethodBase.prototype._pGetPlanarFragmentCode=function(){throw new AbstractMethodError},ShadowMethodBase.prototype._pGetPointFragmentCode=function(){throw new AbstractMethodError},ShadowMethodBase.prototype.iSetRenderState=function(shaderObject,methodVO){this._pUsePoint||this._pShadowMapper.iDepthProjection.copyRawDataTo(shaderObject.vertexConstantData,methodVO.vertexConstantsIndex+4,!0)},ShadowMethodBase.prototype._iGetCascadeFragmentCode=function(){throw new Error("This shadow method is incompatible with cascade shadows")},ShadowMethodBase.prototype.iActivate=function(shaderObject,methodVO,stage){var fragmentData=shaderObject.fragmentConstantData,index=methodVO.fragmentConstantsIndex;if(this._pUsePoint?fragmentData[index+4]=-Math.pow(1/(this._pCastingLight.fallOff*this._pEpsilon),2):shaderObject.vertexConstantData[methodVO.vertexConstantsIndex+3]=-1/(this._pShadowMapper.depth*this._pEpsilon),fragmentData[index+5]=1-this._pAlpha,this._pUsePoint){var pos=this._pCastingLight.scenePosition;fragmentData[index+8]=pos.x,fragmentData[index+9]=pos.y,fragmentData[index+10]=pos.z;var f=this._pCastingLight.fallOff;fragmentData[index+11]=1/(2*f*f)}this._pUsePoint||stage.context.activateRenderTexture(methodVO.texturesIndex,this._pCastingLight.shadowMapper.depthMap)},ShadowMethodBase.prototype.iActivateForCascade=function(){throw new Error("This shadow method is incompatible with cascade shadows")},ShadowMethodBase}(materials.ShadowMapMethodBase);materials.ShadowMethodBase=ShadowMethodBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShadowHardMethod=function(_super){function ShadowHardMethod(castingLight){_super.call(this,castingLight)}return __extends(ShadowHardMethod,_super),ShadowHardMethod.prototype._pGetPlanarFragmentCode=function(methodVO,targetReg,regCache){var depthMapRegister=regCache.getFreeTextureReg(),decReg=regCache.getFreeFragmentConstant(),depthCol=(regCache.getFreeFragmentConstant(),regCache.getFreeFragmentVectorTemp()),code="";return methodVO.fragmentConstantsIndex=4*decReg.index,methodVO.texturesIndex=depthMapRegister.index,code+="tex "+depthCol+", "+this._pDepthMapCoordReg+", "+depthMapRegister+" <2d, nearest, clamp>\ndp4 "+depthCol+".z, "+depthCol+", "+decReg+"\nslt "+targetReg+".w, "+this._pDepthMapCoordReg+".z, "+depthCol+".z\n"},ShadowHardMethod.prototype._pGetPointFragmentCode=function(methodVO,targetReg,regCache,sharedRegisters){var depthMapRegister=regCache.getFreeTextureReg(),decReg=regCache.getFreeFragmentConstant(),epsReg=regCache.getFreeFragmentConstant(),posReg=regCache.getFreeFragmentConstant(),depthSampleCol=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(depthSampleCol,1);var lightDir=regCache.getFreeFragmentVectorTemp(),code="";return methodVO.fragmentConstantsIndex=4*decReg.index,methodVO.texturesIndex=depthMapRegister.index,code+="sub "+lightDir+", "+sharedRegisters.globalPositionVarying+", "+posReg+"\ndp3 "+lightDir+".w, "+lightDir+".xyz, "+lightDir+".xyz\nmul "+lightDir+".w, "+lightDir+".w, "+posReg+".w\nnrm "+lightDir+".xyz, "+lightDir+".xyz\ntex "+depthSampleCol+", "+lightDir+", "+depthMapRegister+" <cube, nearest, clamp>\ndp4 "+depthSampleCol+".z, "+depthSampleCol+", "+decReg+"\nadd "+targetReg+".w, "+lightDir+".w, "+epsReg+".x\nslt "+targetReg+".w, "+targetReg+".w, "+depthSampleCol+".z\n",regCache.removeFragmentTempUsage(depthSampleCol),code},ShadowHardMethod.prototype._iGetCascadeFragmentCode=function(shaderObject,methodVO,decodeRegister,depthTexture,depthProjection,targetRegister,registerCache){var temp=registerCache.getFreeFragmentVectorTemp();return"tex "+temp+", "+depthProjection+", "+depthTexture+" <2d, nearest, clamp>\ndp4 "+temp+".z, "+temp+", "+decodeRegister+"\nslt "+targetRegister+".w, "+depthProjection+".z, "+temp+".z\n"},ShadowHardMethod.prototype.iActivateForCascade=function(){},ShadowHardMethod}(materials.ShadowMethodBase);materials.ShadowHardMethod=ShadowHardMethod}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLWrapMode=away.stagegl.ContextGLWrapMode,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLMipFilter=away.stagegl.ContextGLMipFilter,SpecularBasicMethod=function(_super){function SpecularBasicMethod(){_super.call(this),this._gloss=50,this._specular=1,this._specularColor=16777215,this._iSpecularR=1,this._iSpecularG=1,this._iSpecularB=1}return __extends(SpecularBasicMethod,_super),SpecularBasicMethod.prototype.iIsUsed=function(shaderObject){return shaderObject.numLights?!0:!1},SpecularBasicMethod.prototype.iInitVO=function(shaderObject,methodVO){methodVO.needsUV=this._pUseTexture,methodVO.needsNormals=shaderObject.numLights>0,methodVO.needsView=shaderObject.numLights>0},Object.defineProperty(SpecularBasicMethod.prototype,"gloss",{get:function(){return this._gloss},set:function(value){this._gloss=value},enumerable:!0,configurable:!0}),Object.defineProperty(SpecularBasicMethod.prototype,"specular",{get:function(){return this._specular},set:function(value){value!=this._specular&&(this._specular=value,this.updateSpecular())},enumerable:!0,configurable:!0}),Object.defineProperty(SpecularBasicMethod.prototype,"specularColor",{get:function(){return this._specularColor},set:function(value){this._specularColor!=value&&((0==this._specularColor||0==value)&&this.iInvalidateShaderProgram(),this._specularColor=value,this.updateSpecular())},enumerable:!0,configurable:!0}),Object.defineProperty(SpecularBasicMethod.prototype,"texture",{get:function(){return this._texture},set:function(value){var b=null!=value;(b!=this._pUseTexture||value&&this._texture&&(value.hasMipmaps!=this._texture.hasMipmaps||value.format!=this._texture.format))&&this.iInvalidateShaderProgram(),this._pUseTexture=b,this._texture=value},enumerable:!0,configurable:!0}),SpecularBasicMethod.prototype.copyFrom=function(method){var bsm=method,spec=bsm;this.texture=spec.texture,this.specular=spec.specular,this.specularColor=spec.specularColor,this.gloss=spec.gloss},SpecularBasicMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this),this._pTotalLightColorReg=null,this._pSpecularTextureRegister=null,this._pSpecularTexData=null,this._pSpecularDataRegister=null},SpecularBasicMethod.prototype.iGetFragmentPreLightingCode=function(shaderObject,methodVO,registerCache,sharedRegisters){var code="";return this._pIsFirstLight=!0,this._pSpecularDataRegister=registerCache.getFreeFragmentConstant(),methodVO.fragmentConstantsIndex=4*this._pSpecularDataRegister.index,this._pUseTexture?(this._pSpecularTexData=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(this._pSpecularTexData,1),this._pSpecularTextureRegister=registerCache.getFreeTextureReg(),methodVO.texturesIndex=this._pSpecularTextureRegister.index,code=materials.ShaderCompilerHelper.getTex2DSampleCode(this._pSpecularTexData,sharedRegisters,this._pSpecularTextureRegister,this._texture,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping)):this._pSpecularTextureRegister=null,this._pTotalLightColorReg=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(this._pTotalLightColorReg,1),code},SpecularBasicMethod.prototype.iGetFragmentCodePerLight=function(shaderObject,methodVO,lightDirReg,lightColReg,registerCache,sharedRegisters){var t,code="";this._pIsFirstLight?t=this._pTotalLightColorReg:(t=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(t,1));var viewDirReg=sharedRegisters.viewDirFragment,normalReg=sharedRegisters.normalFragment;return code+="add "+t+", "+lightDirReg+", "+viewDirReg+"\nnrm "+t+".xyz, "+t+"\ndp3 "+t+".w, "+normalReg+", "+t+"\nsat "+t+".w, "+t+".w\n",code+=this._pUseTexture?"mul "+this._pSpecularTexData+".w, "+this._pSpecularTexData+".y, "+this._pSpecularDataRegister+".w\npow "+t+".w, "+t+".w, "+this._pSpecularTexData+".w\n":"pow "+t+".w, "+t+".w, "+this._pSpecularDataRegister+".w\n",shaderObject.usesLightFallOff&&(code+="mul "+t+".w, "+t+".w, "+lightDirReg+".w\n"),null!=this._iModulateMethod&&(code+=this._iModulateMethod(shaderObject,methodVO,t,registerCache,sharedRegisters)),code+="mul "+t+".xyz, "+lightColReg+", "+t+".w\n",this._pIsFirstLight||(code+="add "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+t+"\n",registerCache.removeFragmentTempUsage(t)),this._pIsFirstLight=!1,code},SpecularBasicMethod.prototype.iGetFragmentCodePerProbe=function(shaderObject,methodVO,cubeMapReg,weightRegister,registerCache,sharedRegisters){var t,code="";this._pIsFirstLight?t=this._pTotalLightColorReg:(t=registerCache.getFreeFragmentVectorTemp(),registerCache.addFragmentTempUsages(t,1));var normalReg=sharedRegisters.normalFragment,viewDirReg=sharedRegisters.viewDirFragment;return code+="dp3 "+t+".w, "+normalReg+", "+viewDirReg+"\nadd "+t+".w, "+t+".w, "+t+".w\nmul "+t+", "+t+".w, "+normalReg+"\nsub "+t+", "+t+", "+viewDirReg+"\ntex "+t+", "+t+", "+cubeMapReg+" <cube,"+(shaderObject.useSmoothTextures?"linear":"nearest")+",miplinear>\nmul "+t+".xyz, "+t+", "+weightRegister+"\n",null!=this._iModulateMethod&&(code+=this._iModulateMethod(shaderObject,methodVO,t,registerCache,sharedRegisters)),this._pIsFirstLight||(code+="add "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+t+"\n",registerCache.removeFragmentTempUsage(t)),this._pIsFirstLight=!1,code},SpecularBasicMethod.prototype.iGetFragmentPostLightingCode=function(shaderObject,methodVO,targetReg,registerCache,sharedRegisters){var code="";return sharedRegisters.shadowTarget&&(code+="mul "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+sharedRegisters.shadowTarget+".w\n"),this._pUseTexture&&(code+="mul "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+this._pSpecularTexData+".x\n",registerCache.removeFragmentTempUsage(this._pSpecularTexData)),code+="mul "+this._pTotalLightColorReg+".xyz, "+this._pTotalLightColorReg+", "+this._pSpecularDataRegister+"\nadd "+targetReg+".xyz, "+targetReg+", "+this._pTotalLightColorReg+"\n",registerCache.removeFragmentTempUsage(this._pTotalLightColorReg),code},SpecularBasicMethod.prototype.iActivate=function(shaderObject,methodVO,stage){this._pUseTexture&&(stage.context.setSamplerStateAt(methodVO.texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),stage.context.activateTexture(methodVO.texturesIndex,this._texture));var index=methodVO.fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=this._iSpecularR,data[index+1]=this._iSpecularG,data[index+2]=this._iSpecularB,data[index+3]=this._gloss},SpecularBasicMethod.prototype.updateSpecular=function(){this._iSpecularR=(this._specularColor>>16&255)/255*this._specular,this._iSpecularG=(this._specularColor>>8&255)/255*this._specular,this._iSpecularB=(255&this._specularColor)/255*this._specular},SpecularBasicMethod}(materials.LightingMethodBase);materials.SpecularBasicMethod=SpecularBasicMethod}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var BlendMode=away.base.BlendMode,ArgumentError=away.errors.ArgumentError,Event=away.events.Event,ContextGLBlendFactor=away.stagegl.ContextGLBlendFactor,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,ContextGLTriangleFace=away.stagegl.ContextGLTriangleFace,MaterialPassBase=function(_super){function MaterialPassBase(passMode){"undefined"==typeof passMode&&(passMode=3);var _this=this;_super.call(this),this._maxLights=3,this._includeCasters=!0,this._forceSeparateMVP=!1,this._directionalLightsOffset=0,this._pointLightsOffset=0,this._lightProbesOffset=0,this._pNumPointLights=0,this._pNumDirectionalLights=0,this._pNumLightProbes=0,this._pNumLights=0,this._materialPassVOs=new Object,this._depthCompareMode=ContextGLCompareMode.LESS_EQUAL,this._blendFactorSource=ContextGLBlendFactor.ONE,this._blendFactorDest=ContextGLBlendFactor.ZERO,this._pEnableBlending=!1,this._defaultCulling=ContextGLTriangleFace.BACK,this._writeDepth=!0,this._passMode=passMode,this._onLightsChangeDelegate=function(event){return _this.onLightsChange(event)}}return __extends(MaterialPassBase,_super),Object.defineProperty(MaterialPassBase.prototype,"includeCasters",{get:function(){return this._includeCasters},set:function(value){this._includeCasters!=value&&(this._includeCasters=value,this.iInvalidateShaderProgram())},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"forceSeparateMVP",{get:function(){return this._forceSeparateMVP},set:function(value){this._forceSeparateMVP!=value&&(this._forceSeparateMVP=value,this.iInvalidateShaderProgram())},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"directionalLightsOffset",{get:function(){return this._directionalLightsOffset},set:function(value){this._directionalLightsOffset=value},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"pointLightsOffset",{get:function(){return this._pointLightsOffset},set:function(value){this._pointLightsOffset=value},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"lightProbesOffset",{get:function(){return this._lightProbesOffset},set:function(value){this._lightProbesOffset=value},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"passMode",{get:function(){return this._passMode},set:function(value){this._passMode=value,this.iInvalidateShaderProgram()},enumerable:!0,configurable:!0}),MaterialPassBase.prototype.createShaderObject=function(profile){return new materials.ShaderObjectBase(profile)},Object.defineProperty(MaterialPassBase.prototype,"writeDepth",{get:function(){return this._writeDepth},set:function(value){this._writeDepth=value},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"depthCompareMode",{get:function(){return this._depthCompareMode},set:function(value){this._depthCompareMode=value},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"renderToTexture",{get:function(){return this._renderToTexture},enumerable:!0,configurable:!0}),MaterialPassBase.prototype.dispose=function(){this._pLightPicker&&this._pLightPicker.removeEventListener(Event.CHANGE,this._onLightsChangeDelegate);for(var key in this._materialPassVOs)this._materialPassVOs[key].dispose();this._materialPassVOs=null},MaterialPassBase.prototype.getMaterialPassVO=function(materialId){return this._materialPassVOs[materialId]},MaterialPassBase.prototype.iRender=function(renderable,stage,camera,viewProjection){this.setRenderState(renderable,stage,camera,viewProjection)},MaterialPassBase.prototype.setRenderState=function(renderable,stage,camera,viewProjection){this._pActiveShaderObject.shaderObject.setRenderState(renderable,stage,camera,viewProjection)},MaterialPassBase.prototype.setBlendMode=function(value){switch(value){case BlendMode.NORMAL:this._blendFactorSource=ContextGLBlendFactor.ONE,this._blendFactorDest=ContextGLBlendFactor.ZERO,this._pEnableBlending=!1;break;case BlendMode.LAYER:this._blendFactorSource=ContextGLBlendFactor.SOURCE_ALPHA,this._blendFactorDest=ContextGLBlendFactor.ONE_MINUS_SOURCE_ALPHA,this._pEnableBlending=!0;break;case BlendMode.MULTIPLY:this._blendFactorSource=ContextGLBlendFactor.ZERO,this._blendFactorDest=ContextGLBlendFactor.SOURCE_COLOR,this._pEnableBlending=!0;break;case BlendMode.ADD:this._blendFactorSource=ContextGLBlendFactor.SOURCE_ALPHA,this._blendFactorDest=ContextGLBlendFactor.ONE,this._pEnableBlending=!0;break;case BlendMode.ALPHA:this._blendFactorSource=ContextGLBlendFactor.ZERO,this._blendFactorDest=ContextGLBlendFactor.SOURCE_ALPHA,this._pEnableBlending=!0;break;default:throw new ArgumentError("Unsupported blend mode!")}},MaterialPassBase.prototype.iActivate=function(material,stage,camera){var context=stage.context;context.setDepthTest(this._writeDepth&&!this._pEnableBlending,this._depthCompareMode),this._pEnableBlending&&context.setBlendFactors(this._blendFactorSource,this._blendFactorDest),this._pActiveShaderObject=context.getShaderObject(this._materialPassVOs[material.id],stage.profile),context.activateShaderObject(this._pActiveShaderObject,stage,camera),this._pActiveShaderObject.shaderObject.usesAnimation&&material.animationSet.activate(this._pActiveShaderObject.shaderObject,stage),context.setCulling(this._pActiveShaderObject.shaderObject.useBothSides?ContextGLTriangleFace.NONE:this._defaultCulling,camera.projection.coordinateSystem),this._renderToTexture&&(this._oldTarget=stage.renderTarget,this._oldSurface=stage.renderSurfaceSelector,this._oldDepthStencil=stage.enableDepthAndStencil,this._oldRect=stage.scissorRect)},MaterialPassBase.prototype.iDeactivate=function(material,stage){this._pActiveShaderObject.shaderObject.usesAnimation&&material.animationSet.deactivate(this._pActiveShaderObject.shaderObject,stage),stage.context.deactivateShaderObject(this._pActiveShaderObject,stage),this._renderToTexture&&(stage.context.setRenderTarget(this._oldTarget,this._oldDepthStencil,this._oldSurface),stage.scissorRect=this._oldRect),stage.context.setDepthTest(!0,ContextGLCompareMode.LESS_EQUAL)},MaterialPassBase.prototype.iInvalidateShaderProgram=function(updateMaterial){"undefined"==typeof updateMaterial&&(updateMaterial=!0);for(var key in this._materialPassVOs)this._materialPassVOs[key].invalidate();updateMaterial&&this.dispatchEvent(new Event(Event.CHANGE))},Object.defineProperty(MaterialPassBase.prototype,"lightPicker",{get:function(){return this._pLightPicker},set:function(value){this._pLightPicker&&this._pLightPicker.removeEventListener(Event.CHANGE,this._onLightsChangeDelegate),this._pLightPicker=value,this._pLightPicker&&this._pLightPicker.addEventListener(Event.CHANGE,this._onLightsChangeDelegate),this.pUpdateLights()},enumerable:!0,configurable:!0}),MaterialPassBase.prototype.onLightsChange=function(){this.pUpdateLights()},MaterialPassBase.prototype.pUpdateLights=function(){var numDirectionalLightsOld=this._pNumDirectionalLights,numPointLightsOld=this._pNumPointLights,numLightProbesOld=this._pNumLightProbes;this._pLightPicker&&this._passMode&materials.MaterialPassMode.LIGHTING?(this._pNumDirectionalLights=this.calculateNumDirectionalLights(this._pLightPicker.numDirectionalLights),this._pNumPointLights=this.calculateNumPointLights(this._pLightPicker.numPointLights),this._pNumLightProbes=this.calculateNumProbes(this._pLightPicker.numLightProbes),this._includeCasters&&(this._pNumDirectionalLights+=this._pLightPicker.numCastingDirectionalLights,this._pNumPointLights+=this._pLightPicker.numCastingPointLights)):(this._pNumDirectionalLights=0,this._pNumPointLights=0,this._pNumLightProbes=0),this._pNumLights=this._pNumDirectionalLights+this._pNumPointLights,(numDirectionalLightsOld!=this._pNumDirectionalLights||numPointLightsOld!=this._pNumPointLights||numLightProbesOld!=this._pNumLightProbes)&&this.iInvalidateShaderProgram()},MaterialPassBase.prototype._iIncludeDependencies=function(shaderObject){shaderObject.outputsNormals=this._pOutputsNormals(shaderObject),shaderObject.outputsTangentNormals=shaderObject.outputsNormals&&this._pOutputsTangentNormals(shaderObject),shaderObject.usesTangentSpace=shaderObject.outputsTangentNormals&&this._pUsesTangentSpace(shaderObject),shaderObject.usesTangentSpace||shaderObject.addWorldSpaceDependencies(Boolean(this._passMode&materials.MaterialPassMode.EFFECTS))},MaterialPassBase.prototype._iInitConstantData=function(){},MaterialPassBase.prototype._iAddOwner=function(owner){this._materialPassVOs[owner.id]||(this._materialPassVOs[owner.id]=new materials.MaterialPassVO(owner,this))},MaterialPassBase.prototype._iRemoveOwner=function(owner){this._materialPassVOs[owner.id]&&(this._materialPassVOs[owner.id].dispose(),delete this._materialPassVOs[owner.id])},MaterialPassBase.prototype._iGetPreVertexCode=function(){return""},MaterialPassBase.prototype._iGetPreFragmentCode=function(){return""},MaterialPassBase.prototype._iGetVertexCode=function(){return""},MaterialPassBase.prototype._iGetFragmentCode=function(){return""},MaterialPassBase.prototype._iGetNormalVertexCode=function(){return""},MaterialPassBase.prototype._iGetNormalFragmentCode=function(){return""},Object.defineProperty(MaterialPassBase.prototype,"iNumPointLights",{get:function(){return this._pNumPointLights},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"iNumDirectionalLights",{get:function(){return this._pNumDirectionalLights},enumerable:!0,configurable:!0}),Object.defineProperty(MaterialPassBase.prototype,"iNumLightProbes",{get:function(){return this._pNumLightProbes},enumerable:!0,configurable:!0}),MaterialPassBase.prototype._pOutputsNormals=function(){return!1},MaterialPassBase.prototype._pOutputsTangentNormals=function(){return!1},MaterialPassBase.prototype._pUsesTangentSpace=function(){return!1},MaterialPassBase.prototype.calculateNumDirectionalLights=function(numDirectionalLights){return Math.min(numDirectionalLights-this._directionalLightsOffset,this._maxLights)},MaterialPassBase.prototype.calculateNumPointLights=function(numPointLights){var numFree=this._maxLights-this._pNumDirectionalLights;return Math.min(numPointLights-this._pointLightsOffset,numFree)},MaterialPassBase.prototype.calculateNumProbes=function(numLightProbes){var numChannels=0;return Math.min(numLightProbes-this._lightProbesOffset,4/numChannels|0)},MaterialPassBase}(away.events.EventDispatcher);materials.MaterialPassBase=MaterialPassBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var MaterialPassVO=function(){function MaterialPassVO(material,materialPass){this._shaderObjectData=new Array,this.material=material,this.materialPass=materialPass,this._iUniqueId=MaterialPassVO.MATERIALPASS_ID_COUNT++}return MaterialPassVO.prototype.invalidate=function(){for(var len=this._shaderObjectData.length,i=0;len>i;i++)this._shaderObjectData[i].invalidate()},MaterialPassVO.prototype.dispose=function(){for(;this._shaderObjectData.length;)this._shaderObjectData[0].dispose();this.material=null,this.materialPass=null},MaterialPassVO.prototype._iAddShaderObjectData=function(shaderObjectData){return this._shaderObjectData.push(shaderObjectData),shaderObjectData},MaterialPassVO.prototype._iRemoveShaderObjectData=function(shaderObjectData){return this._shaderObjectData.splice(this._shaderObjectData.indexOf(shaderObjectData),1),shaderObjectData},MaterialPassVO.prototype.calculateID=function(){this._iRenderOrderId=0;for(var len=this._shaderObjectData.length,i=0;len>i;i++)this._iRenderOrderId+=this._shaderObjectData[i].programData.id},MaterialPassVO.MATERIALPASS_ID_COUNT=0,MaterialPassVO}();materials.MaterialPassVO=MaterialPassVO}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var LineSubGeometry=away.base.LineSubGeometry,Matrix3D=away.geom.Matrix3D,ContextGLProgramType=away.stagegl.ContextGLProgramType,LineBasicPass=function(_super){function LineBasicPass(){_super.call(this),this._constants=new Array(0,0,0,0),this._calcMatrix=new Matrix3D,this._constants[1]=1/255}return __extends(LineBasicPass,_super),Object.defineProperty(LineBasicPass.prototype,"thickness",{get:function(){return this._thickness},set:function(value){this._thickness=value},enumerable:!0,configurable:!0}),LineBasicPass.prototype._iGetVertexCode=function(){return"m44 vt0, va0, vc8			\nm44 vt1, va1, vc8			\nsub vt2, vt1, vt0 			\nslt vt5.x, vt0.z, vc7.z			\nsub vt5.y, vc5.x, vt5.x			\nadd vt4.x, vt0.z, vc7.z			\nsub vt4.y, vt0.z, vt1.z			\nseq vt4.z, vt4.y vc6.x			\nadd vt4.y, vt4.y, vt4.z			\ndiv vt4.z, vt4.x, vt4.y			\nmul vt4.xyz, vt4.zzz, vt2.xyz	\nadd vt3.xyz, vt0.xyz, vt4.xyz	\nmov vt3.w, vc5.x			\nmul vt0, vt0, vt5.yyyy			\nmul vt3, vt3, vt5.xxxx			\nadd vt0, vt0, vt3				\nsub vt2, vt1, vt0 			\nnrm vt2.xyz, vt2.xyz			\nnrm vt5.xyz, vt0.xyz			\nmov vt5.w, vc5.x				\ncrs vt3.xyz, vt2, vt5			\nnrm vt3.xyz, vt3.xyz			\nmul vt3.xyz, vt3.xyz, va2.xxx	\nmov vt3.w, vc5.x			\ndp3 vt4.x, vt0, vc6			\nmul vt4.x, vt4.x, vc7.x			\nmul vt3.xyz, vt3.xyz, vt4.xxx	\nadd vt0.xyz, vt0.xyz, vt3.xyz	\nm44 op, vt0, vc0			\nmov v0, va3				\n"},LineBasicPass.prototype._iGetFragmentCode=function(shaderObject,regCache,sharedReg){var targetReg=sharedReg.shadedTarget;return"mov "+targetReg+", v0\n"},LineBasicPass.prototype.iRender=function(renderable,stage,camera){var context=stage.context;this._calcMatrix.copyFrom(renderable.sourceEntity.sceneTransform),this._calcMatrix.append(camera.inverseSceneTransform),context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX,8,this._calcMatrix,!0),context.activateBuffer(0,renderable.getVertexData(LineSubGeometry.START_POSITION_DATA),renderable.getVertexOffset(LineSubGeometry.START_POSITION_DATA),LineSubGeometry.POSITION_FORMAT),context.activateBuffer(1,renderable.getVertexData(LineSubGeometry.END_POSITION_DATA),renderable.getVertexOffset(LineSubGeometry.END_POSITION_DATA),LineSubGeometry.POSITION_FORMAT),context.activateBuffer(2,renderable.getVertexData(LineSubGeometry.THICKNESS_DATA),renderable.getVertexOffset(LineSubGeometry.THICKNESS_DATA),LineSubGeometry.THICKNESS_FORMAT),context.activateBuffer(3,renderable.getVertexData(LineSubGeometry.COLOR_DATA),renderable.getVertexOffset(LineSubGeometry.COLOR_DATA),LineSubGeometry.COLOR_FORMAT),context.drawTriangles(context.getIndexBuffer(renderable.getIndexData()),0,renderable.numTriangles)},LineBasicPass.prototype.iActivate=function(material,stage,camera){var context=stage.context;_super.prototype.iActivate.call(this,material,stage,camera),this._constants[0]=this._thickness/(stage.scissorRect?Math.min(stage.scissorRect.width,stage.scissorRect.height):Math.min(stage.width,stage.height)),this._constants[2]=camera.projection.near,context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX,5,LineBasicPass.pONE_VECTOR,1),context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX,6,LineBasicPass.pFRONT_VECTOR,1),context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX,7,this._constants,1),context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX,0,camera.projection.matrix,!0)},LineBasicPass.prototype.pDeactivate=function(material,stage){var context=stage.context;context.setVertexBufferAt(0,null),context.setVertexBufferAt(1,null),context.setVertexBufferAt(2,null),context.setVertexBufferAt(3,null)},LineBasicPass.pONE_VECTOR=Array(1,1,1,1),LineBasicPass.pFRONT_VECTOR=Array(0,0,-1,0),LineBasicPass}(materials.MaterialPassBase);materials.LineBasicPass=LineBasicPass}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var TriangleSubGeometry=away.base.TriangleSubGeometry,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLProgramType=away.stagegl.ContextGLProgramType,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,SkyboxPass=function(_super){function SkyboxPass(){_super.call(this),this._vertexData=new Array(0,0,0,0,1,1,1,1)}return __extends(SkyboxPass,_super),Object.defineProperty(SkyboxPass.prototype,"cubeTexture",{get:function(){return this._cubeTexture},set:function(value){this._cubeTexture=value},enumerable:!0,configurable:!0}),SkyboxPass.prototype._iIncludeDependencies=function(shaderObject){shaderObject.useMipmapping=!1},SkyboxPass.prototype._iGetPreVertexCode=function(){return"mul vt0, va0, vc5\nadd vt0, vt0, vc4\nm44 op, vt0, vc0\nmov v0, va0\n"},SkyboxPass.prototype._iGetFragmentCode=function(){var mip=",mipnone";return this._cubeTexture.hasMipmaps&&(mip=",miplinear"),"tex ft0, v0, fs0 <cube,"+materials.ShaderCompilerHelper.getFormatStringForTexture(this._cubeTexture)+"linear,clamp"+mip+">\n"},SkyboxPass.prototype.iRender=function(renderable,stage,camera,viewProjection){var context=stage.context,pos=camera.scenePosition;this._vertexData[0]=pos.x,this._vertexData[1]=pos.y,this._vertexData[2]=pos.z,this._vertexData[4]=this._vertexData[5]=this._vertexData[6]=camera.projection.far/Math.sqrt(3),context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX,0,viewProjection,!0),context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX,4,this._vertexData,2),context.activateBuffer(0,renderable.getVertexData(TriangleSubGeometry.POSITION_DATA),renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA),TriangleSubGeometry.POSITION_FORMAT),context.drawTriangles(context.getIndexBuffer(renderable.getIndexData()),0,renderable.numTriangles)},SkyboxPass.prototype.iActivate=function(material,stage,camera){_super.prototype.iActivate.call(this,material,stage,camera);var context=stage.context;context.setSamplerStateAt(0,ContextGLWrapMode.CLAMP,ContextGLTextureFilter.LINEAR,this._cubeTexture.hasMipmaps?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),context.setDepthTest(!1,ContextGLCompareMode.LESS),context.activateCubeTexture(0,this._cubeTexture)},SkyboxPass}(materials.MaterialPassBase);materials.SkyboxPass=SkyboxPass}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var TriangleSubGeometry=away.base.TriangleSubGeometry,Matrix3DUtils=away.geom.Matrix3DUtils,ContextGLProgramType=away.stagegl.ContextGLProgramType,TrianglePassBase=function(_super){function TrianglePassBase(passMode){"undefined"==typeof passMode&&(passMode=3),_super.call(this,passMode),this._preserveAlpha=!0}return __extends(TrianglePassBase,_super),Object.defineProperty(TrianglePassBase.prototype,"preserveAlpha",{get:function(){return this._preserveAlpha},set:function(value){this._preserveAlpha!=value&&(this._preserveAlpha=value,this.iInvalidateShaderProgram())},enumerable:!0,configurable:!0}),TrianglePassBase.prototype._iGetPreVertexCode=function(shaderObject,registerCache,sharedRegisters){var code="",position=shaderObject.globalPosDependencies>0||this.forceSeparateMVP?sharedRegisters.globalPositionVertex:sharedRegisters.localPosition,viewMatrixReg=registerCache.getFreeVertexConstant();if(registerCache.getFreeVertexConstant(),registerCache.getFreeVertexConstant(),registerCache.getFreeVertexConstant(),shaderObject.viewMatrixIndex=4*viewMatrixReg.index,shaderObject.projectionDependencies>0){sharedRegisters.projectionFragment=registerCache.getFreeVarying();var temp=registerCache.getFreeVertexVectorTemp();code+="m44 "+temp+", "+position+", "+viewMatrixReg+"\nmov "+sharedRegisters.projectionFragment+", "+temp+"\nmov op, "+temp+"\n"}else code+="m44 op, "+position+", "+viewMatrixReg+"\n";return code},TrianglePassBase.prototype.iRender=function(renderable,stage,camera,viewProjection){_super.prototype.iRender.call(this,renderable,stage,camera,viewProjection);var shaderObject=this._pActiveShaderObject.shaderObject;if(shaderObject.sceneMatrixIndex>=0)renderable.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shaderObject.vertexConstantData,shaderObject.sceneMatrixIndex,!0),viewProjection.copyRawDataTo(shaderObject.vertexConstantData,shaderObject.viewMatrixIndex,!0);else{var matrix3D=Matrix3DUtils.CALCULATION_MATRIX;matrix3D.copyFrom(renderable.sourceEntity.getRenderSceneTransform(camera)),matrix3D.append(viewProjection),matrix3D.copyRawDataTo(shaderObject.vertexConstantData,shaderObject.viewMatrixIndex,!0)}var context=stage.context;context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX,0,shaderObject.vertexConstantData,shaderObject.numUsedVertexConstants),context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT,0,shaderObject.fragmentConstantData,shaderObject.numUsedFragmentConstants),context.activateBuffer(0,renderable.getVertexData(TriangleSubGeometry.POSITION_DATA),renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA),TriangleSubGeometry.POSITION_FORMAT),context.drawTriangles(context.getIndexBuffer(renderable.getIndexData()),0,renderable.numTriangles)
},TrianglePassBase}(materials.MaterialPassBase);materials.TrianglePassBase=TrianglePassBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,TriangleBasicPass=function(_super){function TriangleBasicPass(){_super.call(this),this._diffuseColor=16777215,this._diffuseR=1,this._diffuseG=1,this._diffuseB=1,this._diffuseA=1}return __extends(TriangleBasicPass,_super),Object.defineProperty(TriangleBasicPass.prototype,"diffuseAlpha",{get:function(){return this._diffuseA},set:function(value){this._diffuseA=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleBasicPass.prototype,"diffuseColor",{get:function(){return this._diffuseColor},set:function(diffuseColor){this._diffuseColor=diffuseColor,this._diffuseR=(this._diffuseColor>>16&255)/255,this._diffuseG=(this._diffuseColor>>8&255)/255,this._diffuseB=(255&this._diffuseColor)/255},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleBasicPass.prototype,"texture",{get:function(){return this._pTexture},set:function(value){var b=null!=value;(b!=this._pUseTexture||value&&this._pTexture&&(value.hasMipmaps!=this._pTexture.hasMipmaps||value.format!=this._pTexture.format))&&this.iInvalidateShaderProgram(),this._pUseTexture=b,this._pTexture=value},enumerable:!0,configurable:!0}),TriangleBasicPass.prototype._iGetFragmentCode=function(shaderObject,regCache,sharedReg){var diffuseInputReg,code="",targetReg=sharedReg.shadedTarget;if(this._pUseTexture){if(diffuseInputReg=regCache.getFreeTextureReg(),this._texturesIndex=diffuseInputReg.index,code+=materials.ShaderCompilerHelper.getTex2DSampleCode(targetReg,sharedReg,diffuseInputReg,this._pTexture,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping),shaderObject.alphaThreshold>0){var cutOffReg=regCache.getFreeFragmentConstant();this._fragmentConstantsIndex=4*cutOffReg.index,code+="sub "+targetReg+".w, "+targetReg+".w, "+cutOffReg+".x\nkil "+targetReg+".w\nadd "+targetReg+".w, "+targetReg+".w, "+cutOffReg+".x\n"}}else diffuseInputReg=regCache.getFreeFragmentConstant(),this._fragmentConstantsIndex=4*diffuseInputReg.index,code+="mov "+targetReg+", "+diffuseInputReg+"\n";return code},TriangleBasicPass.prototype._iIncludeDependencies=function(dependencyCounter){this._pUseTexture&&dependencyCounter.uvDependencies++},TriangleBasicPass.prototype.iActivate=function(material,stage,camera){_super.prototype.iActivate.call(this,material,stage,camera);var shaderObject=this._pActiveShaderObject.shaderObject;if(this._pUseTexture)stage.context.setSamplerStateAt(this._texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),stage.context.activateTexture(this._texturesIndex,this._pTexture),this._pActiveShaderObject.shaderObject.alphaThreshold>0&&(shaderObject.fragmentConstantData[this._fragmentConstantsIndex]=this._pActiveShaderObject.shaderObject.alphaThreshold);else{var index=this._fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=this._diffuseR,data[index+1]=this._diffuseG,data[index+2]=this._diffuseB,data[index+3]=this._diffuseA}},TriangleBasicPass}(materials.TrianglePassBase);materials.TriangleBasicPass=TriangleBasicPass}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,DepthMapPass=function(_super){function DepthMapPass(){_super.call(this)}return __extends(DepthMapPass,_super),DepthMapPass.prototype._iInitConstantData=function(shaderObject){_super.prototype._iInitConstantData.call(this,shaderObject);var index=this._fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=1,data[index+1]=255,data[index+2]=65025,data[index+3]=16581375,data[index+4]=1/255,data[index+5]=1/255,data[index+6]=1/255,data[index+7]=0},Object.defineProperty(DepthMapPass.prototype,"alphaMask",{get:function(){return this._alphaMask},set:function(value){this._alphaMask=value},enumerable:!0,configurable:!0}),DepthMapPass.prototype._iIncludeDependencies=function(shaderObject){shaderObject.projectionDependencies++,shaderObject.alphaThreshold>0&&shaderObject.uvDependencies++},DepthMapPass.prototype._iGetFragmentCode=function(shaderObject,registerCache,sharedRegisters){var code="",targetReg=sharedRegisters.shadedTarget,diffuseInputReg=registerCache.getFreeTextureReg(),dataReg1=registerCache.getFreeFragmentConstant(),dataReg2=registerCache.getFreeFragmentConstant();this._fragmentConstantsIndex=4*dataReg1.index;var temp1=registerCache.getFreeFragmentVectorTemp();registerCache.addFragmentTempUsages(temp1,1);var temp2=registerCache.getFreeFragmentVectorTemp();if(registerCache.addFragmentTempUsages(temp2,1),code+="div "+temp1+", "+sharedRegisters.projectionFragment+", "+sharedRegisters.projectionFragment+".w\nmul "+temp1+", "+dataReg1+", "+temp1+".z\nfrc "+temp1+", "+temp1+"\nmul "+temp2+", "+temp1+".yzww, "+dataReg2+"\n",shaderObject.alphaThreshold>0){diffuseInputReg=registerCache.getFreeTextureReg(),this._texturesIndex=diffuseInputReg.index;var albedo=registerCache.getFreeFragmentVectorTemp();code+=materials.ShaderCompilerHelper.getTex2DSampleCode(albedo,sharedRegisters,diffuseInputReg,this._alphaMask,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping);var cutOffReg=registerCache.getFreeFragmentConstant();code+="sub "+albedo+".w, "+albedo+".w, "+cutOffReg+".x\nkil "+albedo+".w\n"}return code+="sub "+targetReg+", "+temp1+", "+temp2+"\n",registerCache.removeFragmentTempUsage(temp1),registerCache.removeFragmentTempUsage(temp2),code},DepthMapPass.prototype.iActivate=function(material,stage,camera){_super.prototype.iActivate.call(this,material,stage,camera);var context=stage.context,shaderObject=this._pActiveShaderObject.shaderObject;shaderObject.alphaThreshold>0&&(context.setSamplerStateAt(this._texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),context.activateTexture(this._texturesIndex,this._alphaMask),shaderObject.fragmentConstantData[this._fragmentConstantsIndex+8]=this._pActiveShaderObject.shaderObject.alphaThreshold)},DepthMapPass}(materials.TrianglePassBase);materials.DepthMapPass=DepthMapPass}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLMipFilter=away.stagegl.ContextGLMipFilter,ContextGLTextureFilter=away.stagegl.ContextGLTextureFilter,ContextGLWrapMode=away.stagegl.ContextGLWrapMode,DistanceMapPass=function(_super){function DistanceMapPass(){_super.call(this)}return __extends(DistanceMapPass,_super),DistanceMapPass.prototype._iInitConstantData=function(shaderObject){_super.prototype._iInitConstantData.call(this,shaderObject);var index=this._fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index+4]=1/255,data[index+5]=1/255,data[index+6]=1/255,data[index+7]=0},Object.defineProperty(DistanceMapPass.prototype,"alphaMask",{get:function(){return this._alphaMask},set:function(value){this._alphaMask=value},enumerable:!0,configurable:!0}),DistanceMapPass.prototype._iIncludeDependencies=function(shaderObject){shaderObject.projectionDependencies++,shaderObject.viewDirDependencies++,shaderObject.alphaThreshold>0&&shaderObject.uvDependencies++,shaderObject.addWorldSpaceDependencies(!1)},DistanceMapPass.prototype._iGetFragmentCode=function(shaderObject,registerCache,sharedRegisters){var code,targetReg=sharedRegisters.shadedTarget,diffuseInputReg=registerCache.getFreeTextureReg(),dataReg1=registerCache.getFreeFragmentConstant(),dataReg2=registerCache.getFreeFragmentConstant();this._fragmentConstantsIndex=4*dataReg1.index;var temp1=registerCache.getFreeFragmentVectorTemp();registerCache.addFragmentTempUsages(temp1,1);var temp2=registerCache.getFreeFragmentVectorTemp();if(registerCache.addFragmentTempUsages(temp2,1),code="dp3 "+temp1+".z, "+sharedRegisters.viewDirVarying+".xyz, "+sharedRegisters.viewDirVarying+".xyz\nmul "+temp1+", "+dataReg1+", "+temp1+".z\nfrc "+temp1+", "+temp1+"\nmul "+temp2+", "+temp1+".yzww, "+dataReg2+"\n",shaderObject.alphaThreshold>0){diffuseInputReg=registerCache.getFreeTextureReg(),this._texturesIndex=diffuseInputReg.index;var albedo=registerCache.getFreeFragmentVectorTemp();code+=materials.ShaderCompilerHelper.getTex2DSampleCode(albedo,sharedRegisters,diffuseInputReg,this._alphaMask,shaderObject.useSmoothTextures,shaderObject.repeatTextures,shaderObject.useMipmapping);var cutOffReg=registerCache.getFreeFragmentConstant();code+="sub "+albedo+".w, "+albedo+".w, "+cutOffReg+".x\nkil "+albedo+".w\n"}return code+="sub "+targetReg+", "+temp1+", "+temp2+"\n"},DistanceMapPass.prototype.iActivate=function(material,stage,camera){_super.prototype.iActivate.call(this,material,stage,camera);var context=stage.context,shaderObject=this._pActiveShaderObject.shaderObject,f=camera.projection.far;f=1/(2*f*f);var index=this._fragmentConstantsIndex,data=shaderObject.fragmentConstantData;data[index]=1*f,data[index+1]=255*f,data[index+2]=65025*f,data[index+3]=16581375*f,shaderObject.alphaThreshold>0&&(context.setSamplerStateAt(this._texturesIndex,shaderObject.repeatTextures?ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP,shaderObject.useSmoothTextures?ContextGLTextureFilter.LINEAR:ContextGLTextureFilter.NEAREST,shaderObject.useMipmapping?ContextGLMipFilter.MIPLINEAR:ContextGLMipFilter.MIPNONE),context.activateTexture(this._texturesIndex,this._alphaMask),data[index+8]=this._pActiveShaderObject.shaderObject.alphaThreshold)},DistanceMapPass}(materials.TrianglePassBase);materials.DistanceMapPass=DistanceMapPass}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var MaterialPassMode=function(){function MaterialPassMode(){}return MaterialPassMode.EFFECTS=1,MaterialPassMode.LIGHTING=2,MaterialPassMode.SUPER_SHADER=3,MaterialPassMode}();materials.MaterialPassMode=MaterialPassMode}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ShadingMethodEvent=away.events.ShadingMethodEvent,TriangleMethodPass=function(_super){function TriangleMethodPass(passMode){"undefined"==typeof passMode&&(passMode=3);var _this=this;_super.call(this,passMode),this._iMethodVOs=new Array,this._numEffectDependencies=0,this._onShaderInvalidatedDelegate=function(event){return _this.onShaderInvalidated(event)}}return __extends(TriangleMethodPass,_super),TriangleMethodPass.prototype.createShaderObject=function(profile){return this._pLightPicker&&this.passMode&materials.MaterialPassMode.LIGHTING?new materials.ShaderLightingObject(profile):new materials.ShaderObjectBase(profile)},TriangleMethodPass.prototype._iInitConstantData=function(shaderObject){_super.prototype._iInitConstantData.call(this,shaderObject);for(var len=this._iMethodVOs.length,i=0;len>i;++i)this._iMethodVOs[i].method.iInitConstants(shaderObject,this._iMethodVOs[i])},Object.defineProperty(TriangleMethodPass.prototype,"colorTransform",{get:function(){return this.colorTransformMethod?this.colorTransformMethod.colorTransform:null},set:function(value){value?(null==this.colorTransformMethod&&(this.colorTransformMethod=new materials.EffectColorTransformMethod),this.colorTransformMethod.colorTransform=value):value||this.colorTransformMethod&&(this.colorTransformMethod=null)},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodPass.prototype,"colorTransformMethod",{get:function(){return this._iColorTransformMethodVO?this._iColorTransformMethodVO.method:null},set:function(value){this._iColorTransformMethodVO&&this._iColorTransformMethodVO.method==value||(this._iColorTransformMethodVO&&(this._removeDependency(this._iColorTransformMethodVO),this._iColorTransformMethodVO=null),value&&(this._iColorTransformMethodVO=new materials.MethodVO(value),this._addDependency(this._iColorTransformMethodVO)))},enumerable:!0,configurable:!0}),TriangleMethodPass.prototype._removeDependency=function(methodVO,effectsDependency){"undefined"==typeof effectsDependency&&(effectsDependency=!1);var index=this._iMethodVOs.indexOf(methodVO);effectsDependency||this._numEffectDependencies--,methodVO.method.removeEventListener(ShadingMethodEvent.SHADER_INVALIDATED,this._onShaderInvalidatedDelegate),this._iMethodVOs.splice(index,1),this.iInvalidateShaderProgram()},TriangleMethodPass.prototype._addDependency=function(methodVO,effectsDependency,index){"undefined"==typeof effectsDependency&&(effectsDependency=!1),"undefined"==typeof index&&(index=-1),methodVO.method.addEventListener(ShadingMethodEvent.SHADER_INVALIDATED,this._onShaderInvalidatedDelegate),effectsDependency?(-1!=index?this._iMethodVOs.splice(index+this._iMethodVOs.length-this._numEffectDependencies,0,methodVO):this._iMethodVOs.push(methodVO),this._numEffectDependencies++):this._iMethodVOs.splice(this._iMethodVOs.length-this._numEffectDependencies,0,methodVO),this.iInvalidateShaderProgram()},TriangleMethodPass.prototype.addEffectMethod=function(method){this._addDependency(new materials.MethodVO(method),!0)},Object.defineProperty(TriangleMethodPass.prototype,"numEffectMethods",{get:function(){return this._numEffectDependencies},enumerable:!0,configurable:!0}),TriangleMethodPass.prototype.hasEffectMethod=function(method){return null!=this.getDependencyForMethod(method)},TriangleMethodPass.prototype.getEffectMethodAt=function(index){return 0>index||index>this._numEffectDependencies-1?null:this._iMethodVOs[index+this._iMethodVOs.length-this._numEffectDependencies].method},TriangleMethodPass.prototype.addEffectMethodAt=function(method,index){this._addDependency(new materials.MethodVO(method),!0,index)},TriangleMethodPass.prototype.removeEffectMethod=function(method){var methodVO=this.getDependencyForMethod(method);null!=methodVO&&this._removeDependency(methodVO,!0)},TriangleMethodPass.prototype.getDependencyForMethod=function(method){for(var len=this._iMethodVOs.length,i=0;len>i;++i)if(this._iMethodVOs[i].method==method)return this._iMethodVOs[i];return null},Object.defineProperty(TriangleMethodPass.prototype,"normalMethod",{get:function(){return this._iNormalMethodVO?this._iNormalMethodVO.method:null},set:function(value){this._iNormalMethodVO&&this._iNormalMethodVO.method==value||(this._iNormalMethodVO&&(this._removeDependency(this._iNormalMethodVO),this._iNormalMethodVO=null),value&&(this._iNormalMethodVO=new materials.MethodVO(value),this._addDependency(this._iNormalMethodVO)))},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodPass.prototype,"ambientMethod",{get:function(){return this._iAmbientMethodVO?this._iAmbientMethodVO.method:null},set:function(value){this._iAmbientMethodVO&&this._iAmbientMethodVO.method==value||(this._iAmbientMethodVO&&(this._removeDependency(this._iAmbientMethodVO),this._iAmbientMethodVO=null),value&&(this._iAmbientMethodVO=new materials.MethodVO(value),this._addDependency(this._iAmbientMethodVO)))},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodPass.prototype,"shadowMethod",{get:function(){return this._iShadowMethodVO?this._iShadowMethodVO.method:null},set:function(value){this._iShadowMethodVO&&this._iShadowMethodVO.method==value||(this._iShadowMethodVO&&(this._removeDependency(this._iShadowMethodVO),this._iShadowMethodVO=null),value&&(this._iShadowMethodVO=new materials.MethodVO(value),this._addDependency(this._iShadowMethodVO)))},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodPass.prototype,"diffuseMethod",{get:function(){return this._iDiffuseMethodVO?this._iDiffuseMethodVO.method:null},set:function(value){this._iDiffuseMethodVO&&this._iDiffuseMethodVO.method==value||(this._iDiffuseMethodVO&&(this._removeDependency(this._iDiffuseMethodVO),this._iDiffuseMethodVO=null),value&&(this._iDiffuseMethodVO=new materials.MethodVO(value),this._addDependency(this._iDiffuseMethodVO)))},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodPass.prototype,"specularMethod",{get:function(){return this._iSpecularMethodVO?this._iSpecularMethodVO.method:null},set:function(value){this._iSpecularMethodVO&&this._iSpecularMethodVO.method==value||(this._iSpecularMethodVO&&(this._removeDependency(this._iSpecularMethodVO),this._iSpecularMethodVO=null),value&&(this._iSpecularMethodVO=new materials.MethodVO(value),this._addDependency(this._iSpecularMethodVO)))},enumerable:!0,configurable:!0}),TriangleMethodPass.prototype.dispose=function(){for(_super.prototype.dispose.call(this);this._iMethodVOs.length;)this._removeDependency(this._iMethodVOs[0]);this._iMethodVOs=null},TriangleMethodPass.prototype.iInvalidateShaderProgram=function(updateMaterial){"undefined"==typeof updateMaterial&&(updateMaterial=!0),_super.prototype.iInvalidateShaderProgram.call(this,updateMaterial);var oldPasses=this._iPasses;this._iPasses=new Array;for(var i=0;i<this._iMethodVOs.length;++i)this.pAddPasses(this._iMethodVOs[i]);if(!oldPasses||this._iPasses.length!=oldPasses.length)return this._iPassesDirty=!0,void 0;for(var i=0;i<this._iPasses.length;++i)if(this._iPasses[i]!=oldPasses[i])return this._iPassesDirty=!0,void 0},TriangleMethodPass.prototype.pAddPasses=function(methodVO){var passes=methodVO.method.passes;if(methodVO.useMethod&&passes)for(var len=passes.length,i=0;len>i;++i)passes[i].lightPicker=this._pLightPicker,this._iPasses.push(passes[i])},TriangleMethodPass.prototype.onShaderInvalidated=function(){this.iInvalidateShaderProgram()},TriangleMethodPass.prototype.iActivate=function(material,stage,camera){_super.prototype.iActivate.call(this,material,stage,camera);for(var methodVO,len=this._iMethodVOs.length,i=0;len>i;++i)methodVO=this._iMethodVOs[i],methodVO.useMethod&&methodVO.method.iActivate(this._pActiveShaderObject.shaderObject,methodVO,stage)},TriangleMethodPass.prototype.setRenderState=function(renderable,stage,camera,viewProjection){_super.prototype.setRenderState.call(this,renderable,stage,camera,viewProjection);for(var methodVO,len=this._iMethodVOs.length,i=0;len>i;++i)methodVO=this._iMethodVOs[i],methodVO.useMethod&&methodVO.method.iSetRenderState(this._pActiveShaderObject.shaderObject,methodVO,renderable,stage,camera)},TriangleMethodPass.prototype.iDeactivate=function(material,stage){_super.prototype.iDeactivate.call(this,material,stage);for(var methodVO,len=this._iMethodVOs.length,i=0;len>i;++i)methodVO=this._iMethodVOs[i],methodVO.useMethod&&methodVO.method.iDeactivate(this._pActiveShaderObject.shaderObject,methodVO,stage)},TriangleMethodPass.prototype._iIncludeDependencies=function(shaderObject){var i,len=this._iMethodVOs.length;for(i=0;len>i;++i)this.setupAndCountDependencies(shaderObject,this._iMethodVOs[i]);for(i=0;len>i;++i)this._iMethodVOs[i].useMethod=this._iMethodVOs[i].method.iIsUsed(shaderObject);_super.prototype._iIncludeDependencies.call(this,shaderObject)},TriangleMethodPass.prototype.setupAndCountDependencies=function(shaderObject,methodVO){methodVO.reset(),methodVO.method.iInitVO(shaderObject,methodVO),methodVO.needsProjection&&shaderObject.projectionDependencies++,methodVO.needsGlobalVertexPos?(shaderObject.globalPosDependencies++,methodVO.needsGlobalFragmentPos&&(shaderObject.usesGlobalPosFragment=!0)):methodVO.needsGlobalFragmentPos&&(shaderObject.globalPosDependencies++,shaderObject.usesGlobalPosFragment=!0),methodVO.needsNormals&&shaderObject.normalDependencies++,methodVO.needsTangents&&shaderObject.tangentDependencies++,methodVO.needsView&&shaderObject.viewDirDependencies++,methodVO.needsUV&&shaderObject.uvDependencies++,methodVO.needsSecondaryUV&&shaderObject.secondaryUVDependencies++},TriangleMethodPass.prototype._iGetPreVertexCode=function(shaderObject,registerCache,sharedRegisters){var code=_super.prototype._iGetPreVertexCode.call(this,shaderObject,registerCache,sharedRegisters);return code+=this._iAmbientMethodVO.method.iGetVertexCode(shaderObject,this._iAmbientMethodVO,registerCache,sharedRegisters)},TriangleMethodPass.prototype._iGetPreFragmentCode=function(shaderObject,registerCache,sharedRegisters){var code=this._iAmbientMethodVO.method.iGetFragmentCode(shaderObject,this._iAmbientMethodVO,sharedRegisters.shadedTarget,registerCache,sharedRegisters);return this._iAmbientMethodVO.needsNormals&&registerCache.removeFragmentTempUsage(sharedRegisters.normalFragment),this._iAmbientMethodVO.needsView&&registerCache.removeFragmentTempUsage(sharedRegisters.viewDirFragment),code},TriangleMethodPass.prototype._iGetPreLightingVertexCode=function(shaderObject,registerCache,sharedRegisters){var code="";return this._iDiffuseMethodVO&&this._iDiffuseMethodVO.useMethod&&(code+=this._iDiffuseMethodVO.method.iGetVertexCode(shaderObject,this._iDiffuseMethodVO,registerCache,sharedRegisters)),this._iSpecularMethodVO&&this._iSpecularMethodVO.useMethod&&(code+=this._iSpecularMethodVO.method.iGetVertexCode(shaderObject,this._iSpecularMethodVO,registerCache,sharedRegisters)),code},TriangleMethodPass.prototype._iGetPreLightingFragmentCode=function(shaderObject,registerCache,sharedRegisters){var code="";return this._iDiffuseMethodVO&&this._iDiffuseMethodVO.useMethod&&(code+=this._iDiffuseMethodVO.method.iGetFragmentPreLightingCode(shaderObject,this._iDiffuseMethodVO,registerCache,sharedRegisters)),this._iSpecularMethodVO&&this._iSpecularMethodVO.useMethod&&(code+=this._iSpecularMethodVO.method.iGetFragmentPreLightingCode(shaderObject,this._iSpecularMethodVO,registerCache,sharedRegisters)),code},TriangleMethodPass.prototype._iGetPerLightDiffuseFragmentCode=function(shaderObject,lightDirReg,diffuseColorReg,registerCache,sharedRegisters){return this._iDiffuseMethodVO.method.iGetFragmentCodePerLight(shaderObject,this._iDiffuseMethodVO,lightDirReg,diffuseColorReg,registerCache,sharedRegisters)},TriangleMethodPass.prototype._iGetPerLightSpecularFragmentCode=function(shaderObject,lightDirReg,specularColorReg,registerCache,sharedRegisters){return this._iSpecularMethodVO.method.iGetFragmentCodePerLight(shaderObject,this._iSpecularMethodVO,lightDirReg,specularColorReg,registerCache,sharedRegisters)},TriangleMethodPass.prototype._iGetPerProbeDiffuseFragmentCode=function(shaderObject,texReg,weightReg,registerCache,sharedRegisters){return this._iDiffuseMethodVO.method.iGetFragmentCodePerProbe(shaderObject,this._iDiffuseMethodVO,texReg,weightReg,registerCache,sharedRegisters)},TriangleMethodPass.prototype._iGetPerProbeSpecularFragmentCode=function(shaderObject,texReg,weightReg,registerCache,sharedRegisters){return this._iSpecularMethodVO.method.iGetFragmentCodePerProbe(shaderObject,this._iSpecularMethodVO,texReg,weightReg,registerCache,sharedRegisters)},TriangleMethodPass.prototype._iGetPostLightingVertexCode=function(shaderObject,registerCache,sharedRegisters){var code="";return this._iShadowMethodVO&&(code+=this._iShadowMethodVO.method.iGetVertexCode(shaderObject,this._iShadowMethodVO,registerCache,sharedRegisters)),code},TriangleMethodPass.prototype._iGetPostLightingFragmentCode=function(shaderObject,registerCache,sharedRegisters){var code="";return shaderObject.useAlphaPremultiplied&&this._pEnableBlending&&(code+="add "+sharedRegisters.shadedTarget+".w, "+sharedRegisters.shadedTarget+".w, "+sharedRegisters.commons+".z\ndiv "+sharedRegisters.shadedTarget+".xyz, "+sharedRegisters.shadedTarget+", "+sharedRegisters.shadedTarget+".w\nsub "+sharedRegisters.shadedTarget+".w, "+sharedRegisters.shadedTarget+".w, "+sharedRegisters.commons+".z\nsat "+sharedRegisters.shadedTarget+".xyz, "+sharedRegisters.shadedTarget+"\n"),this._iShadowMethodVO&&(code+=this._iShadowMethodVO.method.iGetFragmentCode(shaderObject,this._iShadowMethodVO,sharedRegisters.shadowTarget,registerCache,sharedRegisters)),this._iDiffuseMethodVO&&this._iDiffuseMethodVO.useMethod&&(code+=this._iDiffuseMethodVO.method.iGetFragmentPostLightingCode(shaderObject,this._iDiffuseMethodVO,sharedRegisters.shadedTarget,registerCache,sharedRegisters),this._iDiffuseMethodVO.needsNormals&&registerCache.removeFragmentTempUsage(sharedRegisters.normalFragment),this._iDiffuseMethodVO.needsView&&registerCache.removeFragmentTempUsage(sharedRegisters.viewDirFragment)),this._iSpecularMethodVO&&this._iSpecularMethodVO.useMethod&&(code+=this._iSpecularMethodVO.method.iGetFragmentPostLightingCode(shaderObject,this._iSpecularMethodVO,sharedRegisters.shadedTarget,registerCache,sharedRegisters),this._iSpecularMethodVO.needsNormals&&registerCache.removeFragmentTempUsage(sharedRegisters.normalFragment),this._iSpecularMethodVO.needsView&&registerCache.removeFragmentTempUsage(sharedRegisters.viewDirFragment)),this._iShadowMethodVO&&registerCache.removeFragmentTempUsage(sharedRegisters.shadowTarget),code},TriangleMethodPass.prototype._pUsesTangentSpace=function(shaderObject){if(shaderObject.usesProbes)return!1;for(var methodVO,len=this._iMethodVOs.length,i=0;len>i;++i)if(methodVO=this._iMethodVOs[i],methodVO.useMethod&&!methodVO.method.iUsesTangentSpace())return!1;return!0},TriangleMethodPass.prototype._pOutputsTangentNormals=function(){return this._iNormalMethodVO.method.iOutputsTangentNormals()},TriangleMethodPass.prototype._pOutputsNormals=function(){return this._iNormalMethodVO&&this._iNormalMethodVO.useMethod},TriangleMethodPass.prototype._iGetNormalVertexCode=function(shaderObject,registerCache,sharedRegisters){return this._iNormalMethodVO.method.iGetVertexCode(shaderObject,this._iNormalMethodVO,registerCache,sharedRegisters)},TriangleMethodPass.prototype._iGetNormalFragmentCode=function(shaderObject,registerCache,sharedRegisters){var code=this._iNormalMethodVO.method.iGetFragmentCode(shaderObject,this._iNormalMethodVO,sharedRegisters.normalFragment,registerCache,sharedRegisters);return this._iNormalMethodVO.needsView&&registerCache.removeFragmentTempUsage(sharedRegisters.viewDirFragment),(this._iNormalMethodVO.needsGlobalFragmentPos||this._iNormalMethodVO.needsGlobalVertexPos)&&registerCache.removeVertexTempUsage(sharedRegisters.globalPositionVertex),code},TriangleMethodPass.prototype._iGetVertexCode=function(shaderObject,regCache,sharedReg){for(var methodVO,code="",len=this._iMethodVOs.length,i=len-this._numEffectDependencies;len>i;i++)methodVO=this._iMethodVOs[i],methodVO.useMethod&&(code+=methodVO.method.iGetVertexCode(shaderObject,methodVO,regCache,sharedReg),(methodVO.needsGlobalVertexPos||methodVO.needsGlobalFragmentPos)&&regCache.removeVertexTempUsage(sharedReg.globalPositionVertex));return this._iColorTransformMethodVO&&this._iColorTransformMethodVO.useMethod&&(code+=this._iColorTransformMethodVO.method.iGetVertexCode(shaderObject,this._iColorTransformMethodVO,regCache,sharedReg)),code},TriangleMethodPass.prototype._iGetFragmentCode=function(shaderObject,regCache,sharedReg){var alphaReg,code="";this._preserveAlpha&&this._numEffectDependencies>0&&(alphaReg=regCache.getFreeFragmentSingleTemp(),regCache.addFragmentTempUsages(alphaReg,1),code+="mov "+alphaReg+", "+sharedReg.shadedTarget+".w\n");for(var methodVO,len=this._iMethodVOs.length,i=len-this._numEffectDependencies;len>i;i++)methodVO=this._iMethodVOs[i],methodVO.useMethod&&(code+=methodVO.method.iGetFragmentCode(shaderObject,methodVO,sharedReg.shadedTarget,regCache,sharedReg),methodVO.needsNormals&&regCache.removeFragmentTempUsage(sharedReg.normalFragment),methodVO.needsView&&regCache.removeFragmentTempUsage(sharedReg.viewDirFragment));return this._preserveAlpha&&this._numEffectDependencies>0&&(code+="mov "+sharedReg.shadedTarget+".w, "+alphaReg+"\n",regCache.removeFragmentTempUsage(alphaReg)),this._iColorTransformMethodVO&&this._iColorTransformMethodVO.useMethod&&(code+=this._iColorTransformMethodVO.method.iGetFragmentCode(shaderObject,this._iColorTransformMethodVO,sharedReg.shadedTarget,regCache,sharedReg)),code},TriangleMethodPass.prototype._iUsesShadows=function(){return Boolean(this._iShadowMethodVO||this.lightPicker.castingDirectionalLights.length>0||this.lightPicker.castingPointLights.length>0)},TriangleMethodPass.prototype._iUsesSpecular=function(){return Boolean(this._iSpecularMethodVO)},TriangleMethodPass}(materials.TrianglePassBase);materials.TriangleMethodPass=TriangleMethodPass}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var DepthMapPass=away.materials.DepthMapPass,DistanceMapPass=away.materials.DistanceMapPass,DepthMaterialBase=function(_super){function DepthMaterialBase(){_super.call(this),this._pHeight=1,this._pWidth=1,this._pRequiresBlending=!1,this._iBaseScreenPassIndex=2,this._pDepthPass=new DepthMapPass,this._pDistancePass=new DistanceMapPass}return __extends(DepthMaterialBase,_super),DepthMaterialBase.prototype.pAddDepthPasses=function(){this.pAddPass(this._pDepthPass),this.pAddPass(this._pDistancePass)},DepthMaterialBase.prototype.iActivateForDepth=function(stage,camera,distanceBased){"undefined"==typeof distanceBased&&(distanceBased=!1),this._distanceBasedDepthRender=distanceBased,distanceBased?this._pDistancePass.iActivate(this,stage,camera):this._pDepthPass.iActivate(this,stage,camera)},DepthMaterialBase.prototype.iDeactivateForDepth=function(stage){this._distanceBasedDepthRender?this._pDistancePass.iDeactivate(this,stage):this._pDepthPass.iDeactivate(this,stage)},DepthMaterialBase.prototype.iRenderDepth=function(renderable,stage,camera,viewProjection){this._distanceBasedDepthRender?this._pDistancePass.iRender(renderable,stage,camera,viewProjection):this._pDepthPass.iRender(renderable,stage,camera,viewProjection)},DepthMaterialBase}(materials.MaterialBase);materials.DepthMaterialBase=DepthMaterialBase}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var LineBasicMaterial=function(_super){function LineBasicMaterial(thickness){"undefined"==typeof thickness&&(thickness=1.25),_super.call(this),this.bothSides=!0,this.pAddDepthPasses(),this.pAddPass(this._screenPass=new materials.LineBasicPass),this._screenPass.thickness=thickness}return __extends(LineBasicMaterial,_super),LineBasicMaterial}(materials.DepthMaterialBase);materials.LineBasicMaterial=LineBasicMaterial}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var SkyboxMaterial=function(_super){function SkyboxMaterial(cubeMap,smooth,repeat,mipmap){"undefined"==typeof smooth&&(smooth=!0),"undefined"==typeof repeat&&(repeat=!1),"undefined"==typeof mipmap&&(mipmap=!1),_super.call(this),this._cubeMap=cubeMap,this.pAddPass(this._skyboxPass=new materials.SkyboxPass),this._skyboxPass.cubeTexture=this._cubeMap}return __extends(SkyboxMaterial,_super),Object.defineProperty(SkyboxMaterial.prototype,"cubeMap",{get:function(){return this._cubeMap},set:function(value){value&&this._cubeMap&&(value.hasMipmaps!=this._cubeMap.hasMipmaps||value.format!=this._cubeMap.format)&&this.iInvalidatePasses(null),this._cubeMap=value,this._skyboxPass.cubeTexture=this._cubeMap},enumerable:!0,configurable:!0}),SkyboxMaterial}(materials.MaterialBase);materials.SkyboxMaterial=SkyboxMaterial}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLBlendFactor=away.stagegl.ContextGLBlendFactor,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,Texture2DBase=away.textures.Texture2DBase,TriangleBasicMaterial=function(_super){function TriangleBasicMaterial(textureColor,smoothAlpha,repeat,mipmap){"undefined"==typeof textureColor&&(textureColor=null),"undefined"==typeof smoothAlpha&&(smoothAlpha=null),"undefined"==typeof repeat&&(repeat=!1),"undefined"==typeof mipmap&&(mipmap=!1),_super.call(this),this._alphaBlending=!1,this._alpha=1,this._alphaThreshold=0,this._depthCompareMode=ContextGLCompareMode.LESS_EQUAL,this._screenPass=new materials.TriangleBasicPass,textureColor instanceof Texture2DBase?(this.texture=textureColor,this.smooth=null==smoothAlpha?!0:!1,this.repeat=repeat,this.mipmap=mipmap):(this.color=textureColor?Number(textureColor):13421772,this.alpha=null==smoothAlpha?1:Number(smoothAlpha))
}return __extends(TriangleBasicMaterial,_super),Object.defineProperty(TriangleBasicMaterial.prototype,"depthCompareMode",{get:function(){return this._depthCompareMode},set:function(value){this._depthCompareMode!=value&&(this._depthCompareMode=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleBasicMaterial.prototype,"alpha",{get:function(){return this._alpha},set:function(value){value>1?value=1:0>value&&(value=0),this._alpha!=value&&(this._alpha=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleBasicMaterial.prototype,"color",{get:function(){return this._color},set:function(value){this._color!=value&&(this._color=value,this._pUpdateColor())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleBasicMaterial.prototype,"texture",{get:function(){return this._texture},set:function(value){this._texture!=value&&(this._texture=value,value&&(this._pHeight=value.height,this._pWidth=value.width),this._pUpdateTexture())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleBasicMaterial.prototype,"alphaBlending",{get:function(){return this._alphaBlending},set:function(value){this._alphaBlending!=value&&(this._alphaBlending=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),TriangleBasicMaterial.prototype.iActivateForDepth=function(stage,camera,distanceBased){"undefined"==typeof distanceBased&&(distanceBased=!1),distanceBased?this._pDistancePass.alphaMask=this._texture:this._pDepthPass.alphaMask=this._texture,_super.prototype.iActivateForDepth.call(this,stage,camera,distanceBased)},TriangleBasicMaterial.prototype.iUpdateMaterial=function(){var passesInvalid;this._pScreenPassesInvalid&&(this.pUpdateScreenPasses(),passesInvalid=!0),(passesInvalid||this.isAnyScreenPassInvalid())&&(this.pClearPasses(),this.pAddDepthPasses(),this.pAddChildPassesFor(this._screenPass),this.addScreenPass(this._screenPass))},TriangleBasicMaterial.prototype.addScreenPass=function(pass){pass&&(this.pAddPass(pass),pass._iPassesDirty=!1)},TriangleBasicMaterial.prototype.isAnyScreenPassInvalid=function(){return this._screenPass._iPassesDirty?!0:!1},TriangleBasicMaterial.prototype.iActivatePass=function(index,stage,camera){0==index&&stage.context.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO),_super.prototype.iActivatePass.call(this,index,stage,camera)},TriangleBasicMaterial.prototype.iDeactivate=function(stage){_super.prototype.iDeactivate.call(this,stage),stage.context.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO)},TriangleBasicMaterial.prototype.pUpdateScreenPasses=function(){this.initPasses(),this.setBlendAndCompareModes(),this._pScreenPassesInvalid=!1},TriangleBasicMaterial.prototype._pUpdateColor=function(){this._screenPass.diffuseColor=this._color},TriangleBasicMaterial.prototype._pUpdateTexture=function(){this._screenPass.texture=this._texture,this._pDistancePass.alphaMask=this._texture,this._pDepthPass.alphaMask=this._texture},TriangleBasicMaterial.prototype.initPasses=function(){},TriangleBasicMaterial.prototype.setBlendAndCompareModes=function(){this._pRequiresBlending=this._pBlendMode!=away.base.BlendMode.NORMAL||this._alphaBlending||this._alpha<1,this._screenPass.depthCompareMode=this._depthCompareMode,this._screenPass.preserveAlpha=this._pRequiresBlending,this._screenPass.setBlendMode(this._pBlendMode==away.base.BlendMode.NORMAL&&this._pRequiresBlending?away.base.BlendMode.LAYER:this._pBlendMode),this._screenPass.forceSeparateMVP=!1},TriangleBasicMaterial}(materials.DepthMaterialBase);materials.TriangleBasicMaterial=TriangleBasicMaterial}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var TriangleMaterialMode=function(){function TriangleMaterialMode(){}return TriangleMaterialMode.SINGLE_PASS="singlePass",TriangleMaterialMode.MULTI_PASS="multiPass",TriangleMaterialMode}();materials.TriangleMaterialMode=TriangleMaterialMode}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ColorTransform=away.geom.ColorTransform,ContextGLBlendFactor=away.stagegl.ContextGLBlendFactor,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,Texture2DBase=away.textures.Texture2DBase,TriangleMethodMaterial=function(_super){function TriangleMethodMaterial(textureColor,smoothAlpha,repeat,mipmap){"undefined"==typeof textureColor&&(textureColor=null),"undefined"==typeof smoothAlpha&&(smoothAlpha=null),"undefined"==typeof repeat&&(repeat=!1),"undefined"==typeof mipmap&&(mipmap=!1),_super.call(this),this._alphaBlending=!1,this._alpha=1,this._ambientMethod=new materials.AmbientBasicMethod,this._diffuseMethod=new materials.DiffuseBasicMethod,this._normalMethod=new materials.NormalBasicMethod,this._specularMethod=new materials.SpecularBasicMethod,this._depthCompareMode=ContextGLCompareMode.LESS_EQUAL,this._materialMode=materials.TriangleMaterialMode.SINGLE_PASS,textureColor instanceof Texture2DBase?(this.texture=textureColor,this.smooth=null==smoothAlpha?!0:!1,this.repeat=repeat,this.mipmap=mipmap):(this.color=null==textureColor?16777215:Number(textureColor),this.alpha=null==smoothAlpha?1:Number(smoothAlpha))}return __extends(TriangleMethodMaterial,_super),Object.defineProperty(TriangleMethodMaterial.prototype,"materialMode",{get:function(){return this._materialMode},set:function(value){this._materialMode!=value&&(this._materialMode=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"depthCompareMode",{get:function(){return this._depthCompareMode},set:function(value){this._depthCompareMode!=value&&(this._depthCompareMode=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"alpha",{get:function(){return this._alpha},set:function(value){value>1?value=1:0>value&&(value=0),this._alpha!=value&&(this._alpha=value,null==this._colorTransform&&(this._colorTransform=new ColorTransform),this._colorTransform.alphaMultiplier=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"colorTransform",{get:function(){return this._screenPass.colorTransform},set:function(value){this._screenPass.colorTransform=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"color",{get:function(){return this._ambientMethod.color},set:function(value){this._ambientMethod.color=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"texture",{get:function(){return this._ambientMethod.texture},set:function(value){this._ambientMethod.texture=value,this._pDistancePass.alphaMask=value,this._pDepthPass.alphaMask=value,value&&(this._pHeight=value.height,this._pWidth=value.width)},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"diffuseTexture",{get:function(){return this._diffuseMethod.texture},set:function(value){this._diffuseMethod.texture=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"ambientMethod",{get:function(){return this._ambientMethod},set:function(value){this._ambientMethod!=value&&(value&&this._ambientMethod&&value.copyFrom(this._ambientMethod),this._ambientMethod=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"shadowMethod",{get:function(){return this._shadowMethod},set:function(value){this._shadowMethod!=value&&(value&&this._shadowMethod&&value.copyFrom(this._shadowMethod),this._shadowMethod=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"diffuseMethod",{get:function(){return this._diffuseMethod},set:function(value){this._diffuseMethod!=value&&(value&&this._diffuseMethod&&value.copyFrom(this._diffuseMethod),this._diffuseMethod=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"specularMethod",{get:function(){return this._specularMethod},set:function(value){this._specularMethod!=value&&(value&&this._specularMethod&&value.copyFrom(this._specularMethod),this._specularMethod=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"normalMethod",{get:function(){return this._normalMethod},set:function(value){this._normalMethod!=value&&(value&&this._normalMethod&&value.copyFrom(this._normalMethod),this._normalMethod=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),TriangleMethodMaterial.prototype.addEffectMethod=function(method){null==this._screenPass&&(this._screenPass=new materials.TriangleMethodPass),this._screenPass.addEffectMethod(method),this.pInvalidateScreenPasses()},Object.defineProperty(TriangleMethodMaterial.prototype,"numEffectMethods",{get:function(){return this._screenPass?this._screenPass.numEffectMethods:0},enumerable:!0,configurable:!0}),TriangleMethodMaterial.prototype.hasEffectMethod=function(method){return this._screenPass?this._screenPass.hasEffectMethod(method):!1},TriangleMethodMaterial.prototype.getEffectMethodAt=function(index){return null==this._screenPass?null:this._screenPass.getEffectMethodAt(index)},TriangleMethodMaterial.prototype.addEffectMethodAt=function(method,index){null==this._screenPass&&(this._screenPass=new materials.TriangleMethodPass),this._screenPass.addEffectMethodAt(method,index),this.pInvalidateScreenPasses()},TriangleMethodMaterial.prototype.removeEffectMethod=function(method){null!=this._screenPass&&(this._screenPass.removeEffectMethod(method),0==this._screenPass.numEffectMethods&&this.pInvalidateScreenPasses())},Object.defineProperty(TriangleMethodMaterial.prototype,"normalMap",{get:function(){return this._normalMethod.normalMap},set:function(value){this._normalMethod.normalMap=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"specularMap",{get:function(){return this._specularMethod.texture},set:function(value){this._specularMethod.texture=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"gloss",{get:function(){return this._specularMethod.gloss},set:function(value){this._specularMethod.gloss=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"ambient",{get:function(){return this._ambientMethod.ambient},set:function(value){this._ambientMethod.ambient=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"specular",{get:function(){return this._specularMethod.specular},set:function(value){this._specularMethod.specular=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"ambientColor",{get:function(){return this._diffuseMethod.ambientColor},set:function(value){this._diffuseMethod.ambientColor=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"diffuseColor",{get:function(){return this._diffuseMethod.diffuseColor},set:function(value){this._diffuseMethod.diffuseColor=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"specularColor",{get:function(){return this._specularMethod.specularColor},set:function(value){this._specularMethod.specularColor=value},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"alphaBlending",{get:function(){return this._alphaBlending},set:function(value){this._alphaBlending!=value&&(this._alphaBlending=value,this.pInvalidateScreenPasses())},enumerable:!0,configurable:!0}),TriangleMethodMaterial.prototype.iUpdateMaterial=function(){var passesInvalid;if(this._pScreenPassesInvalid&&(this.pUpdateScreenPasses(),passesInvalid=!0),passesInvalid||this.isAnyScreenPassInvalid()){if(this.pClearPasses(),this.pAddDepthPasses(),this._materialMode==materials.TriangleMaterialMode.MULTI_PASS&&(this.pAddChildPassesFor(this._casterLightPass),this._nonCasterLightPasses))for(var i=0;i<this._nonCasterLightPasses.length;++i)this.pAddChildPassesFor(this._nonCasterLightPasses[i]);if(this.pAddChildPassesFor(this._screenPass),this._materialMode==materials.TriangleMaterialMode.MULTI_PASS&&(this.addScreenPass(this._casterLightPass),this._nonCasterLightPasses))for(i=0;i<this._nonCasterLightPasses.length;++i)this.addScreenPass(this._nonCasterLightPasses[i]);this.addScreenPass(this._screenPass)}},TriangleMethodMaterial.prototype.addScreenPass=function(pass){pass&&(this.pAddPass(pass),pass._iPassesDirty=!1)},TriangleMethodMaterial.prototype.isAnyScreenPassInvalid=function(){if(this._casterLightPass&&this._casterLightPass._iPassesDirty||this._screenPass&&this._screenPass._iPassesDirty)return!0;if(this._nonCasterLightPasses)for(var i=0;i<this._nonCasterLightPasses.length;++i)if(this._nonCasterLightPasses[i]._iPassesDirty)return!0;return!1},TriangleMethodMaterial.prototype.iActivatePass=function(index,stage,camera){0==index&&this._materialMode==materials.TriangleMaterialMode.MULTI_PASS&&stage.context.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO),_super.prototype.iActivatePass.call(this,index,stage,camera)},TriangleMethodMaterial.prototype.iDeactivate=function(stage){_super.prototype.iDeactivate.call(this,stage),this._materialMode==materials.TriangleMaterialMode.MULTI_PASS&&stage.context.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO)},TriangleMethodMaterial.prototype.pUpdateScreenPasses=function(){this.initPasses(),this.setBlendAndCompareModes(),this._pScreenPassesInvalid=!1},TriangleMethodMaterial.prototype.initPasses=function(){0==this.numLights||this.numEffectMethods>0||this._materialMode==materials.TriangleMaterialMode.SINGLE_PASS?this.initEffectPass():this._screenPass&&this.removeEffectPass(),this._shadowMethod&&this._materialMode==materials.TriangleMaterialMode.MULTI_PASS?this.initCasterLightPass():this._casterLightPass&&this.removeCasterLightPass(),this.numNonCasters>0&&this._materialMode==materials.TriangleMaterialMode.MULTI_PASS?this.initNonCasterLightPasses():this._nonCasterLightPasses&&this.removeNonCasterLightPasses()},TriangleMethodMaterial.prototype.setBlendAndCompareModes=function(){var forceSeparateMVP=Boolean(this._casterLightPass||this._screenPass);if(this._casterLightPass&&(this._casterLightPass.forceSeparateMVP=forceSeparateMVP,this._casterLightPass.setBlendMode(away.base.BlendMode.NORMAL),this._casterLightPass.depthCompareMode=this._depthCompareMode),this._nonCasterLightPasses){var firstAdditiveIndex=0;this._casterLightPass||(this._nonCasterLightPasses[0].forceSeparateMVP=forceSeparateMVP,this._nonCasterLightPasses[0].setBlendMode(away.base.BlendMode.NORMAL),this._nonCasterLightPasses[0].depthCompareMode=this._depthCompareMode,firstAdditiveIndex=1);for(var i=firstAdditiveIndex;i<this._nonCasterLightPasses.length;++i)this._nonCasterLightPasses[i].forceSeparateMVP=forceSeparateMVP,this._nonCasterLightPasses[i].setBlendMode(away.base.BlendMode.ADD),this._nonCasterLightPasses[i].depthCompareMode=ContextGLCompareMode.LESS_EQUAL}this._casterLightPass||this._nonCasterLightPasses?(this._pRequiresBlending=!1,this._screenPass&&(this._screenPass.passMode=materials.MaterialPassMode.EFFECTS,this._screenPass.depthCompareMode=ContextGLCompareMode.LESS_EQUAL,this._screenPass.setBlendMode(away.base.BlendMode.LAYER),this._screenPass.forceSeparateMVP=forceSeparateMVP)):this._screenPass&&(this._pRequiresBlending=this._pBlendMode!=away.base.BlendMode.NORMAL||this._alphaBlending||this._colorTransform&&this._colorTransform.alphaMultiplier<1,this._screenPass.passMode=materials.MaterialPassMode.SUPER_SHADER,this._screenPass.depthCompareMode=this._depthCompareMode,this._screenPass.preserveAlpha=this._pRequiresBlending,this._screenPass.colorTransform=this._colorTransform,this._screenPass.setBlendMode(this._pBlendMode==away.base.BlendMode.NORMAL&&this._pRequiresBlending?away.base.BlendMode.LAYER:this._pBlendMode),this._screenPass.forceSeparateMVP=!1)},TriangleMethodMaterial.prototype.initCasterLightPass=function(){null==this._casterLightPass&&(this._casterLightPass=new materials.TriangleMethodPass(materials.MaterialPassMode.LIGHTING)),this._casterLightPass.lightPicker=new materials.StaticLightPicker([this._shadowMethod.castingLight]),this._casterLightPass.shadowMethod=this._shadowMethod,this._casterLightPass.diffuseMethod=this._diffuseMethod,this._casterLightPass.ambientMethod=this._ambientMethod,this._casterLightPass.normalMethod=this._normalMethod,this._casterLightPass.specularMethod=this._specularMethod},TriangleMethodMaterial.prototype.removeCasterLightPass=function(){this._casterLightPass.dispose(),this.pRemovePass(this._casterLightPass),this._casterLightPass=null},TriangleMethodMaterial.prototype.initNonCasterLightPasses=function(){this.removeNonCasterLightPasses();var pass,numDirLights=this._pLightPicker.numDirectionalLights,numPointLights=this._pLightPicker.numPointLights,numLightProbes=this._pLightPicker.numLightProbes,dirLightOffset=0,pointLightOffset=0,probeOffset=0;for(this._casterLightPass||(numDirLights+=this._pLightPicker.numCastingDirectionalLights,numPointLights+=this._pLightPicker.numCastingPointLights),this._nonCasterLightPasses=new Array;numDirLights>dirLightOffset||numPointLights>pointLightOffset||numLightProbes>probeOffset;)pass=new materials.TriangleMethodPass(materials.MaterialPassMode.LIGHTING),pass.includeCasters=null==this._shadowMethod,pass.directionalLightsOffset=dirLightOffset,pass.pointLightsOffset=pointLightOffset,pass.lightProbesOffset=probeOffset,pass.lightPicker=this._pLightPicker,pass.diffuseMethod=this._diffuseMethod,pass.ambientMethod=this._ambientMethod,pass.normalMethod=this._normalMethod,pass.specularMethod=this._specularMethod,this._nonCasterLightPasses.push(pass),dirLightOffset+=pass.iNumDirectionalLights,pointLightOffset+=pass.iNumPointLights,probeOffset+=pass.iNumLightProbes},TriangleMethodMaterial.prototype.removeNonCasterLightPasses=function(){if(this._nonCasterLightPasses){for(var i=0;i<this._nonCasterLightPasses.length;++i)this.pRemovePass(this._nonCasterLightPasses[i]);this._nonCasterLightPasses=null}},TriangleMethodMaterial.prototype.removeEffectPass=function(){this._screenPass.ambientMethod!=this._ambientMethod&&this._screenPass.ambientMethod.dispose(),this._screenPass.diffuseMethod!=this._diffuseMethod&&this._screenPass.diffuseMethod.dispose(),this._screenPass.specularMethod!=this._specularMethod&&this._screenPass.specularMethod.dispose(),this._screenPass.normalMethod!=this._normalMethod&&this._screenPass.normalMethod.dispose(),this.pRemovePass(this._screenPass),this._screenPass=null},TriangleMethodMaterial.prototype.initEffectPass=function(){null==this._screenPass&&(this._screenPass=new materials.TriangleMethodPass),this._materialMode==materials.TriangleMaterialMode.SINGLE_PASS?(this._screenPass.ambientMethod=this._ambientMethod,this._screenPass.diffuseMethod=this._diffuseMethod,this._screenPass.specularMethod=this._specularMethod,this._screenPass.normalMethod=this._normalMethod,this._screenPass.shadowMethod=this._shadowMethod):this._materialMode==materials.TriangleMaterialMode.MULTI_PASS&&(0==this.numLights?this._screenPass.ambientMethod=this._ambientMethod:(this._screenPass.ambientMethod=new materials.AmbientBasicMethod,this._screenPass.ambientMethod.color=0,this._screenPass.ambientMethod.alpha=0),this._screenPass.preserveAlpha=!1,this._screenPass.normalMethod=this._normalMethod)},Object.defineProperty(TriangleMethodMaterial.prototype,"numLights",{get:function(){return this._pLightPicker?this._pLightPicker.numLightProbes+this._pLightPicker.numDirectionalLights+this._pLightPicker.numPointLights+this._pLightPicker.numCastingDirectionalLights+this._pLightPicker.numCastingPointLights:0},enumerable:!0,configurable:!0}),Object.defineProperty(TriangleMethodMaterial.prototype,"numNonCasters",{get:function(){return this._pLightPicker?this._pLightPicker.numLightProbes+this._pLightPicker.numDirectionalLights+this._pLightPicker.numPointLights:0},enumerable:!0,configurable:!0}),TriangleMethodMaterial}(materials.DepthMaterialBase);materials.TriangleMethodMaterial=TriangleMethodMaterial}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var DefaultMaterialManager=function(){function DefaultMaterialManager(){}return DefaultMaterialManager.getDefaultMaterial=function(materialOwner){return"undefined"==typeof materialOwner&&(materialOwner=null),null!=materialOwner&&materialOwner.assetType==away.library.AssetType.LINE_SUB_MESH?(DefaultMaterialManager._defaultLineMaterial||DefaultMaterialManager.createDefaultLineMaterial(),DefaultMaterialManager._defaultLineMaterial):(DefaultMaterialManager._defaultTriangleMaterial||DefaultMaterialManager.createDefaultTriangleMaterial(),DefaultMaterialManager._defaultTriangleMaterial)},DefaultMaterialManager.getDefaultTexture=function(materialOwner){return"undefined"==typeof materialOwner&&(materialOwner=null),DefaultMaterialManager._defaultTexture||DefaultMaterialManager.createDefaultTexture(),DefaultMaterialManager._defaultTexture},DefaultMaterialManager.createDefaultTexture=function(){DefaultMaterialManager._defaultBitmapData=DefaultMaterialManager.createCheckeredBitmapData(),DefaultMaterialManager._defaultTexture=new away.textures.BitmapTexture(DefaultMaterialManager._defaultBitmapData,!0),DefaultMaterialManager._defaultTexture.name="defaultTexture"},DefaultMaterialManager.createCheckeredBitmapData=function(){var i,j,b=new away.base.BitmapData(8,8,!1,0);for(i=0;8>i;i++)for(j=0;8>j;j++)1&j^1&i&&b.setPixel(i,j,16777215);return b},DefaultMaterialManager.createDefaultTriangleMaterial=function(){DefaultMaterialManager._defaultTexture||DefaultMaterialManager.createDefaultTexture(),DefaultMaterialManager._defaultTriangleMaterial=new materials.TriangleBasicMaterial(DefaultMaterialManager._defaultTexture),DefaultMaterialManager._defaultTriangleMaterial.mipmap=!1,DefaultMaterialManager._defaultTriangleMaterial.smooth=!1,DefaultMaterialManager._defaultTriangleMaterial.name="defaultTriangleMaterial"},DefaultMaterialManager.createDefaultLineMaterial=function(){DefaultMaterialManager._defaultLineMaterial=new materials.LineBasicMaterial,DefaultMaterialManager._defaultLineMaterial.name="defaultSegmentMaterial"},DefaultMaterialManager}();materials.DefaultMaterialManager=DefaultMaterialManager}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(materials){var ContextGLTextureFormat=away.stagegl.ContextGLTextureFormat,ShaderCompilerHelper=function(){function ShaderCompilerHelper(){}return ShaderCompilerHelper.getTex2DSampleCode=function(targetReg,sharedReg,inputReg,texture,smooth,repeat,mipmaps,uvReg,forceWrap){"undefined"==typeof uvReg&&(uvReg=null),"undefined"==typeof forceWrap&&(forceWrap=null);var wrap=forceWrap||(repeat?"wrap":"clamp"),format=ShaderCompilerHelper.getFormatStringForTexture(texture),enableMipMaps=mipmaps&&texture.hasMipmaps,filter=smooth?enableMipMaps?"linear,miplinear":"linear":enableMipMaps?"nearest,mipnearest":"nearest";return null==uvReg&&(uvReg=sharedReg.uvVarying),"tex "+targetReg+", "+uvReg+", "+inputReg+" <2d,"+filter+","+format+wrap+">\n"},ShaderCompilerHelper.getTexCubeSampleCode=function(targetReg,inputReg,texture,smooth,mipmaps,uvReg){var filter,format=ShaderCompilerHelper.getFormatStringForTexture(texture),enableMipMaps=mipmaps&&texture.hasMipmaps,filter=smooth?enableMipMaps?"linear,miplinear":"linear":enableMipMaps?"nearest,mipnearest":"nearest";return"tex "+targetReg+", "+uvReg+", "+inputReg+" <cube,"+format+filter+">\n"},ShaderCompilerHelper.getFormatStringForTexture=function(texture){switch(texture.format){case ContextGLTextureFormat.COMPRESSED:return"dxt1,";case ContextGLTextureFormat.COMPRESSED_ALPHA:return"dxt5,";default:return""}},ShaderCompilerHelper}();materials.ShaderCompilerHelper=ShaderCompilerHelper}(away.materials||(away.materials={}));away.materials}(away||(away={}));var away;!function(away){!function(render){var RendererEvent=away.events.RendererEvent,StageEvent=away.events.StageEvent,Matrix3D=away.geom.Matrix3D,Point=away.geom.Point,Rectangle=away.geom.Rectangle,DefaultMaterialManager=away.materials.DefaultMaterialManager,BillboardRenderable=away.pool.BillboardRenderable,LineSubMeshRenderable=away.pool.LineSubMeshRenderable,RenderablePool=away.pool.RenderablePool,TriangleSubMeshRenderable=away.pool.TriangleSubMeshRenderable,RenderableMergeSort=away.sort.RenderableMergeSort,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,EntityCollector=away.traverse.EntityCollector,RendererBase=function(_super){function RendererBase(){var _this=this;_super.call(this),this._viewPort=new Rectangle,this._pBackBufferInvalid=!0,this._pDepthTextureInvalid=!0,this._depthPrepass=!1,this._backgroundR=0,this._backgroundG=0,this._backgroundB=0,this._backgroundAlpha=1,this._shareContext=!1,this.textureRatioX=1,this.textureRatioY=1,this._pRttViewProjectionMatrix=new Matrix3D,this._localPos=new Point,this._globalPos=new Point,this._pScissorRect=new Rectangle,this._pNumTriangles=0,this._onViewportUpdatedDelegate=function(event){return _this.onViewportUpdated(event)},this._billboardRenderablePool=RenderablePool.getPool(BillboardRenderable),this._triangleSubMeshRenderablePool=RenderablePool.getPool(TriangleSubMeshRenderable),this._lineSubMeshRenderablePool=RenderablePool.getPool(LineSubMeshRenderable),this._onContextUpdateDelegate=function(event){return _this.onContextUpdate(event)},this.renderableSorter=new RenderableMergeSort}return __extends(RendererBase,_super),Object.defineProperty(RendererBase.prototype,"numTriangles",{get:function(){return this._pNumTriangles},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"scissorRect",{get:function(){return this._pScissorRect},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"x",{get:function(){return this._localPos.x},set:function(value){this.x!=value&&(this._globalPos.x=this._localPos.x=value,this.updateGlobalPos())},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"y",{get:function(){return this._localPos.y},set:function(value){this.y!=value&&(this._globalPos.y=this._localPos.y=value,this.updateGlobalPos())},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"width",{get:function(){return this._width},set:function(value){this._width!=value&&(this._width=value,this._pScissorRect.width=value,this._pRttBufferManager&&(this._pRttBufferManager.viewWidth=value),this._pBackBufferInvalid=!0,this._pDepthTextureInvalid=!0,this.notifyScissorUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"height",{get:function(){return this._height},set:function(value){this._height!=value&&(this._height=value,this._pScissorRect.height=value,this._pRttBufferManager&&(this._pRttBufferManager.viewHeight=value),this._pBackBufferInvalid=!0,this._pDepthTextureInvalid=!0,this.notifyScissorUpdate())},enumerable:!0,configurable:!0}),RendererBase.prototype._iCreateEntityCollector=function(){return new EntityCollector},Object.defineProperty(RendererBase.prototype,"_iBackgroundR",{get:function(){return this._backgroundR},set:function(value){this._backgroundR!=value&&(this._backgroundR=value,this._pBackBufferInvalid=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"_iBackgroundG",{get:function(){return this._backgroundG},set:function(value){this._backgroundG!=value&&(this._backgroundG=value,this._pBackBufferInvalid=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"_iBackgroundB",{get:function(){return this._backgroundB},set:function(value){this._backgroundB!=value&&(this._backgroundB=value,this._pBackBufferInvalid=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(RendererBase.prototype,"stage",{get:function(){return this._pStage},set:function(value){value!=this._pStage&&this.iSetStage(value)},enumerable:!0,configurable:!0}),RendererBase.prototype.iSetStage=function(value){this._pStage&&(this._pStage.removeEventListener(StageEvent.CONTEXT_CREATED,this._onContextUpdateDelegate),this._pStage.removeEventListener(StageEvent.CONTEXT_RECREATED,this._onContextUpdateDelegate),this._pStage.removeEventListener(StageEvent.VIEWPORT_UPDATED,this._onViewportUpdatedDelegate)),value?(this._pStage=value,this._pStage.addEventListener(StageEvent.CONTEXT_CREATED,this._onContextUpdateDelegate),this._pStage.addEventListener(StageEvent.CONTEXT_RECREATED,this._onContextUpdateDelegate),this._pStage.addEventListener(StageEvent.VIEWPORT_UPDATED,this._onViewportUpdatedDelegate),this._pStage.context&&(this._pContext=this._pStage.context)):(this._pStage=null,this._pContext=null),this._pBackBufferInvalid=!0,this.updateGlobalPos()},Object.defineProperty(RendererBase.prototype,"shareContext",{get:function(){return this._shareContext},set:function(value){this._shareContext!=value&&(this._shareContext=value,this.updateGlobalPos())},enumerable:!0,configurable:!0}),RendererBase.prototype.dispose=function(){this._pRttBufferManager&&this._pRttBufferManager.dispose(),this._pRttBufferManager=null,this._pStage.removeEventListener(StageEvent.CONTEXT_CREATED,this._onContextUpdateDelegate),this._pStage.removeEventListener(StageEvent.CONTEXT_RECREATED,this._onContextUpdateDelegate),this._pStage.removeEventListener(StageEvent.VIEWPORT_UPDATED,this._onViewportUpdatedDelegate),this._pStage=null},RendererBase.prototype.render=function(){this._viewportDirty=!1,this._scissorDirty=!1},RendererBase.prototype._iRender=function(entityCollector,target,scissorRect,surfaceSelector){if("undefined"==typeof target&&(target=null),"undefined"==typeof scissorRect&&(scissorRect=null),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),this._pStage&&this._pContext){this._pRttViewProjectionMatrix.copyFrom(entityCollector.camera.viewProjection),this._pRttViewProjectionMatrix.appendScale(this.textureRatioX,this.textureRatioY,1),this.pExecuteRender(entityCollector,target,scissorRect,surfaceSelector);for(var i=0;8>i;++i)this._pContext.setVertexBufferAt(i,null),this._pContext.setTextureAt(i,null)}},RendererBase.prototype._iRenderCascades=function(){},RendererBase.prototype.pCollectRenderables=function(entityCollector){this._pBlendedRenderableHead=null,this._pOpaqueRenderableHead=null,this._pNumTriangles=0;var item=entityCollector.entityHead;for(this._pCamera=entityCollector.camera,this._iEntryPoint=this._pCamera.scenePosition,this._pCameraForward=this._pCamera.transform.forwardVector;item;)item.entity._iCollectRenderables(this),item=item.next;this._pOpaqueRenderableHead=this.renderableSorter.sortOpaqueRenderables(this._pOpaqueRenderableHead),this._pBlendedRenderableHead=this.renderableSorter.sortBlendedRenderables(this._pBlendedRenderableHead)},RendererBase.prototype.pExecuteRender=function(entityCollector,target,scissorRect,surfaceSelector){"undefined"==typeof target&&(target=null),"undefined"==typeof scissorRect&&(scissorRect=null),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),this._pContext.setRenderTarget(target,!0,surfaceSelector),!target&&this._shareContext||this._depthPrepass||this._pContext.clear(this._backgroundR,this._backgroundG,this._backgroundB,this._backgroundAlpha,1,0),this._pContext.setDepthTest(!1,ContextGLCompareMode.ALWAYS),this._pStage.scissorRect=scissorRect,this.pDraw(entityCollector,target),this._shareContext||this._snapshotRequired&&this._snapshotBitmapData&&(this._pContext.drawToBitmapData(this._snapshotBitmapData),this._snapshotRequired=!1),this._pStage.scissorRect=null},RendererBase.prototype.queueSnapshot=function(bmd){this._snapshotRequired=!0,this._snapshotBitmapData=bmd
},RendererBase.prototype.pDraw=function(){throw new away.errors.AbstractMethodError},RendererBase.prototype.onContextUpdate=function(){this._pContext=this._pStage.context},Object.defineProperty(RendererBase.prototype,"_iBackgroundAlpha",{get:function(){return this._backgroundAlpha},set:function(value){this._backgroundAlpha!=value&&(this._backgroundAlpha=value,this._pBackBufferInvalid=!0)},enumerable:!0,configurable:!0}),RendererBase.prototype.notifyScissorUpdate=function(){this._scissorDirty||(this._scissorDirty=!0,this._scissorUpdated||(this._scissorUpdated=new RendererEvent(RendererEvent.SCISSOR_UPDATED)),this.dispatchEvent(this._scissorUpdated))},RendererBase.prototype.notifyViewportUpdate=function(){this._viewportDirty||(this._viewportDirty=!0,this._viewPortUpdated||(this._viewPortUpdated=new RendererEvent(RendererEvent.VIEWPORT_UPDATED)),this.dispatchEvent(this._viewPortUpdated))},RendererBase.prototype.onViewportUpdated=function(){this._viewPort=this._pStage.viewPort,this._shareContext&&(this._pScissorRect.x=this._globalPos.x-this._pStage.x,this._pScissorRect.y=this._globalPos.y-this._pStage.y,this.notifyScissorUpdate()),this.notifyViewportUpdate()},RendererBase.prototype.updateGlobalPos=function(){this._shareContext?(this._pScissorRect.x=this._globalPos.x-this._viewPort.x,this._pScissorRect.y=this._globalPos.y-this._viewPort.y):(this._pScissorRect.x=0,this._pScissorRect.y=0,this._viewPort.x=this._globalPos.x,this._viewPort.y=this._globalPos.y),this.notifyScissorUpdate()},RendererBase.prototype.applyBillboard=function(billboard){this._applyRenderable(this._billboardRenderablePool.getItem(billboard))},RendererBase.prototype.applyTriangleSubMesh=function(triangleSubMesh){this._applyRenderable(this._triangleSubMeshRenderablePool.getItem(triangleSubMesh))},RendererBase.prototype.applyLineSubMesh=function(lineSubMesh){this._applyRenderable(this._lineSubMeshRenderablePool.getItem(lineSubMesh))},RendererBase.prototype._applyRenderable=function(renderable){var material=renderable.materialOwner.material,entity=renderable.sourceEntity,position=entity.scenePosition;material||(material=DefaultMaterialManager.getDefaultMaterial(renderable.materialOwner)),material.iUpdateMaterial(),renderable.material=material,renderable.materialId=material._iMaterialId,renderable.renderOrderId=this._pContext.getRenderOrderId(material,this._pStage.profile),renderable.cascaded=!1,position=this._iEntryPoint.subtract(position),renderable.zIndex=entity.zOffset+position.dotProduct(this._pCameraForward),renderable.renderSceneTransform=renderable.sourceEntity.getRenderSceneTransform(this._pCamera),material.requiresBlending?(renderable.next=this._pBlendedRenderableHead,this._pBlendedRenderableHead=renderable):(renderable.next=this._pOpaqueRenderableHead,this._pOpaqueRenderableHead=renderable),this._pNumTriangles+=renderable.numTriangles,renderable.overflow&&this._applyRenderable(renderable.overflow)},RendererBase}(away.events.EventDispatcher);render.RendererBase=RendererBase}(away.render||(away.render={}));away.render}(away||(away={}));var away;!function(away){!function(render){var Matrix3D=away.geom.Matrix3D,Vector3D=away.geom.Vector3D,RTTBufferManager=away.managers.RTTBufferManager,StageManager=away.managers.StageManager,RenderablePool=away.pool.RenderablePool,SkyboxRenderable=away.pool.SkyboxRenderable,ContextGLBlendFactor=away.stagegl.ContextGLBlendFactor,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,ContextGLClearMask=away.stagegl.ContextGLClearMask,RenderTexture=away.textures.RenderTexture,DefaultRenderer=function(_super){function DefaultRenderer(forceSoftware,profile,mode){"undefined"==typeof forceSoftware&&(forceSoftware=!1),"undefined"==typeof profile&&(profile="baseline"),"undefined"==typeof mode&&(mode="auto"),_super.call(this),this._skyboxProjection=new Matrix3D,this._skyboxRenderablePool=RenderablePool.getPool(SkyboxRenderable),this._pDepthRenderer=new render.DepthRenderer,this._pDistanceRenderer=new render.DepthRenderer(!1,!0),null==this._pStage&&(this.stage=StageManager.getInstance().getFreeStage(forceSoftware,profile,mode)),this._pRttBufferManager=RTTBufferManager.getInstance(this._pStage),0==this._width?this.width=window.innerWidth:this._pRttBufferManager.viewWidth=this._width,0==this._height?this.height=window.innerHeight:this._pRttBufferManager.viewHeight=this._height}return __extends(DefaultRenderer,_super),Object.defineProperty(DefaultRenderer.prototype,"antiAlias",{get:function(){return this._antiAlias},set:function(value){this._antiAlias!=value&&(this._antiAlias=value,this._pBackBufferInvalid=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(DefaultRenderer.prototype,"depthPrepass",{get:function(){return this._depthPrepass},set:function(value){this._depthPrepass=value},enumerable:!0,configurable:!0}),Object.defineProperty(DefaultRenderer.prototype,"filters3d",{get:function(){return this._pFilter3DRenderer?this._pFilter3DRenderer.filters:null},set:function(value){value&&0==value.length&&(value=null),this._pFilter3DRenderer&&!value?(this._pFilter3DRenderer.dispose(),this._pFilter3DRenderer=null):!this._pFilter3DRenderer&&value&&(this._pFilter3DRenderer=new render.Filter3DRenderer(this._pStage),this._pFilter3DRenderer.filters=value),this._pFilter3DRenderer?(this._pFilter3DRenderer.filters=value,this._pRequireDepthRender=this._pFilter3DRenderer.requireDepthRender):(this._pRequireDepthRender=!1,this._pDepthRender&&(this._pDepthRender.dispose(),this._pDepthRender=null))},enumerable:!0,configurable:!0}),DefaultRenderer.prototype.render=function(entityCollector){return _super.prototype.render.call(this,entityCollector),this._pStage.recoverFromDisposal()?(this._pBackBufferInvalid&&this.pUpdateBackBuffer(),this._shareContext&&this._pContext&&this._pContext.clear(0,0,0,1,1,0,ContextGLClearMask.DEPTH),this._pFilter3DRenderer?(this.textureRatioX=this._pRttBufferManager.textureRatioX,this.textureRatioY=this._pRttBufferManager.textureRatioY):(this.textureRatioX=1,this.textureRatioY=1),this._pRequireDepthRender&&this.pRenderSceneDepthToTexture(entityCollector),this._depthPrepass&&this.pRenderDepthPrepass(entityCollector),this._pFilter3DRenderer&&this._pContext||(this._shareContext?this._iRender(entityCollector,null,this._pScissorRect):this._iRender(entityCollector)),_super.prototype.render.call(this,entityCollector),!this._shareContext&&this._pContext&&this._pContext.present(),this._pStage.bufferClear=!1,void 0):(this._pBackBufferInvalid=!0,void 0)},DefaultRenderer.prototype.pExecuteRender=function(entityCollector,target,scissorRect,surfaceSelector){"undefined"==typeof target&&(target=null),"undefined"==typeof scissorRect&&(scissorRect=null),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),this.updateLights(entityCollector),target&&(this.pCollectRenderables(entityCollector),this.drawRenderables(this._pOpaqueRenderableHead,entityCollector,DefaultRenderer.RTT_PASSES),this.drawRenderables(this._pBlendedRenderableHead,entityCollector,DefaultRenderer.RTT_PASSES)),_super.prototype.pExecuteRender.call(this,entityCollector,target,scissorRect,surfaceSelector)},DefaultRenderer.prototype.updateLights=function(entityCollector){var len,i,light,shadowMapper,dirLights=entityCollector.directionalLights,pointLights=entityCollector.pointLights;for(len=dirLights.length,i=0;len>i;++i)light=dirLights[i],shadowMapper=light.shadowMapper,light.castsShadows&&(shadowMapper.autoUpdateShadows||shadowMapper._iShadowsInvalid)&&shadowMapper.iRenderDepthMap(this._pStage,entityCollector,this._pDepthRenderer);for(len=pointLights.length,i=0;len>i;++i)light=pointLights[i],shadowMapper=light.shadowMapper,light.castsShadows&&(shadowMapper.autoUpdateShadows||shadowMapper._iShadowsInvalid)&&shadowMapper.iRenderDepthMap(this._pStage,entityCollector,this._pDistanceRenderer)},DefaultRenderer.prototype.pDraw=function(entityCollector,target){target||this.pCollectRenderables(entityCollector),this._pContext.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO),entityCollector.skyBox&&(this._activeMaterial&&this._activeMaterial.iDeactivate(this._pStage),this._activeMaterial=null,this._pContext.setDepthTest(!1,ContextGLCompareMode.ALWAYS),this.drawSkybox(entityCollector)),this._pContext.setDepthTest(!0,ContextGLCompareMode.LESS_EQUAL);var which=target?DefaultRenderer.SCREEN_PASSES:DefaultRenderer.ALL_PASSES;this.drawRenderables(this._pOpaqueRenderableHead,entityCollector,which),this.drawRenderables(this._pBlendedRenderableHead,entityCollector,which),this._pContext.setDepthTest(!1,ContextGLCompareMode.LESS_EQUAL),this._activeMaterial&&this._activeMaterial.iDeactivate(this._pStage),this._activeMaterial=null},DefaultRenderer.prototype.drawSkybox=function(entityCollector){var skyBox=this._skyboxRenderablePool.getItem(entityCollector.skyBox),material=entityCollector.skyBox.material,camera=entityCollector.camera;this.updateSkyboxProjection(camera),material.iActivatePass(0,this._pStage,camera),material.iRenderPass(0,skyBox,this._pStage,entityCollector,this._skyboxProjection),material.iDeactivatePass(0,this._pStage)},DefaultRenderer.prototype.updateSkyboxProjection=function(camera){var near=new Vector3D;this._skyboxProjection.copyFrom(this._pRttViewProjectionMatrix),this._skyboxProjection.copyRowTo(2,near);var camPos=camera.scenePosition,cx=near.x,cy=near.y,cz=near.z,cw=-(near.x*camPos.x+near.y*camPos.y+near.z*camPos.z+Math.sqrt(cx*cx+cy*cy+cz*cz)),signX=cx>=0?1:-1,signY=cy>=0?1:-1,p=new Vector3D(signX,signY,1,1),inverse=this._skyboxProjection.clone();inverse.invert();var q=inverse.transformVector(p);this._skyboxProjection.copyRowTo(3,p);var a=(q.x*p.x+q.y*p.y+q.z*p.z+q.w*p.w)/(cx*q.x+cy*q.y+cz*q.z+cw*q.w);this._skyboxProjection.copyRowFrom(2,new Vector3D(cx*a,cy*a,cz*a,cw*a))},DefaultRenderer.prototype.drawRenderables=function(renderable,entityCollector,which){for(var numPasses,j,renderable2,camera=entityCollector.camera;renderable;){this._activeMaterial=renderable.material,numPasses=this._activeMaterial.getNumPasses(),j=this._activeMaterial._iBaseScreenPassIndex;do{renderable2=renderable;var rttMask=this._activeMaterial.iPassRendersToTexture(j)?1:2;if(0!=(rttMask&which)){this._activeMaterial.iActivatePass(j,this._pStage,camera);do this._activeMaterial.iRenderPass(j,renderable2,this._pStage,entityCollector,this._pRttViewProjectionMatrix),renderable2=renderable2.next;while(renderable2&&renderable2.material==this._activeMaterial);this._activeMaterial.iDeactivatePass(j,this._pStage)}else do renderable2=renderable2.next;while(renderable2&&renderable2.material==this._activeMaterial)}while(++j<numPasses);renderable=renderable2}},DefaultRenderer.prototype.dispose=function(){this._shareContext||this._pStage.dispose(),this._pDepthRenderer.dispose(),this._pDistanceRenderer.dispose(),this._pDepthRenderer=null,this._pDistanceRenderer=null,this._pDepthRender=null,_super.prototype.dispose.call(this)},DefaultRenderer.prototype.pRenderDepthPrepass=function(entityCollector){this._pDepthRenderer.disableColor=!0,this._pFilter3DRenderer||(this._pDepthRenderer.textureRatioX=1,this._pDepthRenderer.textureRatioY=1,this._pDepthRenderer._iRender(entityCollector)),this._pDepthRenderer.disableColor=!1},DefaultRenderer.prototype.pRenderSceneDepthToTexture=function(entityCollector){(this._pDepthTextureInvalid||!this._pDepthRender)&&this.initDepthTexture(this._pStage.context),this._pDepthRenderer.textureRatioX=this._pRttBufferManager.textureRatioX,this._pDepthRenderer.textureRatioY=this._pRttBufferManager.textureRatioY,this._pDepthRenderer._iRender(entityCollector,this._pDepthRender)},DefaultRenderer.prototype.pUpdateBackBuffer=function(){this._pStage.context&&!this._shareContext&&this._width&&this._height&&(this._pStage.configureBackBuffer(this._width,this._height,this._antiAlias,!0),this._pBackBufferInvalid=!1)},DefaultRenderer.prototype.iSetStage=function(value){_super.prototype.iSetStage.call(this,value),this._pDistanceRenderer.iSetStage(value),this._pDepthRenderer.iSetStage(value)},DefaultRenderer.prototype.initDepthTexture=function(){this._pDepthTextureInvalid=!1,this._pDepthRender&&this._pDepthRender.dispose(),this._pDepthRender=new RenderTexture(this._pRttBufferManager.textureWidth,this._pRttBufferManager.textureHeight)},DefaultRenderer.RTT_PASSES=1,DefaultRenderer.SCREEN_PASSES=2,DefaultRenderer.ALL_PASSES=3,DefaultRenderer}(render.RendererBase);render.DefaultRenderer=DefaultRenderer}(away.render||(away.render={}));away.render}(away||(away={}));var away;!function(away){!function(render){var ContextGLBlendFactor=away.stagegl.ContextGLBlendFactor,ContextGLCompareMode=away.stagegl.ContextGLCompareMode,DepthRenderer=function(_super){function DepthRenderer(renderBlended,distanceBased){"undefined"==typeof renderBlended&&(renderBlended=!1),"undefined"==typeof distanceBased&&(distanceBased=!1),_super.call(this),this._renderBlended=renderBlended,this._distanceBased=distanceBased,this._iBackgroundR=1,this._iBackgroundG=1,this._iBackgroundB=1}return __extends(DepthRenderer,_super),Object.defineProperty(DepthRenderer.prototype,"disableColor",{get:function(){return this._disableColor},set:function(value){this._disableColor=value},enumerable:!0,configurable:!0}),DepthRenderer.prototype._iRenderCascades=function(entityCollector,target,numCascades,scissorRects,cameras){this.pCollectRenderables(entityCollector),this._pContext.setRenderTarget(target,!0,0),this._pContext.clear(1,1,1,1,1,0),this._pContext.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO),this._pContext.setDepthTest(!0,ContextGLCompareMode.LESS);for(var head=this._pOpaqueRenderableHead,first=!0,i=numCascades-1;i>=0;--i)this._pStage.scissorRect=scissorRects[i],this.drawCascadeRenderables(head,cameras[i],first?null:cameras[i].frustumPlanes),first=!1;this._activeMaterial&&this._activeMaterial.iDeactivateForDepth(this._pStage),this._activeMaterial=null,this._pContext.setDepthTest(!1,ContextGLCompareMode.LESS_EQUAL),this._pStage.scissorRect=null},DepthRenderer.prototype.drawCascadeRenderables=function(renderable,camera,cullPlanes){for(var material;renderable;)if(renderable.cascaded)renderable=renderable.next;else{var entity=renderable.sourceEntity;!cullPlanes||entity.worldBounds.isInFrustum(cullPlanes,4)?(material=renderable.materialOwner.material,this._activeMaterial!=material&&(this._activeMaterial&&this._activeMaterial.iDeactivateForDepth(this._pStage),this._activeMaterial=material,this._activeMaterial.iActivateForDepth(this._pStage,camera,!1)),this._activeMaterial.iRenderDepth(renderable,this._pStage,camera,camera.viewProjection)):renderable.cascaded=!0,renderable=renderable.next}},DepthRenderer.prototype.pDraw=function(entityCollector){this.pCollectRenderables(entityCollector),this._pContext.setBlendFactors(ContextGLBlendFactor.ONE,ContextGLBlendFactor.ZERO),this._pContext.setDepthTest(!0,ContextGLCompareMode.LESS),this.drawRenderables(this._pOpaqueRenderableHead,entityCollector),this._disableColor&&this._pContext.setColorMask(!1,!1,!1,!1),this._renderBlended&&this.drawRenderables(this._pBlendedRenderableHead,entityCollector),this._activeMaterial&&this._activeMaterial.iDeactivateForDepth(this._pStage),this._disableColor&&this._pContext.setColorMask(!0,!0,!0,!0),this._activeMaterial=null},DepthRenderer.prototype.drawRenderables=function(renderable,entityCollector){for(var renderable2,camera=entityCollector.camera;renderable;){if(this._activeMaterial=renderable.materialOwner.material,this._disableColor&&0!=this._activeMaterial.alphaThreshold){renderable2=renderable;do renderable2=renderable2.next;while(renderable2&&renderable2.materialOwner.material==this._activeMaterial)}else{this._activeMaterial.iActivateForDepth(this._pStage,camera,this._distanceBased),renderable2=renderable;do this._activeMaterial.iRenderDepth(renderable2,this._pStage,camera,this._pRttViewProjectionMatrix),renderable2=renderable2.next;while(renderable2&&renderable2.materialOwner.material==this._activeMaterial);this._activeMaterial.iDeactivateForDepth(this._pStage)}renderable=renderable2}},DepthRenderer}(render.RendererBase);render.DepthRenderer=DepthRenderer}(away.render||(away.render={}));away.render}(away||(away={}));var away;!function(away){!function(render){var Filter3DRenderer=function(){function Filter3DRenderer(stage){this._filterSizesInvalid=!0,this._onRTTResizeDelegate=away.utils.Delegate.create(this,this.onRTTResize),this._stage=stage,this._rttManager=away.managers.RTTBufferManager.getInstance(stage),this._rttManager.addEventListener(away.events.Event.RESIZE,this._onRTTResizeDelegate)}return Filter3DRenderer.prototype.onRTTResize=function(){this._filterSizesInvalid=!0},Object.defineProperty(Filter3DRenderer.prototype,"requireDepthRender",{get:function(){return this._requireDepthRender},enumerable:!0,configurable:!0}),Filter3DRenderer.prototype.getMainInputTexture=function(stage){return this._filterTasksInvalid&&this.updateFilterTasks(stage),this._mainInputTexture},Object.defineProperty(Filter3DRenderer.prototype,"filters",{get:function(){return this._filters},set:function(value){if(this._filters=value,this._filterTasksInvalid=!0,this._requireDepthRender=!1,this._filters){for(var i=0;i<this._filters.length;++i){var s=this._filters[i],b=null==s.requireDepthRender?!1:s.requireDepthRender;this._requireDepthRender=this._requireDepthRender||b}this._filterSizesInvalid=!0}},enumerable:!0,configurable:!0}),Filter3DRenderer.prototype.updateFilterTasks=function(stage){var len;if(this._filterSizesInvalid&&this.updateFilterSizes(),!this._filters)return this._tasks=null,void 0;this._tasks=new Array,len=this._filters.length-1;for(var filter,i=0;len>=i;++i)filter=this._filters[i],filter.setRenderTargets(i==len?null:this._filters[i+1].getMainInputTexture(stage),stage),this._tasks=this._tasks.concat(filter.tasks);this._mainInputTexture=this._filters[0].getMainInputTexture(stage)},Filter3DRenderer.prototype.render=function(stage,camera,depthTexture){var len,i,task,context=stage.context,indexBuffer=this._rttManager.indexBuffer,vertexBuffer=this._rttManager.renderToTextureVertexBuffer;if(this._filters){for(this._filterSizesInvalid&&this.updateFilterSizes(),this._filterTasksInvalid&&this.updateFilterTasks(stage),len=this._filters.length,i=0;len>i;++i)this._filters[i].update(stage,camera);for(len=this._tasks.length,len>1&&(context.setVertexBufferAt(0,vertexBuffer,0,away.stagegl.ContextGLVertexBufferFormat.FLOAT_2),context.setVertexBufferAt(1,vertexBuffer,2,away.stagegl.ContextGLVertexBufferFormat.FLOAT_2)),i=0;len>i;++i)task=this._tasks[i],task.target||(stage.scissorRect=null,vertexBuffer=this._rttManager.renderToScreenVertexBuffer,context.setVertexBufferAt(0,vertexBuffer,0,away.stagegl.ContextGLVertexBufferFormat.FLOAT_2),context.setVertexBufferAt(1,vertexBuffer,2,away.stagegl.ContextGLVertexBufferFormat.FLOAT_2)),context.setTextureAt(0,task.getMainInputTexture(stage)),context.setProgram(task.getProgram(stage)),context.clear(0,0,0,0),task.activate(stage,camera,depthTexture),context.setBlendFactors(away.stagegl.ContextGLBlendFactor.ONE,away.stagegl.ContextGLBlendFactor.ZERO),context.drawTriangles(indexBuffer,0,2),task.deactivate(stage);context.setTextureAt(0,null),context.setVertexBufferAt(0,null),context.setVertexBufferAt(1,null)}},Filter3DRenderer.prototype.updateFilterSizes=function(){for(var i=0;i<this._filters.length;++i)this._filters[i].textureWidth=this._rttManager.textureWidth,this._filters[i].textureHeight=this._rttManager.textureHeight;this._filterSizesInvalid=!0},Filter3DRenderer.prototype.dispose=function(){this._rttManager.removeEventListener(away.events.Event.RESIZE,this._onRTTResizeDelegate),this._rttManager=null,this._stage=null},Filter3DRenderer}();render.Filter3DRenderer=Filter3DRenderer}(away.render||(away.render={}));away.render}(away||(away={}));var away;!function(away){!function(animators){var ShaderRegisterElement=away.materials.ShaderRegisterElement,AnimationRegisterCache=function(_super){function AnimationRegisterCache(profile){_super.call(this,profile),this.indexDictionary=new Object,this.vertexConstantData=new Array,this.fragmentConstantData=new Array}return __extends(AnimationRegisterCache,_super),AnimationRegisterCache.prototype.reset=function(){_super.prototype.reset.call(this),this.rotationRegisters=new Array,this.positionAttribute=this.getRegisterFromString(this.sourceRegisters[0]),this.scaleAndRotateTarget=this.getRegisterFromString(this.targetRegisters[0]),this.addVertexTempUsages(this.scaleAndRotateTarget,1);for(var i=1;i<this.targetRegisters.length;i++)this.rotationRegisters.push(this.getRegisterFromString(this.targetRegisters[i])),this.addVertexTempUsages(this.rotationRegisters[i-1],1);if(this.scaleAndRotateTarget=new ShaderRegisterElement(this.scaleAndRotateTarget.regName,this.scaleAndRotateTarget.index),this.vertexZeroConst=this.getFreeVertexConstant(),this.vertexZeroConst=new ShaderRegisterElement(this.vertexZeroConst.regName,this.vertexZeroConst.index,0),this.vertexOneConst=new ShaderRegisterElement(this.vertexZeroConst.regName,this.vertexZeroConst.index,1),this.vertexTwoConst=new ShaderRegisterElement(this.vertexZeroConst.regName,this.vertexZeroConst.index,2),this.positionTarget=this.getFreeVertexVectorTemp(),this.addVertexTempUsages(this.positionTarget,1),this.positionTarget=new ShaderRegisterElement(this.positionTarget.regName,this.positionTarget.index),this.needVelocity)this.velocityTarget=this.getFreeVertexVectorTemp(),this.addVertexTempUsages(this.velocityTarget,1),this.velocityTarget=new ShaderRegisterElement(this.velocityTarget.regName,this.velocityTarget.index),this.vertexTime=new ShaderRegisterElement(this.velocityTarget.regName,this.velocityTarget.index,3),this.vertexLife=new ShaderRegisterElement(this.positionTarget.regName,this.positionTarget.index,3);else{var tempTime=this.getFreeVertexVectorTemp();this.addVertexTempUsages(tempTime,1),this.vertexTime=new ShaderRegisterElement(tempTime.regName,tempTime.index,0),this.vertexLife=new ShaderRegisterElement(tempTime.regName,tempTime.index,1)}},AnimationRegisterCache.prototype.setUVSourceAndTarget=function(UVAttribute,UVVaring){this.uvVar=this.getRegisterFromString(UVVaring),this.uvAttribute=this.getRegisterFromString(UVAttribute),this.uvTarget=new ShaderRegisterElement(this.positionTarget.regName,this.positionTarget.index)},AnimationRegisterCache.prototype.setRegisterIndex=function(node,parameterIndex,registerIndex){var t=this.indexDictionary[node.id];null==t&&(t=this.indexDictionary[node.id]=new Array(8)),t[parameterIndex]=registerIndex},AnimationRegisterCache.prototype.getRegisterIndex=function(node,parameterIndex){return this.indexDictionary[node.id][parameterIndex]},AnimationRegisterCache.prototype.getInitCode=function(){for(var len=this.sourceRegisters.length,code="",i=0;len>i;i++)code+="mov "+this.targetRegisters[i]+","+this.sourceRegisters[i]+"\n";return code+="mov "+this.positionTarget+".xyz,"+this.vertexZeroConst.toString()+"\n",this.needVelocity&&(code+="mov "+this.velocityTarget+".xyz,"+this.vertexZeroConst.toString()+"\n"),code},AnimationRegisterCache.prototype.getCombinationCode=function(){return"add "+this.scaleAndRotateTarget+".xyz,"+this.scaleAndRotateTarget+".xyz,"+this.positionTarget+".xyz\n"},AnimationRegisterCache.prototype.initColorRegisters=function(){var code="";return this.hasColorMulNode&&(this.colorMulTarget=this.getFreeVertexVectorTemp(),this.addVertexTempUsages(this.colorMulTarget,1),this.colorMulVary=this.getFreeVarying(),code+="mov "+this.colorMulTarget+","+this.vertexOneConst+"\n"),this.hasColorAddNode&&(this.colorAddTarget=this.getFreeVertexVectorTemp(),this.addVertexTempUsages(this.colorAddTarget,1),this.colorAddVary=this.getFreeVarying(),code+="mov "+this.colorAddTarget+","+this.vertexZeroConst+"\n"),code},AnimationRegisterCache.prototype.getColorPassCode=function(){var code="";return this.needFragmentAnimation&&(this.hasColorAddNode||this.hasColorMulNode)&&(this.hasColorMulNode&&(code+="mov "+this.colorMulVary+","+this.colorMulTarget+"\n"),this.hasColorAddNode&&(code+="mov "+this.colorAddVary+","+this.colorAddTarget+"\n")),code},AnimationRegisterCache.prototype.getColorCombinationCode=function(shadedTarget){var code="";if(this.needFragmentAnimation&&(this.hasColorAddNode||this.hasColorMulNode)){var colorTarget=this.getRegisterFromString(shadedTarget);this.addFragmentTempUsages(colorTarget,1),this.hasColorMulNode&&(code+="mul "+colorTarget+","+colorTarget+","+this.colorMulVary+"\n"),this.hasColorAddNode&&(code+="add "+colorTarget+","+colorTarget+","+this.colorAddVary+"\n")}return code},AnimationRegisterCache.prototype.getRegisterFromString=function(code){var temp=code.split(/(\d+)/);return new ShaderRegisterElement(temp[0],parseInt(temp[1]))},Object.defineProperty(AnimationRegisterCache.prototype,"numVertexConstant",{get:function(){return this._numVertexConstant},enumerable:!0,configurable:!0}),Object.defineProperty(AnimationRegisterCache.prototype,"numFragmentConstant",{get:function(){return this._numFragmentConstant},enumerable:!0,configurable:!0}),AnimationRegisterCache.prototype.setDataLength=function(){this._numVertexConstant=this.numUsedVertexConstants-this.vertexConstantOffset,this._numFragmentConstant=this.numUsedFragmentConstants-this.fragmentConstantOffset,this.vertexConstantData.length=4*this._numVertexConstant,this.fragmentConstantData.length=4*this._numFragmentConstant},AnimationRegisterCache.prototype.setVertexConst=function(index,x,y,z,w){"undefined"==typeof x&&(x=0),"undefined"==typeof y&&(y=0),"undefined"==typeof z&&(z=0),"undefined"==typeof w&&(w=0);var _index=4*(index-this.vertexConstantOffset);this.vertexConstantData[_index++]=x,this.vertexConstantData[_index++]=y,this.vertexConstantData[_index++]=z,this.vertexConstantData[_index]=w},AnimationRegisterCache.prototype.setVertexConstFromArray=function(index,data){for(var _index=4*(index-this.vertexConstantOffset),i=0;i<data.length;i++)this.vertexConstantData[_index++]=data[i]},AnimationRegisterCache.prototype.setVertexConstFromMatrix=function(index,matrix){var rawData=matrix.rawData,_index=4*(index-this.vertexConstantOffset);this.vertexConstantData[_index++]=rawData[0],this.vertexConstantData[_index++]=rawData[4],this.vertexConstantData[_index++]=rawData[8],this.vertexConstantData[_index++]=rawData[12],this.vertexConstantData[_index++]=rawData[1],this.vertexConstantData[_index++]=rawData[5],this.vertexConstantData[_index++]=rawData[9],this.vertexConstantData[_index++]=rawData[13],this.vertexConstantData[_index++]=rawData[2],this.vertexConstantData[_index++]=rawData[6],this.vertexConstantData[_index++]=rawData[10],this.vertexConstantData[_index++]=rawData[14],this.vertexConstantData[_index++]=rawData[3],this.vertexConstantData[_index++]=rawData[7],this.vertexConstantData[_index++]=rawData[11],this.vertexConstantData[_index]=rawData[15]},AnimationRegisterCache.prototype.setFragmentConst=function(index,x,y,z,w){"undefined"==typeof x&&(x=0),"undefined"==typeof y&&(y=0),"undefined"==typeof z&&(z=0),"undefined"==typeof w&&(w=0);var _index=4*(index-this.fragmentConstantOffset);this.fragmentConstantData[_index++]=x,this.fragmentConstantData[_index++]=y,this.fragmentConstantData[_index++]=z,this.fragmentConstantData[_index]=w},AnimationRegisterCache}(away.materials.ShaderRegisterCache);animators.AnimationRegisterCache=AnimationRegisterCache}(away.animators||(away.animators={}));away.animators}(away||(away={}));var away;!function(away){!function(){}(away.animators||(away.animators={}));away.animators}(away||(away={}));var away;!function(away){!function(animators){var AbstractMethodError=away.errors.AbstractMethodError,AnimationSetBase=function(_super){function AnimationSetBase(){_super.call(this),this._animations=new Array,this._animationNames=new Array,this._animationDictionary=new Object}return __extends(AnimationSetBase,_super),AnimationSetBase.prototype._pFindTempReg=function(exclude,excludeAnother){"undefined"==typeof excludeAnother&&(excludeAnother=null);for(var reg,i=0;;){if(reg="vt"+i,-1==exclude.indexOf(reg)&&excludeAnother!=reg)return reg;++i}return null},Object.defineProperty(AnimationSetBase.prototype,"usesCPU",{get:function(){return this._usesCPU},enumerable:!0,configurable:!0}),AnimationSetBase.prototype.resetGPUCompatibility=function(){this._usesCPU=!1},AnimationSetBase.prototype.cancelGPUCompatibility=function(){this._usesCPU=!0},AnimationSetBase.prototype.getAGALVertexCode=function(){throw new AbstractMethodError},AnimationSetBase.prototype.activate=function(){throw new AbstractMethodError},AnimationSetBase.prototype.deactivate=function(){throw new AbstractMethodError},AnimationSetBase.prototype.getAGALFragmentCode=function(){throw new AbstractMethodError},AnimationSetBase.prototype.getAGALUVCode=function(){throw new AbstractMethodError},AnimationSetBase.prototype.doneAGALCode=function(){throw new AbstractMethodError},Object.defineProperty(AnimationSetBase.prototype,"assetType",{get:function(){return away.library.AssetType.ANIMATION_SET},enumerable:!0,configurable:!0}),Object.defineProperty(AnimationSetBase.prototype,"animations",{get:function(){return this._animations},enumerable:!0,configurable:!0}),Object.defineProperty(AnimationSetBase.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),AnimationSetBase.prototype.hasAnimation=function(name){return null!=this._animationDictionary[name]},AnimationSetBase.prototype.getAnimation=function(name){return this._animationDictionary[name]},AnimationSetBase.prototype.addAnimation=function(node){if(this._animationDictionary[node.name])throw new away.errors.AnimationSetError("root node name '"+node.name+"' already exists in the set");this._animationDictionary[node.name]=node,this._animations.push(node),this._animationNames.push(node.name)},AnimationSetBase.prototype.dispose=function(){},AnimationSetBase}(away.library.NamedAssetBase);animators.AnimationSetBase=AnimationSetBase}(away.animators||(away.animators={}));away.animators}(away||(away={}));var away;!function(away){!function(animators){var AbstractMethodError=away.errors.AbstractMethodError,AnimatorEvent=away.events.AnimatorEvent,AssetType=away.library.AssetType,AnimatorBase=function(_super){function AnimatorBase(animationSet){_super.call(this),this._autoUpdate=!0,this._time=0,this._playbackSpeed=1,this._pOwners=new Array,this._pAbsoluteTime=0,this._animationStates=new Object,this.updatePosition=!0,this._pAnimationSet=animationSet,this._broadcaster=new away.utils.RequestAnimationFrame(this.onEnterFrame,this)}return __extends(AnimatorBase,_super),AnimatorBase.prototype.getAnimationState=function(node){var className=node.stateClass,uID=node.id;return null==this._animationStates[uID]&&(this._animationStates[uID]=new className(this,node)),this._animationStates[uID]},AnimatorBase.prototype.getAnimationStateByName=function(name){return this.getAnimationState(this._pAnimationSet.getAnimation(name))},Object.defineProperty(AnimatorBase.prototype,"absoluteTime",{get:function(){return this._pAbsoluteTime},enumerable:!0,configurable:!0}),Object.defineProperty(AnimatorBase.prototype,"animationSet",{get:function(){return this._pAnimationSet},enumerable:!0,configurable:!0}),Object.defineProperty(AnimatorBase.prototype,"activeState",{get:function(){return this._pActiveState},enumerable:!0,configurable:!0}),Object.defineProperty(AnimatorBase.prototype,"activeAnimation",{get:function(){return this._pAnimationSet.getAnimation(this._pActiveAnimationName)},enumerable:!0,configurable:!0}),Object.defineProperty(AnimatorBase.prototype,"activeAnimationName",{get:function(){return this._pActiveAnimationName},enumerable:!0,configurable:!0}),Object.defineProperty(AnimatorBase.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(value){this._autoUpdate!=value&&(this._autoUpdate=value,this._autoUpdate?this.start():this.stop())},enumerable:!0,configurable:!0}),Object.defineProperty(AnimatorBase.prototype,"time",{get:function(){return this._time},set:function(value){this._time!=value&&this.update(value)},enumerable:!0,configurable:!0}),AnimatorBase.prototype.phase=function(value){this._pActiveState.phase(value)
},Object.defineProperty(AnimatorBase.prototype,"playbackSpeed",{get:function(){return this._playbackSpeed},set:function(value){this._playbackSpeed=value},enumerable:!0,configurable:!0}),AnimatorBase.prototype.setRenderState=function(){throw new away.errors.AbstractMethodError},AnimatorBase.prototype.start=function(){!this._isPlaying&&this._autoUpdate&&(this._time=this._pAbsoluteTime=away.utils.getTimer(),this._isPlaying=!0,this._broadcaster.start(),this.hasEventListener(AnimatorEvent.START)&&(null==this._startEvent&&(this._startEvent=new AnimatorEvent(AnimatorEvent.START,this)),this.dispatchEvent(this._startEvent)))},AnimatorBase.prototype.stop=function(){this._isPlaying&&(this._isPlaying=!1,this._broadcaster.stop(),this.hasEventListener(AnimatorEvent.STOP)&&(null==this._stopEvent&&(this._stopEvent=new AnimatorEvent(AnimatorEvent.STOP,this)),this.dispatchEvent(this._stopEvent)))},AnimatorBase.prototype.update=function(time){var dt=(time-this._time)*this.playbackSpeed;this._pUpdateDeltaTime(dt),this._time=time},AnimatorBase.prototype.reset=function(name,offset){"undefined"==typeof offset&&(offset=0),this.getAnimationState(this._pAnimationSet.getAnimation(name)).offset(offset+this._pAbsoluteTime)},AnimatorBase.prototype.addOwner=function(mesh){this._pOwners.push(mesh)},AnimatorBase.prototype.removeOwner=function(mesh){this._pOwners.splice(this._pOwners.indexOf(mesh),1)},AnimatorBase.prototype._pUpdateDeltaTime=function(dt){this._pAbsoluteTime+=dt,this._pActiveState.update(this._pAbsoluteTime),this.updatePosition&&this.applyPositionDelta()},AnimatorBase.prototype.onEnterFrame=function(event){"undefined"==typeof event&&(event=null),this.update(away.utils.getTimer())},AnimatorBase.prototype.applyPositionDelta=function(){var len,delta=this._pActiveState.positionDelta,dist=delta.length;if(dist>0){len=this._pOwners.length;for(var i=0;len>i;++i)this._pOwners[i].translateLocal(delta,dist)}},AnimatorBase.prototype.dispatchCycleEvent=function(){this.hasEventListener(AnimatorEvent.CYCLE_COMPLETE)&&(null==this._cycleEvent&&(this._cycleEvent=new AnimatorEvent(AnimatorEvent.CYCLE_COMPLETE,this)),this.dispatchEvent(this._cycleEvent))},AnimatorBase.prototype.clone=function(){throw new AbstractMethodError},AnimatorBase.prototype.dispose=function(){},AnimatorBase.prototype.testGPUCompatibility=function(){throw new AbstractMethodError},Object.defineProperty(AnimatorBase.prototype,"assetType",{get:function(){return AssetType.ANIMATOR},enumerable:!0,configurable:!0}),AnimatorBase.prototype.getRenderableSubGeometry=function(renderable,sourceSubGeometry){return sourceSubGeometry},AnimatorBase}(away.library.NamedAssetBase);animators.AnimatorBase=AnimatorBase}(away.animators||(away.animators={}));away.animators}(away||(away={}));var away;!function(away){!function(filters){var Filter3DTaskBase=function(){function Filter3DTaskBase(requireDepthRender){"undefined"==typeof requireDepthRender&&(requireDepthRender=!1),this._scaledTextureWidth=-1,this._scaledTextureHeight=-1,this._textureWidth=-1,this._textureHeight=-1,this._textureDimensionsInvalid=!0,this._program3DInvalid=!0,this._textureScale=0,this._requireDepthRender=requireDepthRender}return Object.defineProperty(Filter3DTaskBase.prototype,"textureScale",{get:function(){return this._textureScale},set:function(value){this._textureScale!=value&&(this._textureScale=value,this._scaledTextureWidth=this._textureWidth>>this._textureScale,this._scaledTextureHeight=this._textureHeight>>this._textureScale,this._textureDimensionsInvalid=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(Filter3DTaskBase.prototype,"target",{get:function(){return this._target},set:function(value){this._target=value},enumerable:!0,configurable:!0}),Object.defineProperty(Filter3DTaskBase.prototype,"textureWidth",{get:function(){return this._textureWidth},set:function(value){this._textureWidth!=value&&(this._textureWidth=value,this._scaledTextureWidth=this._textureWidth>>this._textureScale,this._textureDimensionsInvalid=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(Filter3DTaskBase.prototype,"textureHeight",{get:function(){return this._textureHeight},set:function(value){this._textureHeight!=value&&(this._textureHeight=value,this._scaledTextureHeight=this._textureHeight>>this._textureScale,this._textureDimensionsInvalid=!0)},enumerable:!0,configurable:!0}),Filter3DTaskBase.prototype.getMainInputTexture=function(stage){return this._textureDimensionsInvalid&&this.pUpdateTextures(stage),this._mainInputTexture},Filter3DTaskBase.prototype.dispose=function(){this._mainInputTexture&&this._mainInputTexture.dispose(),this._program3D&&this._program3D.dispose()},Filter3DTaskBase.prototype.pInvalidateProgram=function(){this._program3DInvalid=!0},Filter3DTaskBase.prototype.pUpdateProgram=function(stage){this._program3D&&this._program3D.dispose(),this._program3D=stage.context.createProgram();var vertexByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part vertex 1\n"+this.pGetVertexCode()+"endpart").vertex.data,fragmentByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part fragment 1\n"+this.pGetFragmentCode()+"endpart").fragment.data;this._program3D.upload(vertexByteCode,fragmentByteCode),this._program3DInvalid=!1},Filter3DTaskBase.prototype.pGetVertexCode=function(){return"mov op, va0\nmov v0, va1\n"},Filter3DTaskBase.prototype.pGetFragmentCode=function(){throw new away.errors.AbstractMethodError},Filter3DTaskBase.prototype.pUpdateTextures=function(stage){this._mainInputTexture&&this._mainInputTexture.dispose(),this._mainInputTexture=stage.context.createTexture(this._scaledTextureWidth,this._scaledTextureHeight,away.stagegl.ContextGLTextureFormat.BGRA,!0),this._textureDimensionsInvalid=!1},Filter3DTaskBase.prototype.getProgram=function(stage){return this._program3DInvalid&&this.pUpdateProgram(stage),this._program3D},Filter3DTaskBase.prototype.activate=function(){},Filter3DTaskBase.prototype.deactivate=function(){},Object.defineProperty(Filter3DTaskBase.prototype,"requireDepthRender",{get:function(){return this._requireDepthRender},enumerable:!0,configurable:!0}),Filter3DTaskBase}();filters.Filter3DTaskBase=Filter3DTaskBase}(away.filters||(away.filters={}));away.filters}(away||(away={}));var away;!function(away){!function(filters){var Filter3DBase=function(){function Filter3DBase(){this._tasks=new Array}return Object.defineProperty(Filter3DBase.prototype,"requireDepthRender",{get:function(){return this._requireDepthRender},enumerable:!0,configurable:!0}),Filter3DBase.prototype.pAddTask=function(filter){this._tasks.push(filter),null==this._requireDepthRender&&(this._requireDepthRender=filter.requireDepthRender)},Object.defineProperty(Filter3DBase.prototype,"tasks",{get:function(){return this._tasks},enumerable:!0,configurable:!0}),Filter3DBase.prototype.getMainInputTexture=function(stage){return this._tasks[0].getMainInputTexture(stage)},Object.defineProperty(Filter3DBase.prototype,"textureWidth",{get:function(){return this._textureWidth},set:function(value){this._textureWidth=value;for(var i=0;i<this._tasks.length;++i)this._tasks[i].textureWidth=value},enumerable:!0,configurable:!0}),Object.defineProperty(Filter3DBase.prototype,"textureHeight",{get:function(){return this._textureHeight},set:function(value){this._textureHeight=value;for(var i=0;i<this._tasks.length;++i)this._tasks[i].textureHeight=value},enumerable:!0,configurable:!0}),Filter3DBase.prototype.setRenderTargets=function(mainTarget){this._tasks[this._tasks.length-1].target=mainTarget},Filter3DBase.prototype.dispose=function(){for(var i=0;i<this._tasks.length;++i)this._tasks[i].dispose()},Filter3DBase.prototype.update=function(){},Filter3DBase}();filters.Filter3DBase=Filter3DBase}(away.filters||(away.filters={}));away.filters}(away||(away={})),away.Debug.THROW_ERRORS=!1,away.Debug.LOG_PI_ERRORS=!1;var away;!function(away){var StageGLCore=function(_super){function StageGLCore(){_super.call(this)}return __extends(StageGLCore,_super),StageGLCore}(away.events.EventDispatcher);away.StageGLCore=StageGLCore}(away||(away={}));